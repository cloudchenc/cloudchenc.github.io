<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Less is more.">
<meta property="og:type" content="website">
<meta property="og:title" content="cloud&#39;s blog">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="cloud&#39;s blog">
<meta property="og:description" content="Less is more.">
<meta property="article:author" content="cloud">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>cloud's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">cloud's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/03/Binder%E7%B3%BB%E5%88%975-%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1-addService/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="cloud">
      <meta itemprop="description" content="Less is more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cloud's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/03/Binder%E7%B3%BB%E5%88%975-%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1-addService/" class="post-title-link" itemprop="url">Binder 系列 5- 注册服务 (addService)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-01-03 13:28:36" itemprop="dateCreated datePublished" datetime="2021-01-03T13:28:36+08:00">2021-01-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-17 10:41:53" itemprop="dateModified" datetime="2021-03-17T10:41:53+08:00">2021-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>35k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>32 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>Source Code Environment  </p>
<p>Android Version Pie 9.0.0_r3<br>Kernel Version 3.18  </p>
<p>本文参考 Gityuan 大神的博客，结合高版本源码，讲解如何向 ServiceManager 注册 Native 层的服务的过程</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Reference Source Code</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; framework</span><br><span class="line">&#x2F;frameworks&#x2F;native&#x2F;libs&#x2F;binder&#x2F;ProcessState.cpp</span><br><span class="line">&#x2F;external&#x2F;fio&#x2F;os&#x2F;windows&#x2F;posix&#x2F;include&#x2F;sys&#x2F;mman.h</span><br><span class="line">&#x2F;frameworks&#x2F;av&#x2F;media&#x2F;libmediaplayerservice&#x2F;MediaPlayerService.cpp</span><br><span class="line">&#x2F;frameworks&#x2F;native&#x2F;libs&#x2F;binder&#x2F;IServiceManager.cpp</span><br><span class="line">&#x2F;frameworks&#x2F;native&#x2F;libs&#x2F;binder&#x2F;Parcel.cpp</span><br><span class="line">&#x2F;frameworks&#x2F;native&#x2F;libs&#x2F;binder&#x2F;Binder.cpp</span><br><span class="line">&#x2F;frameworks&#x2F;native&#x2F;libs&#x2F;binder&#x2F;IPCThreadState.cpp</span><br><span class="line">&#x2F;frameworks&#x2F;native&#x2F;libs&#x2F;binder&#x2F;BpBinder.cpp</span><br><span class="line">&#x2F;frameworks&#x2F;native&#x2F;cmds&#x2F;servicemanager&#x2F;binder.c</span><br><span class="line">&#x2F;frameworks&#x2F;native&#x2F;cmds&#x2F;servicemanager&#x2F;service_manager.c</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; kernel</span><br><span class="line">&#x2F;drivers&#x2F;staging&#x2F;android&#x2F;binder.c</span><br></pre></td></tr></table></figure>

<h2 id="1- 概述"><a href="#1- 概述" class="headerlink" title="# 1. 概述"></a># 1. 概述 </h2><h3 id="1-1-media 服务注册"><a href="#1-1-media 服务注册" class="headerlink" title="# 1.1 media 服务注册"></a># 1.1 media 服务注册</h3><p>media 入口函数是 <code>/frameworks/av/media/mediaserver/main_mediaserver.cpp</code> 中的 main()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc __unused, char **argv __unused)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; 获取 ProcessState 实例对象【见小节 2.1】</span><br><span class="line">    sp&lt;ProcessState&gt; proc(ProcessState::self());</span><br><span class="line">    &#x2F;&#x2F; 获取 BpServiceManager 对象</span><br><span class="line">    sp&lt;IServiceManager&gt; sm(defaultServiceManager());</span><br><span class="line">    InitializeIcuOrDie();</span><br><span class="line">    &#x2F;&#x2F; 注册多媒体服务【见小节 3.1】</span><br><span class="line">    MediaPlayerService::instantiate();</span><br><span class="line">    ResourceManagerService::instantiate();</span><br><span class="line">    registerExtensions();</span><br><span class="line">    &#x2F;&#x2F; 启动 Binder 线程池</span><br><span class="line">    ProcessState::self()-&gt;startThreadPool();</span><br><span class="line">    &#x2F;&#x2F; 把当前线程加入到线程池</span><br><span class="line">    IPCThreadState::self()-&gt;joinThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用流程：</p>
<pre><code>1. 获取 ServiceManager：讲解了 defaultServiceManager()返回的是 BpServiceManager 对象，用于跟 ServiceManager 进程通信；

2. 理解 Binder 线程池的管理：讲解了 startThreadPool()和 joinThreadPool()过程 </code></pre><p> 本文是为了讲解 Native 层注册服务的过程</p>
<h3 id="1-2- 类图"><a href="#1-2- 类图" class="headerlink" title="# 1.2 类图"></a># 1.2 类图 </h3><p> 下面以 media 服务为例，分析注册服务的过程（来自 Gityuan 大佬）</p>
<p><img src="https://tva1.sinaimg.cn/large/d7f9b0f4gy1gld47tdeegj20s60k2gog.jpg" alt="add_media_player_service"></p>
<ul>
<li>蓝色代表的是注册 MediaPlayerService 服务所涉及的类</li>
<li>绿色代表的是 Binder 架构中与 Binder 驱动通信过程中的核心类</li>
<li>紫色代表的是注册服务和获取服务的公共接口 / 父类</li>
</ul>
<h3 id="1-3- 时序图"><a href="#1-3- 时序图" class="headerlink" title="# 1.3 时序图"></a># 1.3 时序图 </h3><p> 根据时序图，来看看 media 服务启动过程是如何向 ServiceManager 注册服务的（来自 Gityuan 大佬）</p>
<p><img src="https://tva4.sinaimg.cn/large/d7f9b0f4gy1gld4cpzg6fj20sa0q5414.jpg" alt="addService"></p>
<h2 id="2-ProcessState"><a href="#2-ProcessState" class="headerlink" title="# 2. ProcessState"></a># 2. ProcessState</h2><h3 id="2-1-ProcessState-self"><a href="#2-1-ProcessState-self" class="headerlink" title="# 2.1 ProcessState::self"></a># 2.1 ProcessState::self</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/ProcessState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/ProcessState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;ProcessState&gt; ProcessState::self()</span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(gProcessMutex);</span><br><span class="line">    if (gProcess !&#x3D; NULL) &#123;</span><br><span class="line">        return gProcess;</span><br><span class="line">    &#125;</span><br><span class="line">    gProcess &#x3D; new ProcessState(&quot;&#x2F;dev&#x2F;binder&quot;);</span><br><span class="line">    return gProcess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获得 ProcessState 对象：单例模式，保证了每个进程只有一个 ProcessState 对象。其中 gProcess 和 gProcessMutex 是保存在 Static.cpp 类的全局变量</p>
<h3 id="2-2-ProcessState 初始化"><a href="#2-2-ProcessState 初始化" class="headerlink" title="# 2.2 ProcessState 初始化"></a># 2.2 ProcessState 初始化</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/ProcessState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/ProcessState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ProcessState::ProcessState(const char *driver)</span><br><span class="line">    : mDriverName(String8(driver))</span><br><span class="line">    , mDriverFD(open_driver(driver)) &#x2F;&#x2F; 打开 Binder 驱动【见小节 2.3】</span><br><span class="line">    , mVMStart(MAP_FAILED)</span><br><span class="line">    , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER)</span><br><span class="line">    , mThreadCountDecrement(PTHREAD_COND_INITIALIZER)</span><br><span class="line">    , mExecutingThreadsCount(0)</span><br><span class="line">    , mMaxThreads(DEFAULT_MAX_BINDER_THREADS)</span><br><span class="line">    , mStarvationStartTimeMs(0)</span><br><span class="line">    , mManagesContexts(false)</span><br><span class="line">    , mBinderContextCheckFunc(NULL)</span><br><span class="line">    , mBinderContextUserData(NULL)</span><br><span class="line">    , mThreadPoolStarted(false)</span><br><span class="line">    , mThreadPoolSeq(1)</span><br><span class="line">&#123;</span><br><span class="line">    if (mDriverFD &gt;&#x3D; 0) &#123;</span><br><span class="line">        &#x2F;&#x2F; 采用内存映射函数 mmap，给 binder 分配一块虚拟地址空间【见小节 2.4】</span><br><span class="line">        mVMStart &#x3D; mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0);</span><br><span class="line">        if (mVMStart &#x3D;&#x3D; MAP_FAILED) &#123;</span><br><span class="line">            close(mDriverFD); &#x2F;&#x2F; 没有足够空间分配给 &#x2F;dev&#x2F;binder，则关闭驱动</span><br><span class="line">            mDriverFD &#x3D; -1;</span><br><span class="line">            mDriverName.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ProcessState 的单例模式的唯一性，因此一个进程只打开 binder 设备一次，其中 ProcessState 的成员变量 mDriverFD 记录 binder 驱动的 fd，用于访问 binder 设备</li>
<li>BINDER_VM_SIZE = ((1 *  *) - sysconf(_SC_PAGE_SIZE) * 2)，binder 分配的默认内存大小为 1M-8K</li>
<li>DEFAULT_MAX_BINDER_THREADS = 15，binder 默认的最大可并发访问的线程数为 15</li>
</ul>
<h3 id="2-3-open-driver"><a href="#2-3-open-driver" class="headerlink" title="# 2.3 open_driver"></a># 2.3 open_driver</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/ProcessState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/ProcessState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">static int open_driver(const char *driver)</span><br><span class="line">&#123;</span><br><span class="line">    int fd &#x3D; open(driver, O_RDWR | O_CLOEXEC);</span><br><span class="line">    if (fd &gt;&#x3D; 0) &#123;</span><br><span class="line">        int vers &#x3D; 0;</span><br><span class="line">        status_t result &#x3D; ioctl(fd, BINDER_VERSION, &amp;vers);</span><br><span class="line">        if (result &#x3D;&#x3D; -1) &#123;</span><br><span class="line">            close(fd);</span><br><span class="line">            fd &#x3D; -1;</span><br><span class="line">        &#125;</span><br><span class="line">        if (result !&#x3D; 0 || vers !&#x3D; BINDER_CURRENT_PROTOCOL_VERSION) &#123;</span><br><span class="line">            close(fd);</span><br><span class="line">            fd &#x3D; -1;</span><br><span class="line">        &#125;</span><br><span class="line">        size_t maxThreads &#x3D; DEFAULT_MAX_BINDER_THREADS;</span><br><span class="line">        result &#x3D; ioctl(fd, BINDER_SET_MAX_THREADS, &amp;maxThreads);</span><br><span class="line">        if (result &#x3D;&#x3D; -1) &#123;</span><br><span class="line">            ALOGE(&quot;Binder ioctl to set max threads failed: %s&quot;, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ALOGW(&quot;Opening &#39;%s&#39; failed: %s\n&quot;, driver, strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    return fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>open_driver 作用是打开 /dev/binder 设备，设定 binder 支持的最大线程数。关于 binder 驱动的相应方法，见文章 Binder Driver 初探</p>
<p>ProcessState 采用单例模式，保证每一个进程都只打开一次 Binder Driver</p>
<h3 id="2-4-mmap"><a href="#2-4-mmap" class="headerlink" title="# 2.4 mmap"></a># 2.4 mmap</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/external/fio/os/windows/posix/include/sys/mman.h" target="_blank" rel="noopener">/external/fio/os/windows/posix/include/sys/mman.h</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void *mmap(void *addr, size_t len, int prot, int flags,</span><br><span class="line">		int fildes, off_t off);</span><br><span class="line"></span><br><span class="line">int munmap(void *addr, size_t len);</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>addr: 代表映射到进程地址空间的起始地址，当值等于 0 则由内核选择合适地址，此时为 0</li>
<li>size: 代表需要映射的内存地址空间的大小，此处为 1M-8K</li>
<li>prot: 代表内存映射区的读写等属性值，此处为 PROT_READ(可读取)</li>
<li>flags: 标志位，此处为 MAP_PRIVATE(私有映射，多进程间不共享内容的改变)和 MAP_NORESERVE(不保留交换空间)</li>
<li>fd: 代表 mmap 所关联的文件描述符，此处为 mDriverFD</li>
<li>offset: 偏移量，此处为 0</li>
</ul>
<p>mmap()经过系统调用，执行 binder_mmap 过程</p>
<h2 id="3- 服务注册"><a href="#3- 服务注册" class="headerlink" title="# 3. 服务注册"></a># 3. 服务注册</h2><h3 id="3-1-instantiate"><a href="#3-1-instantiate" class="headerlink" title="# 3.1 instantiate"></a># 3.1 instantiate</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/av/media/libmediaplayerservice/MediaPlayerService.cpp" target="_blank" rel="noopener">/frameworks/av/media/libmediaplayerservice/MediaPlayerService.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void MediaPlayerService::instantiate() &#123;</span><br><span class="line">    &#x2F;&#x2F; 注册服务【见小节 3.2】</span><br><span class="line">    defaultServiceManager()-&gt;addService(</span><br><span class="line">            Stringmedia.player&quot;), new MediaPlayerService());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册服务 MediaPlayerService：由 defaultServiceManager()返回的是 BpServiceManager，同时会创建 ProcessState 对象和 BpBinder 对象。<br>故此处等价于调用 BpServiceManager-&gt;addService。其中 MediaPlayerService 位于 libmediaplayerservice 库</p>
<h3 id="3-2-BpServiceManager-addService"><a href="#3-2-BpServiceManager-addService" class="headerlink" title="# 3.2 BpServiceManager.addService"></a># 3.2 BpServiceManager.addService</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IServiceManager.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/IServiceManager.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">virtual status_t addService(const Stringname, const sp&lt;IBinder&gt;&amp; service,</span><br><span class="line">                            bool allowIsolated, int dumpsysPriority) &#123;</span><br><span class="line">    Parcel data, reply; &#x2F;&#x2F; Parcel 是数据通信包 </span><br><span class="line">    &#x2F;&#x2F; 写入头信息 &quot;android.os.IServiceManager&quot;</span><br><span class="line">    data.writeInterfaceToken(IServiceManager::getInterfaceDescriptor());</span><br><span class="line">    data.writeStringame); &#x2F;&#x2F; name 为 &quot;media.player&quot;</span><br><span class="line">    data.writeStrongBinder(service); &#x2F;&#x2F; MediaPlayerService 对象【见小节 3.2.1】</span><br><span class="line">    data.writeInt32(allowIsolated ? 1 : 0); &#x2F;&#x2F; allowIsolated &#x3D; false</span><br><span class="line">    data.writeInt32(dumpsysPriority); </span><br><span class="line">    &#x2F;&#x2F; remote() 指向的是 BpBinder 对象【见小节 3.3】</span><br><span class="line">    status_t err &#x3D; remote()-&gt;transact(ADD_SERVICE_TRANSACTION, data, &amp;reply);</span><br><span class="line">    return err &#x3D;&#x3D; NO_ERROR ? reply.readExceptionCode() : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务注册过程：向 ServiceManager 注册服务 MediaPlayerService，服务名为”media.player”</p>
<h4 id="3-2-1-writeStrongBinder"><a href="#3-2-1-writeStrongBinder" class="headerlink" title="# 3.2.1 writeStrongBinder"></a># 3.2.1 writeStrongBinder</h4><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/Parcel.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/Parcel.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">status_t Parcel::writeStrongBinder(const sp&lt;IBinder&gt;&amp; val)</span><br><span class="line">&#123;</span><br><span class="line">    return flatten_binder(ProcessState::self(), val, this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-flatten-binder"><a href="#3-2-2-flatten-binder" class="headerlink" title="# 3.2.2 flatten_binder"></a># 3.2.2 flatten_binder</h4><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/Parcel.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/Parcel.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">status_t flatten_binder(const sp&lt;ProcessState&gt;&amp; &#x2F;*proc*&#x2F;,</span><br><span class="line">    const sp&lt;IBinder&gt;&amp; binder, Parcel* out)</span><br><span class="line">&#123;</span><br><span class="line">    flat_binder_object obj;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否允许后台运行，设置节点优先级</span><br><span class="line">    if (IPCThreadState::self()-&gt;backgroundSchedulingDisabled()) &#123;</span><br><span class="line">        &#x2F;* minimum priority for all nodes is nice 0 *&#x2F;</span><br><span class="line">        obj.flags &#x3D; FLAT_BINDER_FLAG_ACCEPTS_FDS;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;* minimum priority for all nodes is MAX_NICE(19) *&#x2F;</span><br><span class="line">        obj.flags &#x3D; 0x13 | FLAT_BINDER_FLAG_ACCEPTS_FDS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (binder !&#x3D; NULL) &#123;</span><br><span class="line">        IBinder *local &#x3D; binder-&gt;localBinder(); &#x2F;&#x2F; 本地 Binder 不为空</span><br><span class="line">        if (!local) &#123;</span><br><span class="line">            BpBinder *proxy &#x3D; binder-&gt;remoteBinder();</span><br><span class="line">            const int32_t handle &#x3D; proxy ? proxy-&gt;handle() : 0;</span><br><span class="line">            obj.hdr.type &#x3D; BINDER_TYPE_HANDLE;</span><br><span class="line">            obj.binder &#x3D; 0; &#x2F;* Don&#39;t pass uninitialized stack data to a remote process *&#x2F;</span><br><span class="line">            obj.handle &#x3D; handle;</span><br><span class="line">            obj.cookie &#x3D; 0;</span><br><span class="line">        &#125; else &#123; &#x2F;&#x2F; 进入该分支</span><br><span class="line">            obj.hdr.type &#x3D; BINDER_TYPE_BINDER;</span><br><span class="line">            obj.binder &#x3D; reinterpret_cast&lt;uintptr_t&gt;(local-&gt;getWeakRefs());</span><br><span class="line">            obj.cookie &#x3D; reinterpret_cast&lt;uintptr_t&gt;(local);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        obj.hdr.type &#x3D; BINDER_TYPE_BINDER;</span><br><span class="line">        obj.binder &#x3D; 0;</span><br><span class="line">        obj.cookie &#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 【见小节 3.2.4】</span><br><span class="line">    return finish_flatten_binder(binder, obj, out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 Binder 对象扁平化，转换成 flat_binder_object 对象</p>
<ul>
<li>对于 Binder 实体，则 cookie 记录 Binder 实体的指针</li>
<li>对于 Binder 代理，则用 handle 记录 Binder 代理的句柄</li>
</ul>
<p>关于 localBinder，代码见<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/Binder.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/Binder.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BBinder* IBinder::localBinder()</span><br><span class="line">&#123;</span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BBinder* BBinder::localBinder()</span><br><span class="line">&#123;</span><br><span class="line">    return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-3-backgroundSchedulingDisabled"><a href="#3-2-3-backgroundSchedulingDisabled" class="headerlink" title="# 3.2.3 backgroundSchedulingDisabled"></a># 3.2.3 backgroundSchedulingDisabled</h4><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IPCThreadState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/IPCThreadState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 是否禁用后台运行，默认是 false</span><br><span class="line">static bool gDisableBackgroundScheduling &#x3D; false;</span><br><span class="line">bool IPCThreadState::backgroundSchedulingDisabled()</span><br><span class="line">&#123;</span><br><span class="line">    return gDisableBackgroundScheduling;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-4-finish-flatten-binder"><a href="#3-2-4-finish-flatten-binder" class="headerlink" title="# 3.2.4 finish_flatten_binder"></a># 3.2.4 finish_flatten_binder</h4><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/Parcel.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/Parcel.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">inline static status_t finish_flatten_binder(</span><br><span class="line">    const sp&lt;IBinder&gt;&amp; &#x2F;*binder*&#x2F;, const flat_binder_object&amp; flat, Parcel* out)</span><br><span class="line">&#123;</span><br><span class="line">    return out-&gt;writeObject(flat, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 flat_binder_object 写入 out</p>
<h3 id="3-3-BpBinder-transact"><a href="#3-3-BpBinder-transact" class="headerlink" title="# 3.3 BpBinder::transact"></a># 3.3 BpBinder::transact</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/BpBinder.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/BpBinder.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">status_t BpBinder::transact(</span><br><span class="line">    uint32_t code, const Parcel&amp; data, Parcel* reply, uint32_t flags)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; Once a binder has died, it will never come back to life.</span><br><span class="line">    if (mAlive) &#123;</span><br><span class="line">        &#x2F;&#x2F; code &#x3D; ADD_SERVICE_TRANSACTION【见小节 3.4】</span><br><span class="line">        status_t status &#x3D; IPCThreadState::self()-&gt;transact(</span><br><span class="line">            mHandle, code, data, reply, flags);</span><br><span class="line">        if (status &#x3D;&#x3D; DEAD_OBJECT) mAlive &#x3D; 0;</span><br><span class="line">        return status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return DEAD_OBJECT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Binder 代理类调用 transact()方法，真正工作还是交给 IPCThreadState 来进行 transact 工作。那么来看看 IPCThreadState 初始化的过程</p>
<h4 id="3-3-1-IPCThreadState-self"><a href="#3-3-1-IPCThreadState-self" class="headerlink" title="# 3.3.1 IPCThreadState::self"></a># 3.3.1 IPCThreadState::self</h4><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IPCThreadState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/IPCThreadState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">IPCThreadState* IPCThreadState::self()</span><br><span class="line">&#123;</span><br><span class="line">    if (gHaveTLS) &#123;</span><br><span class="line">restart:</span><br><span class="line">        const pthread_key_t k &#x3D; gTLS;</span><br><span class="line">        IPCThreadState* st &#x3D; (IPCThreadState*)pthread_getspecific(k);</span><br><span class="line">        if (st) return st;</span><br><span class="line">        return new IPCThreadState; &#x2F;&#x2F; 初始化 IPCThreadState【见小节 3.3.2】</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (gShutdown) &#123;</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;gTLSMutex);</span><br><span class="line">    if (!gHaveTLS) &#123; &#x2F;&#x2F; 首次进入 gHaveTLS 为 false</span><br><span class="line">        int key_create_value &#x3D; pthread_key_create(&amp;gTLS, threadDestructor); &#x2F;&#x2F; 创建线程的 TLS</span><br><span class="line">        if (key_create_value !&#x3D; 0) &#123;</span><br><span class="line">            pthread_mutex_unlock(&amp;gTLSMutex);</span><br><span class="line">            return NULL;</span><br><span class="line">        &#125;</span><br><span class="line">        gHaveTLS &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;gTLSMutex);</span><br><span class="line">    goto restart;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TLS 是指 Thread Local Storage(线程本地储存空间)，每个线程都有自己的 TLS，并且是私有空间，线程之间不会共享。<br>通过 pthread_getspecific/pthread_setspecific 函数可以获取 / 设置这些空间中的内容。<br>从线程本地存储空间中获得保存在其中的 IPCThreadState 对象。</p>
<h4 id="3-3-2-IPCThreadState 初始化"><a href="#3-3-2-IPCThreadState 初始化" class="headerlink" title="# 3.3.2 IPCThreadState 初始化"></a># 3.3.2 IPCThreadState 初始化</h4><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IPCThreadState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/IPCThreadState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">IPCThreadState::IPCThreadState()</span><br><span class="line">    : mProcess(ProcessState::self()),</span><br><span class="line">      mStrictModePolicy(0),</span><br><span class="line">      mLastTransactionBinderFlags(0)</span><br><span class="line">&#123;</span><br><span class="line">    pthread_setspecific(gTLS, this);</span><br><span class="line">    clearCaller();</span><br><span class="line">    mIn.setDataCapacity(256);</span><br><span class="line">    mOut.setDataCapacity(256);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每个线程都有一个 IPCThreadState，每个 IPCThreadState 中都有一个 mIn、一个 mOut。成员变量 mProcess 保存了 ProcessState 变量（每个进程只有一个）</p>
<ul>
<li>mIn 用来接收来自 Binder 设备的数据，默认大小为 256 字节</li>
<li>mOut 用来存储发往 Binder 设备的数据，默认大小为 256 字节</li>
</ul>
<h3 id="3-4-IPCThreadState-transact"><a href="#3-4-IPCThreadState-transact" class="headerlink" title="# 3.4 IPCThreadState::transact"></a># 3.4 IPCThreadState::transact</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IPCThreadState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/IPCThreadState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">status_t IPCThreadState::transact(int32_t handle,</span><br><span class="line">                                  uint32_t code, const Parcel&amp; data,</span><br><span class="line">                                  Parcel* reply, uint32_t flags)</span><br><span class="line">&#123;</span><br><span class="line">    status_t err;</span><br><span class="line">    flags |&#x3D; TF_ACCEPT_FDS;</span><br><span class="line">    &#x2F;&#x2F; 传输数据</span><br><span class="line">    err &#x3D; writeTransactionData(BC_TRANSACTION, flags, handle, code, data, NULL);</span><br><span class="line"></span><br><span class="line">    if (err !&#x3D; NO_ERROR) &#123;</span><br><span class="line">        if (reply) reply-&gt;setError(err);</span><br><span class="line">        return (mLastError &#x3D; err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((flags &amp; TF_ONE_WAY) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        if (reply) &#123;</span><br><span class="line">            err &#x3D; waitForResponse(reply); &#x2F;&#x2F; 等待响应</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            Parcel fakeReply;</span><br><span class="line">            err &#x3D; waitForResponse(&amp;fakeReply);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        err &#x3D; waitForResponse(NULL, NULL);</span><br><span class="line">    &#125;</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IPCThreadState 进行 transact 事务处理分为两部分：</p>
<ul>
<li>writeTransactionData(): 传输数据</li>
<li>waitForResponse(): 等待响应</li>
</ul>
<h3 id="3-5-IPCThreadState-writeTransactionData"><a href="#3-5-IPCThreadState-writeTransactionData" class="headerlink" title="# 3.5 IPCThreadState.writeTransactionData"></a># 3.5 IPCThreadState.writeTransactionData</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IPCThreadState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/IPCThreadState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">status_t IPCThreadState::writeTransactionData(int32_t cmd, uint32_t binderFlags,</span><br><span class="line">    int32_t handle, uint32_t code, const Parcel&amp; data, status_t* statusBuffer)</span><br><span class="line">&#123;</span><br><span class="line">    binder_transaction_data tr;</span><br><span class="line">    tr.target.ptr &#x3D; 0; &#x2F;* Don&#39;t pass uninitialized stack data to a remote process *&#x2F;</span><br><span class="line">    tr.target.handle &#x3D; handle; &#x2F;&#x2F; handle &#x3D; 0</span><br><span class="line">    tr.code &#x3D; code; &#x2F;&#x2F; code &#x3D; ADD_SERVICE_TRANSACTION</span><br><span class="line">    tr.flags &#x3D; binderFlags; &#x2F;&#x2F; binderFlags &#x3D; 0</span><br><span class="line">    tr.cookie &#x3D; 0;</span><br><span class="line">    tr.sender_pid &#x3D; 0;</span><br><span class="line">    tr.sender_euid &#x3D; 0;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; data 为记录 Media 服务信息的 Parcel 对象，进行数据错误检查</span><br><span class="line">    const status_t err &#x3D; data.errorCheck();</span><br><span class="line">    if (err &#x3D;&#x3D; NO_ERROR) &#123;</span><br><span class="line">        tr.data_size &#x3D; data.ipcDataSize(); &#x2F;&#x2F; mDataSize</span><br><span class="line">        tr.data.ptr.buffer &#x3D; data.ipcData(); &#x2F;&#x2F; mData</span><br><span class="line">        tr.offsets_size &#x3D; data.ipcObjectsCount()*sizeof(binder_size_t); &#x2F;&#x2F; mObjectsSize</span><br><span class="line">        tr.data.ptr.offsets &#x3D; data.ipcObjects(); &#x2F;&#x2F; mObjects</span><br><span class="line">    &#125; else if (statusBuffer) &#123;</span><br><span class="line">        tr.flags |&#x3D; TF_STATUS_CODE;</span><br><span class="line">        *statusBuffer &#x3D; err;</span><br><span class="line">        tr.data_size &#x3D; sizeof(status_t);</span><br><span class="line">        tr.data.ptr.buffer &#x3D; reinterpret_cast&lt;uintptr_t&gt;(statusBuffer);</span><br><span class="line">        tr.offsets_size &#x3D; 0;</span><br><span class="line">        tr.data.ptr.offsets &#x3D; 0;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return (mLastError &#x3D; err);</span><br><span class="line">    &#125;</span><br><span class="line">    mOut.writeInt32(cmd); &#x2F;&#x2F; cmd &#x3D; BC_TRANSACTION</span><br><span class="line">    mOut.write(&amp;tr, sizeof(tr)); &#x2F;&#x2F; 写入 binder_transaction_data 数据</span><br><span class="line">    return NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 handle 的值用来标示目的端，注册服务过程的目的端为 service manager，此处 handle=0 所对应的是 binder_context_mgr_node 对象，正是 service manager 所对应的 binder 实体对象。<br>binder_transaction_data 结构体是 binder 驱动通信的数据结构，该过程最终是把 Binder 请求码 BC_TRANSACTION 和 binder_transaction_data 结构体写入到 mOut</p>
<p>transact 过程，先写完 binder_transaction_data 数据，其中 Parcel data 的重要成员变量：</p>
<ul>
<li>mDataSize：保存在 data_size，binder_transaction_data 的数据大小</li>
<li>mData：保存在 ptr.buffer，binder_transaction_data 的数据的起始地址</li>
<li>mObjectsSize：保存在 offsets_size，记录了 flat_binder_object 结构体的个数</li>
<li>mObjects：保存在 ptr.offsets，记录了 flat_binder_object 结构体在数据中的偏移量</li>
</ul>
<p>接下来执行 waitForResponse()方法</p>
<h3 id="3-6-IPCThreadState-waitForResponse"><a href="#3-6-IPCThreadState-waitForResponse" class="headerlink" title="# 3.6 IPCThreadState.waitForResponse"></a># 3.6 IPCThreadState.waitForResponse</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IPCThreadState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/IPCThreadState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">status_t IPCThreadState::waitForResponse(Parcel *reply, status_t *acquireResult)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t cmd;</span><br><span class="line">    int32_t err;</span><br><span class="line">    while (1) &#123;</span><br><span class="line">        if ((err&#x3D;talkWithDriver()) &lt; NO_ERROR) break; &#x2F;&#x2F; 【见小节 3.7】</span><br><span class="line">        err &#x3D; mIn.errorCheck(); &#x2F;&#x2F; 数据错误检查</span><br><span class="line">        if (err &lt; NO_ERROR) break;</span><br><span class="line">        if (mIn.dataAvail() &#x3D;&#x3D; 0) continue;</span><br><span class="line"></span><br><span class="line">        cmd &#x3D; (uint32_t)mIn.readInt32();</span><br><span class="line">        switch (cmd) &#123;</span><br><span class="line">        case BR_TRANSACTION_COMPLETE:</span><br><span class="line">        case BR_DEAD_REPLY:</span><br><span class="line">        case BR_FAILED_REPLY:</span><br><span class="line">        case BR_ACQUIRE_RESULT:</span><br><span class="line">            goto finish;</span><br><span class="line"></span><br><span class="line">        case BR_REPLY:</span><br><span class="line">            &#123;</span><br><span class="line">                binder_transaction_data tr;</span><br><span class="line">                err &#x3D; mIn.read(&amp;tr, sizeof(tr));</span><br><span class="line">                if (err !&#x3D; NO_ERROR) goto finish; &#x2F;&#x2F; 如果数据报错，直接跳转结束</span><br><span class="line"></span><br><span class="line">                if (reply) &#123;</span><br><span class="line">                    if ((tr.flags &amp; TF_STATUS_CODE) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                        &#x2F;&#x2F; 将返回的 binder_transaction_data 结构体数据保存到 Parcel 对象中</span><br><span class="line">                        reply-&gt;ipcSetDataReference(</span><br><span class="line">                            reinterpret_cast&lt;const uint8_t*&gt;(tr.data.ptr.buffer),</span><br><span class="line">                            tr.data_size,</span><br><span class="line">                            reinterpret_cast&lt;const binder_size_t*&gt;(tr.data.ptr.offsets),</span><br><span class="line">                            tr.offsets_size&#x2F;sizeof(binder_size_t),</span><br><span class="line">                            freeBuffer, this);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        &#x2F;&#x2F; 释放资源...</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F; 释放资源...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            goto finish;</span><br><span class="line"></span><br><span class="line">        default:</span><br><span class="line">            &#x2F;&#x2F; 默认执行命令，见小节 3.8</span><br><span class="line">            err &#x3D; executeCommand(cmd);</span><br><span class="line">            if (err !&#x3D; NO_ERROR) goto finish;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; finish...</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用过程：</p>
<ol>
<li>首先执行 BR_TRANSACTION_COMPLETE 命令</li>
<li>当目标进程收到事务后，处理 BR_TRANSACTION 事务</li>
<li>然后发送给当前进程，再执行 BR_REPLY 命令，读取接收数据</li>
</ol>
<h3 id="3-7-IPCThreadState-talkWithDriver"><a href="#3-7-IPCThreadState-talkWithDriver" class="headerlink" title="# 3.7 IPCThreadState.talkWithDriver"></a># 3.7 IPCThreadState.talkWithDriver</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IPCThreadState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/IPCThreadState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">status_t IPCThreadState::talkWithDriver(bool doReceive)</span><br><span class="line">&#123;</span><br><span class="line">    binder_write_read bwr;</span><br><span class="line"></span><br><span class="line">    const bool needRead &#x3D; mIn.dataPosition() &gt;&#x3D; mIn.dataSize();</span><br><span class="line">    const size_t outAvail &#x3D; (!doReceive || needRead) ? mOut.dataSize() : 0;</span><br><span class="line"></span><br><span class="line">    bwr.write_size &#x3D; outAvail;</span><br><span class="line">    bwr.write_buffer &#x3D; (uintptr_t)mOut.data();</span><br><span class="line"></span><br><span class="line">    if (doReceive &amp;&amp; needRead) &#123;</span><br><span class="line">        &#x2F;&#x2F; 接收数据缓冲区信息的填充，如果以后收到数据，就直接填充在 mIn 中 </span><br><span class="line">        bwr.read_size &#x3D; mIn.dataCapacity();</span><br><span class="line">        bwr.read_buffer &#x3D; (uintptr_t)mIn.data();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        bwr.read_size &#x3D; 0;</span><br><span class="line">        bwr.read_buffer &#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 当读写缓冲都为空，则直接返回</span><br><span class="line">    if ((bwr.write_size &#x3D;&#x3D; 0) &amp;&amp; (bwr.read_size &#x3D;&#x3D; 0)) return NO_ERROR;</span><br><span class="line"></span><br><span class="line">    bwr.write_consumed &#x3D; 0;</span><br><span class="line">    bwr.read_consumed &#x3D; 0;</span><br><span class="line">    status_t err;</span><br><span class="line">    do &#123;</span><br><span class="line">        &#x2F;&#x2F; 通过 ioctl() 一直进行读写操作，与 Binder Driver 进行通信</span><br><span class="line">        if (ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;&#x3D; 0)</span><br><span class="line">            err &#x3D; NO_ERROR;</span><br><span class="line">        else</span><br><span class="line">            err &#x3D; -errno;</span><br><span class="line">    &#125; while (err &#x3D;&#x3D; -EINTR); &#x2F;&#x2F; 当被中断，则继续执行</span><br><span class="line"></span><br><span class="line">    if (err &gt;&#x3D; NO_ERROR) &#123;</span><br><span class="line">        &#x2F;&#x2F; 当存在已经写入的命令协议时，移除 mOut 中对应的数据</span><br><span class="line">        if (bwr.write_consumed &gt; 0) &#123;</span><br><span class="line">            if (bwr.write_consumed &lt; mOut.dataSize())</span><br><span class="line">                mOut.remove(0, bwr.write_consumed);</span><br><span class="line">            else &#123;</span><br><span class="line">                mOut.setDataSize(0);</span><br><span class="line">                processPostWriteDerefs();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 当存在已经读取的返回协议时，保存数据到 mIn 中</span><br><span class="line">        if (bwr.read_consumed &gt; 0) &#123;</span><br><span class="line">            mIn.setDataSize(bwr.read_consumed);</span><br><span class="line">            mIn.setDataPosition(0);</span><br><span class="line">        &#125;</span><br><span class="line">        return NO_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>binder_write_read 结构体用来与 Binder 设备交换数据，通过 ioctl 与 mDriverFD 通信，是真正与 Binder 驱动进行数据读写交互的过程。主要是操作 mOut 和 mIn 变量</p>
<p>ioctl() 经过系统调用后进入 Binder Driver</p>
<h3 id="3-8-executeCommand"><a href="#3-8-executeCommand" class="headerlink" title="# 3.8 executeCommand"></a># 3.8 executeCommand</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/binder/IPCThreadState.cpp" target="_blank" rel="noopener">/frameworks/native/libs/binder/IPCThreadState.cpp</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">status_t IPCThreadState::executeCommand(int32_t cmd)</span><br><span class="line">&#123;</span><br><span class="line">    BBinder* obj;</span><br><span class="line">    RefBase::weakref_type* refs;</span><br><span class="line">    status_t result &#x3D; NO_ERROR;</span><br><span class="line"></span><br><span class="line">    switch ((uint32_t)cmd) &#123;</span><br><span class="line">    case BR_ERROR: ...</span><br><span class="line">    case BR_OK:</span><br><span class="line">    case BR_ACQUIRE: ...</span><br><span class="line">    case BR_RELEASE: ...</span><br><span class="line">    case BR_INCREFS: ...</span><br><span class="line">    case BR_DECREFS: ...</span><br><span class="line">    case BR_ATTEMPT_ACQUIRE: ...</span><br><span class="line">    case BR_DEAD_BINDER: ...</span><br><span class="line">    case BR_CLEAR_DEATH_NOTIFICATION_DONE: ...</span><br><span class="line">    case BR_FINISHED:</span><br><span class="line">    case BR_NOOP:</span><br><span class="line">        break;</span><br><span class="line">        </span><br><span class="line">    case BR_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            binder_transaction_data tr;</span><br><span class="line">            result &#x3D; mIn.read(&amp;tr, sizeof(tr));</span><br><span class="line">            if (result !&#x3D; NO_ERROR) break;</span><br><span class="line"></span><br><span class="line">            Parcel buffer;</span><br><span class="line">            &#x2F;&#x2F; 读取 binder_transaction_data 结构体保存到 Parcel 对象中</span><br><span class="line">            buffer.ipcSetDataReference(</span><br><span class="line">                reinterpret_cast&lt;const uint8_t*&gt;(tr.data.ptr.buffer),</span><br><span class="line">                tr.data_size,</span><br><span class="line">                reinterpret_cast&lt;const binder_size_t*&gt;(tr.data.ptr.offsets),</span><br><span class="line">                tr.offsets_size&#x2F;sizeof(binder_size_t), freeBuffer, this);</span><br><span class="line"></span><br><span class="line">            const pid_t origPid &#x3D; mCallingPid;</span><br><span class="line">            const uid_t origUid &#x3D; mCallingUid;</span><br><span class="line">            const int32_t origStrictModePolicy &#x3D; mStrictModePolicy;</span><br><span class="line">            const int32_t origTransactionBinderFlags &#x3D; mLastTransactionBinderFlags;</span><br><span class="line"></span><br><span class="line">            mCallingPid &#x3D; tr.sender_pid;</span><br><span class="line">            mCallingUid &#x3D; tr.sender_euid;</span><br><span class="line">            mLastTransactionBinderFlags &#x3D; tr.flags;</span><br><span class="line"></span><br><span class="line">            Parcel reply;</span><br><span class="line">            status_t error;</span><br><span class="line">            if (tr.target.ptr) &#123;</span><br><span class="line">                if (reinterpret_cast&lt;RefBase::weakref_type*&gt;(</span><br><span class="line">                        tr.target.ptr)-&gt;attemptIncStrong(this)) &#123;</span><br><span class="line">                    error &#x3D; reinterpret_cast&lt;BBinder*&gt;(tr.cookie)-&gt;transact(tr.code, buffer,</span><br><span class="line">                            &amp;reply, tr.flags);</span><br><span class="line">                    reinterpret_cast&lt;BBinder*&gt;(tr.cookie)-&gt;decStrong(this);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    error &#x3D; UNKNOWN_TRANSACTION;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                error &#x3D; the_context_object-&gt;transact(tr.code, buffer, &amp;reply, tr.flags);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if ((tr.flags &amp; TF_ONE_WAY) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                if (error &lt; NO_ERROR) reply.setError(error);</span><br><span class="line">                sendReply(reply, 0);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mCallingPid &#x3D; origPid;</span><br><span class="line">            mCallingUid &#x3D; origUid;</span><br><span class="line">            mStrictModePolicy &#x3D; origStrictModePolicy;</span><br><span class="line">            mLastTransactionBinderFlags &#x3D; origTransactionBinderFlags;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">    case BR_SPAWN_LOOPER:</span><br><span class="line">        &#x2F;&#x2F; 创建新的 Binder 线程</span><br><span class="line">        mProcess-&gt;spawnPooledThread(false);</span><br><span class="line">        break;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Binder-Driver"><a href="#4-Binder-Driver" class="headerlink" title="# 4. Binder Driver"></a># 4. Binder Driver</h2><p>ioctl -&gt; binder_ioctl -&gt; binder_ioctl_write_read</p>
<h3 id="4-1-binder-ioctl-write-read"><a href="#4-1-binder-ioctl-write-read" class="headerlink" title="# 4.1 binder_ioctl_write_read"></a># 4.1 binder_ioctl_write_read</h3><p><a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/binder.c" target="_blank" rel="noopener">/drivers/staging/android/binder.c</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">static int binder_ioctl_write_read(struct file *filp,</span><br><span class="line">				unsigned int cmd, unsigned long arg,</span><br><span class="line">				struct binder_thread *thread)</span><br><span class="line">&#123;</span><br><span class="line">	int ret &#x3D; 0;</span><br><span class="line">	struct binder_proc *proc &#x3D; filp-&gt;private_data;</span><br><span class="line">	unsigned int size &#x3D; _IOC_SIZE(cmd);</span><br><span class="line">	void __user *ubuf &#x3D; (void __user *)arg;</span><br><span class="line">	struct binder_write_read bwr;</span><br><span class="line">    &#x2F;&#x2F; 检查数据大小</span><br><span class="line">	if (size !&#x3D; sizeof(struct binder_write_read)) &#123;</span><br><span class="line">		ret &#x3D; -EINVAL;</span><br><span class="line">		goto out;</span><br><span class="line">	&#125;</span><br><span class="line">    &#x2F;&#x2F; 将用户空间 binder_write_read 结构体拷贝到内核空间</span><br><span class="line">    copy_from_user(&amp;bwr, ubuf, sizeof(bwr))</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">	if (bwr.write_size &gt; 0) &#123;</span><br><span class="line">        &#x2F;&#x2F; 将数据放入目标进程【见小节 4.2】</span><br><span class="line">		ret &#x3D; binder_thread_write(proc, thread,</span><br><span class="line">					  bwr.write_buffer,</span><br><span class="line">					  bwr.write_size,</span><br><span class="line">					  &amp;bwr.write_consumed);</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">	&#125;</span><br><span class="line">	if (bwr.read_size &gt; 0) &#123;</span><br><span class="line">        &#x2F;&#x2F; 读取自己进程的数据【见小节 4.3】</span><br><span class="line">		ret &#x3D; binder_thread_read(proc, thread, bwr.read_buffer,</span><br><span class="line">					 bwr.read_size,</span><br><span class="line">					 &amp;bwr.read_consumed,</span><br><span class="line">					 filp-&gt;f_flags &amp; O_NONBLOCK);</span><br><span class="line">		if (!list_empty(&amp;proc-&gt;todo))</span><br><span class="line">			wake_up_interruptible(&amp;proc-&gt;wait);</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">	&#125;</span><br><span class="line">    &#x2F;&#x2F; 将内核空间 binder_write_read 结构体拷贝到用户空间</span><br><span class="line">    copy_to_user(ubuf, &amp;bwr, sizeof(bwr))</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-binder-thread-write"><a href="#4-2-binder-thread-write" class="headerlink" title="# 4.2 binder_thread_write"></a># 4.2 binder_thread_write</h3><p><a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/binder.c" target="_blank" rel="noopener">/drivers/staging/android/binder.c</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">static int binder_thread_write(struct binder_proc *proc,</span><br><span class="line">			struct binder_thread *thread,</span><br><span class="line">			binder_uintptr_t binder_buffer, size_t size,</span><br><span class="line">			binder_size_t *consumed)</span><br><span class="line">&#123;</span><br><span class="line">	uint32_t cmd;</span><br><span class="line">	void __user *buffer &#x3D; (void __user *)(uintptr_t)binder_buffer;</span><br><span class="line">	void __user *ptr &#x3D; buffer + *consumed;</span><br><span class="line">	void __user *end &#x3D; buffer + size;</span><br><span class="line"></span><br><span class="line">	while (ptr &lt; end &amp;&amp; thread-&gt;return_error &#x3D;&#x3D; BR_OK) &#123;</span><br><span class="line">        &#x2F;&#x2F; 拷贝用户空间的 cmd 命令，此时为 BC_TRANSACTION</span><br><span class="line">		if (get_user(cmd, (uint32_t __user *)ptr)) return -EFAULT;</span><br><span class="line">		ptr +&#x3D; sizeof(uint32_t);</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">		switch (cmd) &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">		case BC_TRANSACTION:</span><br><span class="line">		case BC_REPLY: &#123;</span><br><span class="line">			struct binder_transaction_data tr;</span><br><span class="line">            &#x2F;&#x2F; 拷贝用户空间的 binder_transaction_data</span><br><span class="line">			if (copy_from_user(&amp;tr, ptr, sizeof(tr))) return -EFAULT;</span><br><span class="line">			ptr +&#x3D; sizeof(tr);</span><br><span class="line">            &#x2F;&#x2F; 见小节 4.3</span><br><span class="line">			binder_transaction(proc, thread, &amp;tr, cmd &#x3D;&#x3D; BC_REPLY);</span><br><span class="line">			break;</span><br><span class="line">		&#125;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">		*consumed &#x3D; ptr - buffer;</span><br><span class="line">	&#125;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-binder-transaction"><a href="#4-3-binder-transaction" class="headerlink" title="# 4.3 binder_transaction"></a># 4.3 binder_transaction</h3><p><a href="http://androidxref.com/kernel_3.18/xref/drivers/staging/android/binder.c" target="_blank" rel="noopener">/drivers/staging/android/binder.c</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">static void binder_transaction(struct binder_proc *proc,</span><br><span class="line">			       struct binder_thread *thread,</span><br><span class="line">			       struct binder_transaction_data *tr, int reply)</span><br><span class="line">&#123;</span><br><span class="line">	struct binder_transaction *t;</span><br><span class="line">	struct binder_work *tcomplete;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">	if (reply) &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		if (tr-&gt;target.handle) &#123;</span><br><span class="line">            &#x2F;&#x2F; ...</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; handle &#x3D; 0 则找到 servicemanager 实体</span><br><span class="line">			target_node &#x3D; binder_context_mgr_node;</span><br><span class="line">		&#125;</span><br><span class="line">		target_proc &#x3D; target_node-&gt;proc;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">	&#125;</span><br><span class="line">	if (target_thread) &#123;</span><br><span class="line">		&#x2F;&#x2F; ...</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; 找到 serivcemanager 进程的 todo 队列</span><br><span class="line">		target_list &#x3D; &amp;target_proc-&gt;todo;</span><br><span class="line">		target_wait &#x3D; &amp;target_proc-&gt;wait;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	t &#x3D; kzalloc(sizeof(*t), GFP_KERNEL);</span><br><span class="line">	tcomplete &#x3D; kzalloc(sizeof(*tcomplete), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 非 TF_ONE_WAY 的通信方式，把当前 thread 保存到 transaction 的 from 字段</span><br><span class="line">	if (!reply &amp;&amp; !(tr-&gt;flags &amp; TF_ONE_WAY))</span><br><span class="line">		t-&gt;from &#x3D; thread;</span><br><span class="line">	else</span><br><span class="line">		t-&gt;from &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">	t-&gt;sender_euid &#x3D; task_euid(proc-&gt;tsk);</span><br><span class="line">	t-&gt;to_proc &#x3D; target_proc; &#x2F;&#x2F; 此次通信目标进程为 servicemanager 进程</span><br><span class="line">	t-&gt;to_thread &#x3D; target_thread;</span><br><span class="line">	t-&gt;code &#x3D; tr-&gt;code; &#x2F;&#x2F; 此次通信 code &#x3D; ADD_SERVICE_TRANSACTION</span><br><span class="line">	t-&gt;flags &#x3D; tr-&gt;flags; &#x2F;&#x2F; 此次通信 flags &#x3D; 0</span><br><span class="line">	t-&gt;priority &#x3D; task_nice(current);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 从 servicemanager 进程中分配 buffer</span><br><span class="line">	t-&gt;buffer &#x3D; binder_alloc_buf(target_proc, tr-&gt;data_size,</span><br><span class="line">		tr-&gt;offsets_size, !reply &amp;&amp; (t-&gt;flags &amp; TF_ONE_WAY));</span><br><span class="line"></span><br><span class="line">	t-&gt;buffer-&gt;allow_user_free &#x3D; 0;</span><br><span class="line">	t-&gt;buffer-&gt;transaction &#x3D; t;</span><br><span class="line">	t-&gt;buffer-&gt;target_node &#x3D; target_node;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 引用计数 +1</span><br><span class="line">	if (target_node)</span><br><span class="line">		binder_inc_node(target_node, 1, 0, NULL);</span><br><span class="line"></span><br><span class="line">	offp &#x3D; (binder_size_t *)(t-&gt;buffer-&gt;data +</span><br><span class="line">				 ALIGN(tr-&gt;data_size, sizeof(void *)));</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 拷贝用户空间的 binder_transaction_data 中的 ptr.buffer 到内核</span><br><span class="line">	if (copy_from_user(t-&gt;buffer-&gt;data, (const void __user *)(uintptr_t)</span><br><span class="line">			   tr-&gt;data.ptr.buffer, tr-&gt;data_size)) &#123;</span><br><span class="line">		&#x2F;&#x2F; ...</span><br><span class="line">	&#125;</span><br><span class="line">    &#x2F;&#x2F; 拷贝用户空间的 binder_transaction_data 中的 ptr.offsets 到内核</span><br><span class="line">	if (copy_from_user(offp, (const void __user *)(uintptr_t)</span><br><span class="line">			   tr-&gt;data.ptr.offsets, tr-&gt;offsets_size)) &#123;</span><br><span class="line">		&#x2F;&#x2F; ...</span><br><span class="line">	&#125;</span><br><span class="line">	off_end &#x3D; (void *)offp + tr-&gt;offsets_size;</span><br><span class="line">	off_min &#x3D; 0;</span><br><span class="line">	for (; offp &lt; off_end; offp++) &#123;</span><br><span class="line">		struct flat_binder_object *fp;</span><br><span class="line">		fp &#x3D; (struct flat_binder_object *)(t-&gt;buffer-&gt;data + *offp);</span><br><span class="line">		off_min &#x3D; *offp + sizeof(struct flat_binder_object);</span><br><span class="line">		switch (fp-&gt;type) &#123;</span><br><span class="line">		case BINDER_TYPE_BINDER:</span><br><span class="line">		case BINDER_TYPE_WEAK_BINDER: &#123;</span><br><span class="line">			struct binder_ref *ref;</span><br><span class="line">            &#x2F;&#x2F; 见【4.3.1】</span><br><span class="line">			struct binder_node *node &#x3D; binder_get_node(proc, fp-&gt;binder);</span><br><span class="line"></span><br><span class="line">			if (node &#x3D;&#x3D; NULL) &#123;</span><br><span class="line">                &#x2F;&#x2F; 服务所在进程 创建 binder_node 实体【见 4.3.2】</span><br><span class="line">				node &#x3D; binder_new_node(proc, fp-&gt;binder, fp-&gt;cookie);</span><br><span class="line">                &#x2F;&#x2F; ...</span><br><span class="line">			&#125;</span><br><span class="line">            &#x2F;&#x2F; servicemanager 进程 binder_ref【见 4.3.3】</span><br><span class="line">			ref &#x3D; binder_get_ref_for_node(target_proc, node);</span><br><span class="line">            &#x2F;&#x2F; ...</span><br><span class="line">            &#x2F;&#x2F; 调整 type 为 HANDLE 类型</span><br><span class="line">			if (fp-&gt;type &#x3D;&#x3D; BINDER_TYPE_BINDER)</span><br><span class="line">				fp-&gt;type &#x3D; BINDER_TYPE_HANDLE;</span><br><span class="line">			else</span><br><span class="line">				fp-&gt;type &#x3D; BINDER_TYPE_WEAK_HANDLE;</span><br><span class="line">			fp-&gt;handle &#x3D; ref-&gt;desc; &#x2F;&#x2F; 设置 handle 值</span><br><span class="line">			binder_inc_ref(ref, fp-&gt;type &#x3D;&#x3D; BINDER_TYPE_HANDLE,</span><br><span class="line">				       &amp;thread-&gt;todo);</span><br><span class="line">		&#125; break;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">	&#125;</span><br><span class="line">	if (reply) &#123;</span><br><span class="line">		&#x2F;&#x2F; ...</span><br><span class="line">	&#125; else if (!(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</span><br><span class="line">        &#x2F;&#x2F; BC_TRANSACTION 且非 TF_ONE_WAY，则设置事务栈信息</span><br><span class="line">		t-&gt;need_reply &#x3D; 1;</span><br><span class="line">		t-&gt;from_parent &#x3D; thread-&gt;transaction_stack;</span><br><span class="line">		thread-&gt;transaction_stack &#x3D; t;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		&#x2F;&#x2F; ...</span><br><span class="line">	&#125;</span><br><span class="line">    &#x2F;&#x2F; 将 BINDER_WORK_TRANSACTION 添加到目标队列，本次通信的目标队列为 target_proc-&gt;todo</span><br><span class="line">	t-&gt;work.type &#x3D; BINDER_WORK_TRANSACTION;</span><br><span class="line">	list_add_tail(&amp;t-&gt;work.entry, target_list);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 将 BINDER_WORK_TRANSACTION_COMPLETE 添加到当前线程的 todo 队列</span><br><span class="line">	tcomplete-&gt;type &#x3D; BINDER_WORK_TRANSACTION_COMPLETE;</span><br><span class="line">	list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 唤醒等待队列，本次通信的目标队列为 target_proc-&gt;wait</span><br><span class="line">	if (target_wait)</span><br><span class="line">		wake_up_interruptible(target_wait);</span><br><span class="line">	return;</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册服务的过程，传递的是 BBinder 对象，所以【小节 3.2.1】的 writeStrongBinder()过程中 localBinder 不为空，从而 flat_binder_object.type 等于 BINDER_TYPE_BINDER</p>
<p>服务注册过程是在服务所在进程创建 binder_node，在 ServiceManager 进程创建 binder_ref。对于同一个 binder_node，每个进程只会创建一个 binder_ref 对象</p>
<p>向 ServiceManager 的 binder_proc-&gt;todo 添加 BINDER_WORK_TRANSACTION_COMPLETE 事务，接下来进入 ServiceManager 进程</p>
<h4 id="4-3-1-binder-get-node"><a href="#4-3-1-binder-get-node" class="headerlink" title="# 4.3.1 binder_get_node"></a># 4.3.1 binder_get_node</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">static struct binder_node *binder_get_node(struct binder_proc *proc,</span><br><span class="line">					   binder_uintptr_t ptr)</span><br><span class="line">&#123;</span><br><span class="line">	struct rb_node *n &#x3D; proc-&gt;nodes.rb_node;</span><br><span class="line">	struct binder_node *node;</span><br><span class="line"></span><br><span class="line">	while (n) &#123;</span><br><span class="line">		node &#x3D; rb_entry(n, struct binder_node, rb_node);</span><br><span class="line"></span><br><span class="line">		if (ptr &lt; node-&gt;ptr)</span><br><span class="line">			n &#x3D; n-&gt;rb_left;</span><br><span class="line">		else if (ptr &gt; node-&gt;ptr)</span><br><span class="line">			n &#x3D; n-&gt;rb_right;</span><br><span class="line">		else</span><br><span class="line">			return node;</span><br><span class="line">	&#125;</span><br><span class="line">	return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据 binder 指针 ptr 值从 binder_proc 来查询响应的 binder_node</p>
<h4 id="4-3-2-binder-new-node"><a href="#4-3-2-binder-new-node" class="headerlink" title="# 4.3.2 binder_new_node"></a># 4.3.2 binder_new_node</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">static struct binder_node *binder_new_node(struct binder_proc *proc,</span><br><span class="line">					   binder_uintptr_t ptr,</span><br><span class="line">					   binder_uintptr_t cookie)</span><br><span class="line">&#123;</span><br><span class="line">	struct rb_node **p &#x3D; &amp;proc-&gt;nodes.rb_node;</span><br><span class="line">	struct rb_node *parent &#x3D; NULL;</span><br><span class="line">	struct binder_node *node;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 红黑树位置查找</span><br><span class="line">	while (*p) &#123;</span><br><span class="line">		parent &#x3D; *p;</span><br><span class="line">		node &#x3D; rb_entry(parent, struct binder_node, rb_node);</span><br><span class="line"></span><br><span class="line">		if (ptr &lt; node-&gt;ptr)</span><br><span class="line">			p &#x3D; &amp;(*p)-&gt;rb_left;</span><br><span class="line">		else if (ptr &gt; node-&gt;ptr)</span><br><span class="line">			p &#x3D; &amp;(*p)-&gt;rb_right;</span><br><span class="line">		else</span><br><span class="line">			return NULL;</span><br><span class="line">	&#125;</span><br><span class="line">    &#x2F;&#x2F; 将新创建的 binder_node 分配内核空间</span><br><span class="line">	node &#x3D; kzalloc(sizeof(*node), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 将新创建的 node 添加到 proc 红黑树</span><br><span class="line">	rb_link_node(&amp;node-&gt;rb_node, parent, p);</span><br><span class="line"></span><br><span class="line">	rb_insert_color(&amp;node-&gt;rb_node, &amp;proc-&gt;nodes);</span><br><span class="line">	node-&gt;debug_id &#x3D; ++binder_last_id;</span><br><span class="line">	node-&gt;proc &#x3D; proc;</span><br><span class="line">	node-&gt;ptr &#x3D; ptr;</span><br><span class="line">	node-&gt;cookie &#x3D; cookie;</span><br><span class="line">	node-&gt;work.type &#x3D; BINDER_WORK_NODE; &#x2F;&#x2F; 设置 binder_work 的 type</span><br><span class="line">	INIT_LIST_HEAD(&amp;node-&gt;work.entry);</span><br><span class="line">	INIT_LIST_HEAD(&amp;node-&gt;async_todo);</span><br><span class="line">	return node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-binder-get-ref-for-node"><a href="#4-3-3-binder-get-ref-for-node" class="headerlink" title="# 4.3.3 binder_get_ref_for_node"></a># 4.3.3 binder_get_ref_for_node</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">static struct binder_ref *binder_get_ref_for_node(struct binder_proc *proc,</span><br><span class="line">						  struct binder_node *node)</span><br><span class="line">&#123;</span><br><span class="line">	struct rb_node *n;</span><br><span class="line">	struct rb_node **p &#x3D; &amp;proc-&gt;refs_by_node.rb_node;</span><br><span class="line">	struct rb_node *parent &#x3D; NULL;</span><br><span class="line">	struct binder_ref *ref, *new_ref;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 从 refs_by_node 红黑树，找到 binder_ref 则直接返回</span><br><span class="line">	while (*p) &#123;</span><br><span class="line">		parent &#x3D; *p;</span><br><span class="line">		ref &#x3D; rb_entry(parent, struct binder_ref, rb_node_node);</span><br><span class="line"></span><br><span class="line">		if (node &lt; ref-&gt;node)</span><br><span class="line">			p &#x3D; &amp;(*p)-&gt;rb_left;</span><br><span class="line">		else if (node &gt; ref-&gt;node)</span><br><span class="line">			p &#x3D; &amp;(*p)-&gt;rb_right;</span><br><span class="line">		else</span><br><span class="line">			return ref;</span><br><span class="line">	&#125;</span><br><span class="line">    &#x2F;&#x2F; 将新创建的 bind_ref 分配内核空间</span><br><span class="line">	new_ref &#x3D; kzalloc(sizeof(*ref), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">	new_ref-&gt;debug_id &#x3D; ++binder_last_id;</span><br><span class="line">	new_ref-&gt;proc &#x3D; proc; &#x2F;&#x2F; 记录进程信息</span><br><span class="line">	new_ref-&gt;node &#x3D; node; &#x2F;&#x2F; 记录 binder 节点</span><br><span class="line">	rb_link_node(&amp;new_ref-&gt;rb_node_node, parent, p);</span><br><span class="line">	rb_insert_color(&amp;new_ref-&gt;rb_node_node, &amp;proc-&gt;refs_by_node);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 计算 binder 引用的 handle 值，该值返回给 target_proc 进程</span><br><span class="line">	new_ref-&gt;desc &#x3D; (node &#x3D;&#x3D; binder_context_mgr_node) ? 0 : 1;</span><br><span class="line">    &#x2F;&#x2F; 从红黑树最左边的 handle 对比，依次递增，直到红黑树遍历结束或者找到更大的 handle 则结束</span><br><span class="line">	for (n &#x3D; rb_first(&amp;proc-&gt;refs_by_desc); n !&#x3D; NULL; n &#x3D; rb_next(n)) &#123;</span><br><span class="line">		ref &#x3D; rb_entry(n, struct binder_ref, rb_node_desc);</span><br><span class="line">		if (ref-&gt;desc &gt; new_ref-&gt;desc)</span><br><span class="line">			break;</span><br><span class="line">		new_ref-&gt;desc &#x3D; ref-&gt;desc + 1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 将新创建的 new_ref 传入 proc-&gt;refs_by_desc 红黑树</span><br><span class="line">	p &#x3D; &amp;proc-&gt;refs_by_desc.rb_node;</span><br><span class="line">	while (*p) &#123;</span><br><span class="line">		parent &#x3D; *p;</span><br><span class="line">		ref &#x3D; rb_entry(parent, struct binder_ref, rb_node_desc);</span><br><span class="line"></span><br><span class="line">		if (new_ref-&gt;desc &lt; ref-&gt;desc)</span><br><span class="line">			p &#x3D; &amp;(*p)-&gt;rb_left;</span><br><span class="line">		else if (new_ref-&gt;desc &gt; ref-&gt;desc)</span><br><span class="line">			p &#x3D; &amp;(*p)-&gt;rb_right;</span><br><span class="line">		else</span><br><span class="line">			BUG();</span><br><span class="line">	&#125;</span><br><span class="line">	rb_link_node(&amp;new_ref-&gt;rb_node_desc, parent, p);</span><br><span class="line">	rb_insert_color(&amp;new_ref-&gt;rb_node_desc, &amp;proc-&gt;refs_by_desc);</span><br><span class="line">	if (node) &#123;</span><br><span class="line">		hlist_add_head(&amp;new_ref-&gt;node_entry, &amp;node-&gt;refs);</span><br><span class="line">	&#125; </span><br><span class="line">	return new_ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handle 值计算方法规律：</p>
<ul>
<li>每个进程 binder_proc 所记录的 binder_ref 的 handle 值是从 1 开始递增的</li>
<li>所有进程 binder_proc 所记录的 handle = 0 的 binder_ref 都指向 ServiceManager</li>
<li>同一个服务的 binder_node 在不同进程的 binder_ref 的 handle 值可以不同</li>
</ul>
<h2 id="5-ServiceManager"><a href="#5-ServiceManager" class="headerlink" title="# 5. ServiceManager"></a># 5. ServiceManager</h2><p>由 <a href="">Binder 系列 3- 启动 ServiceManager</a> 已介绍其原理，循环在 binder_loop()过程，会调用 binder_parse()方法</p>
<h3 id="5-1-binder-parse"><a href="#5-1-binder-parse" class="headerlink" title="# 5.1 binder_parse"></a># 5.1 binder_parse</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/servicemanager/binder.c#217" target="_blank" rel="noopener">/frameworks/native/cmds/servicemanager/binder.c</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">int binder_parse(struct binder_state *bs, struct binder_io *bio,</span><br><span class="line">                 uintptr_t ptr, size_t size, binder_handler func)</span><br><span class="line">&#123;</span><br><span class="line">    int r &#x3D; 1;</span><br><span class="line">    uintptr_t end &#x3D; ptr + (uintptr_t) size;</span><br><span class="line"></span><br><span class="line">    while (ptr &lt; end) &#123;</span><br><span class="line">        uint32_t cmd &#x3D; *(uint32_t *) ptr;</span><br><span class="line">        ptr +&#x3D; sizeof(uint32_t);</span><br><span class="line">        switch(cmd) &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        case BR_TRANSACTION: &#123;</span><br><span class="line">            struct binder_transaction_data *txn &#x3D; (struct binder_transaction_data *) ptr;</span><br><span class="line">            &#x2F;&#x2F; ...</span><br><span class="line">            binder_dump_txn(txn);</span><br><span class="line">            if (func) &#123;</span><br><span class="line">                unsigned rdata[256&#x2F;4];</span><br><span class="line">                struct binder_io msg;</span><br><span class="line">                struct binder_io reply;</span><br><span class="line">                int res;</span><br><span class="line"></span><br><span class="line">                bio_init(&amp;reply, rdata, sizeof(rdata), 4);</span><br><span class="line">                bio_init_from_txn(&amp;msg, txn); &#x2F;&#x2F; 从 txn 解析出 binder_io 信息</span><br><span class="line">                &#x2F;&#x2F; 收到 Binder 事务【见小节 5.2】</span><br><span class="line">                res &#x3D; func(bs, txn, &amp;msg, &amp;reply);</span><br><span class="line">                if (txn-&gt;flags &amp; TF_ONE_WAY) &#123;</span><br><span class="line">                    binder_free_buffer(bs, txn-&gt;data.ptr.buffer);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F; 发送 reply 事件【见小节 5.4】</span><br><span class="line">                    binder_send_reply(bs, &amp;reply, txn-&gt;data.ptr.buffer, res);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ptr +&#x3D; sizeof(*txn);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">    return r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-svcmgr-handler"><a href="#5-2-svcmgr-handler" class="headerlink" title="# 5.2 svcmgr_handler"></a># 5.2 svcmgr_handler</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/servicemanager/service_manager.c#svcmgr_handler" target="_blank" rel="noopener">/frameworks/native/cmds/servicemanager/service_manager.c</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">int svcmgr_handler(struct binder_state *bs,</span><br><span class="line">                   struct binder_transaction_data *txn,</span><br><span class="line">                   struct binder_io *msg,</span><br><span class="line">                   struct binder_io *reply)</span><br><span class="line">&#123;</span><br><span class="line">    struct svcinfo *si;</span><br><span class="line">    uint16_t *s;</span><br><span class="line">    size_t len;</span><br><span class="line">    uint32_t handle;</span><br><span class="line">    uint32_t strict_policy;</span><br><span class="line">    int allow_isolated;</span><br><span class="line">    uint32_t dumpsys_priority;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    strict_policy &#x3D; bio_get_uint32(msg);</span><br><span class="line">    s &#x3D; bio_get_string16(msg, &amp;len);</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    switch(txn-&gt;code) &#123;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    case SVC_MGR_ADD_SERVICE:</span><br><span class="line">        s &#x3D; bio_get_string16(msg, &amp;len);</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">        handle &#x3D; bio_get_ref(msg); &#x2F;&#x2F; 获取 handle</span><br><span class="line">        allow_isolated &#x3D; bio_get_uint32(msg) ? 1 : 0;</span><br><span class="line">        dumpsys_priority &#x3D; bio_get_uint32(msg);</span><br><span class="line">        &#x2F;&#x2F; 注册指定服务【见小节 5.3】</span><br><span class="line">        if (do_add_service(bs, s, len, handle, txn-&gt;sender_euid, allow_isolated, dumpsys_priority,</span><br><span class="line">                           txn-&gt;sender_pid))</span><br><span class="line">            return -1;</span><br><span class="line">        break;</span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line">    &#125;</span><br><span class="line">    bio_put_uint32(reply, 0);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-do-add-service"><a href="#5-3-do-add-service" class="headerlink" title="# 5.3 do_add_service"></a># 5.3 do_add_service</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/servicemanager/service_manager.c#svcmgr_handler" target="_blank" rel="noopener">/frameworks/native/cmds/servicemanager/service_manager.c</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">int do_add_service(struct binder_state *bs, const uint16_t *s, size_t len, uint32_t handle,</span><br><span class="line">                   uid_t uid, int allow_isolated, uint32_t dumpsys_priority, pid_t spid) &#123;</span><br><span class="line">    struct svcinfo *si;</span><br><span class="line"></span><br><span class="line">    if (!handle || (len &#x3D;&#x3D; 0) || (len &gt; 127))</span><br><span class="line">        return -1;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 权限检查</span><br><span class="line">    if (!svc_can_register(s, len, spid, uid)) &#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 服务检索</span><br><span class="line">    si &#x3D; find_svc(s, len);</span><br><span class="line">    if (si) &#123;</span><br><span class="line">        if (si-&gt;handle) &#123;</span><br><span class="line">            svcinfo_death(bs, si); &#x2F;&#x2F; 服务已注册时，释放相应的服务</span><br><span class="line">        &#125;</span><br><span class="line">        si-&gt;handle &#x3D; handle;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        si &#x3D; malloc(sizeof(*si) + (len + 1) * sizeof(uint16_t));</span><br><span class="line">        if (!si) &#123; &#x2F;&#x2F; 内存不足，无法分配足够内存</span><br><span class="line">            return -1;</span><br><span class="line">        &#125;</span><br><span class="line">        si-&gt;handle &#x3D; handle;</span><br><span class="line">        si-&gt;len &#x3D; len;</span><br><span class="line">        memcpy(si-&gt;name, s, (len + 1) * sizeof(uint16_t)); &#x2F;&#x2F; 内存拷贝服务信息</span><br><span class="line">        si-&gt;name[len] &#x3D; &#39;\0&#39;;</span><br><span class="line">        si-&gt;death.func &#x3D; (void*) svcinfo_death;</span><br><span class="line">        si-&gt;death.ptr &#x3D; si;</span><br><span class="line">        si-&gt;allow_isolated &#x3D; allow_isolated;</span><br><span class="line">        si-&gt;dumpsys_priority &#x3D; dumpsys_priority;</span><br><span class="line">        si-&gt;next &#x3D; svclist; &#x2F;&#x2F; svclist 保存所有已注册的服务</span><br><span class="line">        svclist &#x3D; si;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 以 BC_ACQUIRE 命令，handle 为目标的信息，通过 ioctl 发送给 binder 驱动</span><br><span class="line">    binder_acquire(bs, handle);</span><br><span class="line">    &#x2F;&#x2F; 以 BC_REQUEST_DEATH_NOTIFICATION 命令的信息，通过 ioctl 发送给 binder 驱动，主要用于清理内存等</span><br><span class="line">    binder_link_to_death(bs, handle, &amp;si-&gt;death);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>svcinfo 记录着服务名和 handle 信息，保存到 svclist 列表</p>
<h3 id="5-4-binder-send-reply"><a href="#5-4-binder-send-reply" class="headerlink" title="# 5.4 binder_send_reply"></a># 5.4 binder_send_reply</h3><p><a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/cmds/servicemanager/binder.c#217" target="_blank" rel="noopener">/frameworks/native/cmds/servicemanager/binder.c</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">void binder_send_reply(struct binder_state *bs,</span><br><span class="line">                       struct binder_io *reply,</span><br><span class="line">                       binder_uintptr_t buffer_to_free,</span><br><span class="line">                       int status)</span><br><span class="line">&#123;</span><br><span class="line">    struct &#123;</span><br><span class="line">        uint32_t cmd_free;</span><br><span class="line">        binder_uintptr_t buffer;</span><br><span class="line">        uint32_t cmd_reply;</span><br><span class="line">        struct binder_transaction_data txn;</span><br><span class="line">    &#125; __attribute__((packed)) data;</span><br><span class="line"></span><br><span class="line">    data.cmd_free &#x3D; BC_FREE_BUFFER; &#x2F;&#x2F; free buffer 命令</span><br><span class="line">    data.buffer &#x3D; buffer_to_free;</span><br><span class="line">    data.cmd_reply &#x3D; BC_REPLY; &#x2F;&#x2F; reply 命令</span><br><span class="line">    data.txn.target.ptr &#x3D; 0;</span><br><span class="line">    data.txn.cookie &#x3D; 0;</span><br><span class="line">    data.txn.code &#x3D; 0;</span><br><span class="line">    if (status) &#123;</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        data.txn.flags &#x3D; 0;</span><br><span class="line">        data.txn.data_size &#x3D; reply-&gt;data - reply-&gt;data0;</span><br><span class="line">        data.txn.offsets_size &#x3D; ((char*) reply-&gt;offs) - ((char*) reply-&gt;offs0);</span><br><span class="line">        data.txn.data.ptr.buffer &#x3D; (uintptr_t)reply-&gt;data0;</span><br><span class="line">        data.txn.data.ptr.offsets &#x3D; (uintptr_t)reply-&gt;offs0;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 向 binder 驱动通信</span><br><span class="line">    binder_write(bs, &amp;data, sizeof(data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>binder_write 进入 binder 驱动后，将 BC_FREE_BUFFER 和 BC_REPLY 命令协议发送给 Binder 驱动，向 client 端发送 reply</p>
<h3 id="5-4-binder-write"><a href="#5-4-binder-write" class="headerlink" title="# 5.4 binder_write"></a># 5.4 binder_write</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int binder_write(struct binder_state *bs, void *data, size_t len)</span><br><span class="line">&#123;</span><br><span class="line">    struct binder_write_read bwr;</span><br><span class="line">    int res;</span><br><span class="line"></span><br><span class="line">    bwr.write_size &#x3D; len;</span><br><span class="line">    bwr.write_consumed &#x3D; 0;</span><br><span class="line">    bwr.write_buffer &#x3D; (uintptr_t) data;</span><br><span class="line">    bwr.read_size &#x3D; 0;</span><br><span class="line">    bwr.read_consumed &#x3D; 0;</span><br><span class="line">    bwr.read_buffer &#x3D; 0;</span><br><span class="line">    &#x2F;&#x2F; 以 BC_REPLY 命令的信息，通过 ioctl 发送给 binder 驱动，</span><br><span class="line">    res &#x3D; ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line"></span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6- 总结"><a href="#6- 总结" class="headerlink" title="# 6. 总结"></a># 6. 总结 </h2><p> 服务注册过程（addService）核心功能：在服务所在进程创建 binder_node，在 ServiceManager 进程创建 bind_ref。其中 bind_ref 的 handle 在同一个进程中是唯一的：</p>
<ul>
<li>每个进程 binder_proc 所记录的 binder_ref 的 handle 值是从 1 开始递增的</li>
<li>所有进程 binder_proc 所记录的 handle = 0 的 binder_ref 都指向 ServiceManager</li>
<li>同一个服务的 binder_node 在不同进程的 binder_ref 的 handle 值可以不同</li>
</ul>
<p>Media 服务注册的过程涉及到 MediaPlayerService（作为 Client 进程）和 ServiceManager（作为 Service 进程），通信流程图：(来自 Gityuan 大佬)</p>
<p><img src="https://tva4.sinaimg.cn/large/d7f9b0f4gy1glhqk8iq93j20qh0kb74y.jpg" alt="media_player_service_ipc"></p>
<p>过程分析：</p>
<ol>
<li><p>MediaPlayerService 进程调用 ioctl()向 Binder 驱动发送 IPC 数据，该过程可以理解成一个事务 binder_transaction（记为 T1），<br> 执行当前操作的线程 binder_thread（记为 thread1），则 T1-&gt;from_parent=NULL, T1-&gt;from=thread1, thread1-&gt;transaction_stack=T1。<br> 其中 IPC 数据内容包括：</p>
<ul>
<li>Binder 协议为 BC_TRANSACTION</li>
<li>Handle = 0</li>
<li>RPC 代码为 ADD_SERVICE</li>
<li>RPC 数据为 “media.player”</li>
</ul>
</li>
<li><p>Binder 驱动收到该 Binder 请求，生成 BR_TRANSACTION 命令，选择目标处理该请求的线程，即 ServiceManager 的 binder 线程（记为 thread2），<br> 则 T1-&gt;to_parent=NULL, T1-&gt;to_thread=thread2。并将整个 binder_transaction（记为 T2）数据插入到目标线程的 todo 队列</p>
</li>
<li><p>ServiceManager 的线程 thead2 收到 T2 后，调用服务注册函数将服务 “media.player”注册到服务目录中。当服务注册完成后，生成 IPC 应答数据（BC_REPLY），T2-&gt;from_parent=T1,<br> T2-&gt;from = thread2, thread2-&gt;transaction_stack = T2</p>
</li>
<li><p>Binder 驱动收到该 Binder 应答请求，生成 BR_RETRY 命令，T2-&gt;to_parent = T1, T2-&gt;to_thread=thread1, thread-&gt;transaction_stack=T2.<br> 在 MediaPlayerService 收到该命令后，知道服务注册完成便可以正常使用</p>
</li>
</ol>
<p>整个过程中，BC_TRANSACTION 和 BR_TRANSACTION 过程是一个完整的事务过程；BC_REPLY 和 BR_REPLY 是一个完整的事务过程。<br>到此，其他进程便可以获取该服务，使用服务提供的方法，下一篇文章将会讲述 <a href=""> 如何获取服务</a>。</p>
<h2 id="7- 参考"><a href="#7- 参考" class="headerlink" title="# 7. 参考"></a># 7. 参考</h2><p><a href="http://gityuan.com/2015/11/14/binder-add-service/" target="_blank" rel="noopener">http://gityuan.com/2015/11/14/binder-add-service/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/03/%E9%9F%AD%E8%8F%9C%E7%9A%84%E8%87%AA%E6%88%91%E4%BF%AE%E5%85%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="cloud">
      <meta itemprop="description" content="Less is more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cloud's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/03/%E9%9F%AD%E8%8F%9C%E7%9A%84%E8%87%AA%E6%88%91%E4%BF%AE%E5%85%BB/" class="post-title-link" itemprop="url">韭菜的自我修养</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-01-03 13:28:33" itemprop="dateCreated datePublished" datetime="2021-01-03T13:28:33+08:00">2021-01-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-18 10:56:22" itemprop="dateModified" datetime="2021-04-18T10:56:22+08:00">2021-04-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Other/" itemprop="url" rel="index"><span itemprop="name">Other</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="利好"><a href="# 利好" class="headerlink" title="利好"></a>利好</h1><ul>
<li>白酒消费</li>
<li>医疗医药</li>
<li>新能源 -(电源光伏)+(汽车电池)</li>
<li>互联网</li>
<li>半导体 - 芯片</li>
</ul>
<h1 id="股票"><a href="# 股票" class="headerlink" title="股票"></a>股票 </h1><h2 id="招财大牛猫"><a href="# 招财大牛猫" class="headerlink" title="招财大牛猫"></a> 招财大牛猫 </h2><h3 id="茅 20"><a href="# 茅 20" class="headerlink" title="茅 20"></a> 茅 20</h3><ul>
<li><p>600519 贵州茅台 白酒</p>
</li>
<li><p>000858 五粮液 白酒</p>
</li>
<li><p>601318 中国平安 保险</p>
</li>
<li><p>600036 招商银行 银行</p>
</li>
<li><p>603288 海天味业 食品</p>
</li>
<li><p>600276 恒瑞医药 化学制药</p>
</li>
<li><p>000333 美的集团 家用电器</p>
</li>
<li><p>600900 长江电力 水力发电</p>
</li>
<li><p>601888 中国中免 旅游服务</p>
</li>
<li><p>300750 宁德时代 电气设备</p>
</li>
<li><p>002714 牧原股份 农业综合</p>
</li>
<li><p>600031 三一重工 工程机械</p>
</li>
<li><p>300015 爱尔眼科 医疗保健</p>
</li>
<li><p>300760 迈瑞医疗 医疗保健</p>
</li>
<li><p>600309 万华化学 化工原料</p>
</li>
<li><p>600887 伊利股份 乳制品</p>
</li>
<li><p>002475 立讯精密 元器件</p>
</li>
<li><p>300059 东方财富 证券</p>
</li>
<li><p>603259 药明康德 化学制药</p>
</li>
<li><p>002352 顺丰控股 仓储物流</p>
</li>
<li><p>000661 长春高新 生物制药</p>
</li>
</ul>
<h3 id="白马股"><a href="# 白马股" class="headerlink" title="白马股"></a>白马股</h3><ul>
<li><p>华兰生物 12.24 号 43.8 块买入一手 12.29 号 41 块卖出 亏损 280 块</p>
</li>
<li><p>双汇发展</p>
</li>
<li><p>云南白药</p>
</li>
<li><p>格力电器</p>
</li>
<li><p>海螺水泥</p>
</li>
<li><p>智飞生物</p>
</li>
<li><p>用友网络</p>
</li>
<li><p>蓝思科技</p>
</li>
<li><p>歌尔股份</p>
</li>
<li><p>闻泰科技</p>
</li>
<li><p>复星医药</p>
</li>
<li><p>康泰生物</p>
</li>
<li><p>鹏鼎控股</p>
</li>
<li><p>恒生电子</p>
</li>
</ul>
<h2 id="高瓴资本"><a href="# 高瓴资本" class="headerlink" title="高瓴资本"></a>高瓴资本</h2><ul>
<li>恒瑞医药</li>
<li>宁德时代</li>
<li>格力电器</li>
<li>海螺水泥</li>
<li>药明康德</li>
<li>爱尔眼科</li>
<li>公牛集团</li>
<li>五粮液</li>
<li>泰格医疗</li>
<li>广联达</li>
<li>恩捷股份</li>
<li>甘李药业</li>
<li>凯莱英</li>
<li>金域医学</li>
<li>水井坊</li>
<li>良品铺子</li>
<li>隆基股份</li>
</ul>
<h2 id="搬砖小组"><a href="# 搬砖小组" class="headerlink" title="搬砖小组"></a>搬砖小组</h2><ul>
<li><p>英科医疗</p>
</li>
<li><p>智飞生物</p>
</li>
<li><p>安井食品</p>
</li>
<li><p>比亚迪</p>
</li>
<li><p>新宝股份</p>
</li>
<li><p>天赐材料</p>
</li>
<li><p>阳光电源</p>
</li>
<li><p>长城汽车</p>
</li>
<li><p>鹏鼎控股</p>
</li>
<li><p>福耀玻璃</p>
</li>
<li><p>水井坊</p>
</li>
</ul>
<h1 id="基金"><a href="# 基金" class="headerlink" title="基金"></a>基金 </h1><h2 id="招财大牛猫 -1"><a href="# 招财大牛猫 -1" class="headerlink" title="招财大牛猫"></a> 招财大牛猫</h2><ul>
<li><p>天弘沪深 300 指数增强 A（008592）12.24 号 买入 500 块</p>
</li>
<li><p>天弘中证 500 指数增强 A（001556）12.24 号 买入 500 块</p>
</li>
<li><p>汇添富中证新能源汽车产业指数（501057）12.24 号 买入 500 块</p>
</li>
<li><p>汇添富中证新能源汽车产业指数（501058）12.24 号 我买入 500 块 泡仔买入 500 块</p>
</li>
<li><p>招商中证白酒指数分级（161725）12.24 号 我买入 500 块 泡仔买入 500 块</p>
</li>
<li><p>国泰国证新能源汽车（160225）12.24 号 我买入 500 块 泡仔买入 1000 块</p>
</li>
<li><p>天弘中证食品饮料指数（001631）12.24 号 买入 500 块</p>
</li>
<li><p>天弘中证食品饮料指数（001632）12.24 号 买入 500 块</p>
</li>
<li><p>汇添富中证生物科技指数（501009）12.24 号 买入 500 块</p>
</li>
<li><p>汇添富中证生物科技指数（501010）12.24 号 我买入 500 块 泡仔买入 500 块</p>
</li>
<li><p>国泰国证食品饮料行业指数分级（160222）12.24 号 我买入 1000 块 泡仔买入 500 块</p>
</li>
</ul>
<h2 id="老钱说钱"><a href="# 老钱说钱" class="headerlink" title="老钱说钱"></a>老钱说钱</h2><ul>
<li><p>朱少醒 - 富国天惠成长混合 A（161005）12.24 号 我买入 1000 块 泡仔买入 1000 块</p>
</li>
<li><p>杨谷 - 诺安先锋混合（320003）</p>
</li>
<li><p>周蔚文 - 中欧新蓝筹混合 A（166002）12.24 号 我买入 1000 块</p>
</li>
<li><p>董成非 - 兴全趋势投资混合（163402）</p>
</li>
<li><p>刘彦春 - 景顺长城新兴成长混合（260108）12.24 号 我买入 1000 块 泡仔买入 1000 块</p>
</li>
<li><p>景顺长城鼎益混合（162605）</p>
</li>
<li><p>景顺长城内需增长混合（260104）</p>
</li>
<li><p>富国天益价值混合（100020）</p>
</li>
<li><p>汇添富优势精选混合（519008）</p>
</li>
<li><p>易方达中小盘混合（110011）</p>
</li>
<li><p>嘉实增长混合（070002）</p>
</li>
<li><p>兴全合润分级混合（163406）</p>
</li>
<li><p>50ETF（510050）</p>
</li>
<li><p>100ETF（159923）宽基指数</p>
</li>
<li><p>300ETF（510300） 12.24 号 5.108 块入一手</p>
</li>
<li><p>500ETF（510500） 12.24 号 6.98 块买入一手</p>
</li>
<li><p>创业板 ETF（159915）</p>
</li>
<li><p>创业板 50（159949）</p>
</li>
<li><p>科创板（588000）</p>
</li>
<li><p>深红利（159905）</p>
</li>
<li><p>恒生 ETF（159920）</p>
</li>
<li><p>恒生国企 ETF（510900）</p>
</li>
<li><p>中概互联（513050）</p>
</li>
<li><p>海外中国互联网指数（164906）</p>
</li>
<li><p>纳斯达克（513100）</p>
</li>
<li><p>标普 500（513500）</p>
</li>
<li><p>银行 ETF（512800）</p>
</li>
<li><p>非银 ETF（512070）</p>
</li>
<li><p>证券 ETF（512880）</p>
</li>
<li><p>军工龙头（512710）</p>
</li>
<li><p>有色 ETF（512400）</p>
</li>
<li><p>消费 ETF（159928）！！！</p>
</li>
<li><p>计算机 ETF（159998）</p>
</li>
<li><p>全指医药（159938）</p>
</li>
<li><p>基建工程（165525）</p>
</li>
<li><p>煤炭 ETF（515220）</p>
</li>
<li><p>环保 ETF（512580）</p>
</li>
<li><p>传媒 ETF（512980）</p>
</li>
<li><p>科技 ETF（515000）</p>
</li>
<li><p>电子 ETF（159997）</p>
</li>
<li><p>5GETF（515050）</p>
</li>
<li><p>芯片 ETF（512760）</p>
</li>
<li><p>芯片基金（159801）</p>
</li>
<li><p>新能源汽车（160225）</p>
</li>
<li><p>黄金 ETF（518880）</p>
</li>
<li><p>家电 ETF（159996）</p>
</li>
<li><p>可转债 ETF（511380）</p>
</li>
<li><p>房地产 ETF（512220）</p>
</li>
<li><p>深红利 ETF（159905）</p>
</li>
<li><p>光伏 ETF（515790）</p>
</li>
<li><p>食品 ETF（515710） 认购代码（515713）</p>
</li>
<li><p>招商双债（161716）</p>
</li>
<li><p>银华日利（511880）</p>
</li>
</ul>
<h2 id="知知教授"><a href="# 知知教授" class="headerlink" title="知知教授"></a>知知教授</h2><ul>
<li><p>160629 鹏华传媒</p>
</li>
<li><p>161005 富国天惠</p>
</li>
<li><p>163402 兴全趋势</p>
</li>
<li><p>163406 兴全合润</p>
</li>
<li><p>005827 易方达蓝筹</p>
</li>
<li><p>007119 睿远成长</p>
</li>
<li><p>166002 中欧新蓝</p>
</li>
<li><p>519066 汇添富蓝筹</p>
</li>
<li><p>110022 易方达消费</p>
</li>
<li><p>000083 汇添富消费</p>
</li>
<li><p>162605 景顺长城</p>
</li>
<li><p>270002 广发稳健</p>
</li>
<li><p>003095 葛兰</p>
</li>
<li><p>519069 汇添富价值</p>
</li>
<li><p>163415 兴全商业</p>
</li>
<li><p>000751 嘉实新兴</p>
</li>
<li><p>519704 交银先进</p>
</li>
<li><p>110003 易方达</p>
</li>
<li><p>001410 信达</p>
</li>
<li><p>202101 南方</p>
</li>
<li><p>217011 招商</p>
</li>
</ul>
<h3 id="场内基金"><a href="# 场内基金" class="headerlink" title="场内基金"></a>场内基金</h3><ul>
<li>510050 上证 50</li>
<li>510300 沪深 300</li>
<li>510500 中证 500</li>
<li>159949 创业板 50</li>
<li>512880 证券</li>
<li>512000 券商</li>
<li>512800 银行</li>
<li>159928 消费</li>
<li>512690 酒</li>
<li>515700 新能源车</li>
<li>515030 新能源车</li>
<li>159992 创新药</li>
<li>512290 生物医药</li>
<li>512200 房地产</li>
<li>512660 军工</li>
<li>515000 科技</li>
<li>515750 科技 50</li>
<li>159995 芯片</li>
<li>512480 半导体</li>
<li>159939 信息技术</li>
<li>515050 5G</li>
<li>515880 通信</li>
<li>159909 深 TMT</li>
<li>512720 计算机</li>
<li>515210 钢铁</li>
<li>515220 煤炭</li>
<li>159920 恒生</li>
<li>512400 有色金属</li>
<li>515790 光伏</li>
<li>159825 农业</li>
<li>510900 H 股</li>
</ul>
<h3 id="场外基金"><a href="# 场外基金" class="headerlink" title="场外基金"></a>场外基金 </h3><h4 id="指数基金"><a href="# 指数基金" class="headerlink" title="指数基金"></a> 指数基金</h4><ul>
<li>110003 上证 50</li>
<li>110020 易方达沪深 300 太稳了</li>
<li>160119 中证 500 太稳了</li>
<li>161017 500 增强</li>
</ul>
<h4 id="行业基金"><a href="# 行业基金" class="headerlink" title="行业基金"></a>行业基金</h4><ul>
<li>161725 中证白酒</li>
<li>000248 中证消费</li>
<li>501057 中证新能源</li>
<li>161726 医药</li>
<li>001500 医药 100</li>
<li>001594 银行</li>
<li>161721 地产</li>
<li>160629 传媒</li>
<li>501016 证券</li>
</ul>
<h4 id="主动型基金"><a href="# 主动型基金" class="headerlink" title="主动型基金"></a>主动型基金</h4><ul>
<li>270002 广发稳健增长混合 A</li>
<li>163402 兴全趋势投资</li>
<li>163406 兴全合润</li>
<li>161005 富国天惠</li>
<li>163415 兴全商业</li>
<li>005827 易方达蓝筹</li>
<li>006228 中欧医疗</li>
<li>002593 富国美丽</li>
</ul>
<h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><ul>
<li><p>常铝股份：涉及有色、新能源、生物疫苗、特斯拉</p>
</li>
<li><p>景顺长城新兴成长混合</p>
</li>
<li><p>中欧时代先锋股票 A</p>
</li>
<li><p>东方新能源汽车主题混合（400015）12.24 号 买入 500 块</p>
</li>
<li><p>工银瑞信信息产业混合</p>
</li>
<li><p>易方达中小盘混合（110011）</p>
</li>
<li><p>招商中证白酒（161725）</p>
</li>
<li><p>招商国证生物医药（161726）12.24 号 买入 500 块</p>
</li>
<li><p>汇添富创新医药（006113）</p>
</li>
<li><p>大摩健康（002708）</p>
</li>
<li><p>易方达中证海外互联（006327）</p>
</li>
<li><p>富国沪港深（001371）</p>
</li>
</ul>
<h1 id="固收"><a href="# 固收" class="headerlink" title="固收"></a>固收 </h1><h2 id="老钱说钱 -1"><a href="# 老钱说钱 -1" class="headerlink" title="老钱说钱"></a> 老钱说钱</h2><ul>
<li><p>易方达安心（110027）</p>
</li>
<li><p>易方达稳健（110007）</p>
</li>
<li><p>景顺长城双债（000385）</p>
</li>
<li><p>中加纯债（000552）</p>
</li>
<li><p>富国强（100072）</p>
</li>
<li><p>易方达投资（000205）</p>
</li>
<li><p>银华信用（000286）</p>
</li>
<li><p>国富恒瑞（002361）</p>
</li>
<li><p>中银双利（163811）</p>
</li>
<li><p>建信稳定（000875）</p>
</li>
<li><p>广发聚安（001115）</p>
</li>
<li><p>长信改革红利（519971）</p>
</li>
<li><p>金鹰灵活（210010）</p>
</li>
<li><p>中银新回报（000190）</p>
</li>
<li><p>中海积极（000597）</p>
</li>
<li><p>国富新机遇（002087）</p>
</li>
<li><p>中银新机遇（002057）</p>
</li>
<li><p>博时新策略（001522）</p>
</li>
<li><p>银华汇利（001289）</p>
</li>
<li><p>交银多策略（519755）</p>
</li>
<li><p>中银多策略（000572）</p>
</li>
<li><p>鹏华丰融（000345）</p>
</li>
</ul>
<h1 id="持仓"><a href="# 持仓" class="headerlink" title="持仓"></a>持仓 </h1><h2 id="股票 -1"><a href="# 股票 -1" class="headerlink" title="股票"></a> 股票</h2><ul>
<li>立讯精密</li>
</ul>
<h2 id="基金 -1"><a href="# 基金 -1" class="headerlink" title="基金"></a>基金 </h2><h3 id="白酒消费"><a href="# 白酒消费" class="headerlink" title="白酒消费"></a> 白酒消费</h3><p>total: 15800 - 3</p>
<ul>
<li><p>005827 易方达蓝筹 4900 张坤 ***</p>
</li>
<li><p>162605 景顺长城鼎益 3800 刘彦春 ***</p>
</li>
<li><p>159928 消费 ETF 2000</p>
</li>
<li><p>110011 易方达中小盘 1900</p>
</li>
<li><p>260108 景顺长城新兴 x 3200</p>
</li>
<li><p>161725 招商中证白酒 x</p>
</li>
</ul>
<h3 id="医疗医药"><a href="# 医疗医药" class="headerlink" title="医疗医药"></a>医疗医药</h3><p>total: 5700 - 1</p>
<ul>
<li><p>003095 中欧医疗健康 A 5700 葛兰 ***</p>
</li>
<li><p>159938 广发中证全指医药卫生 ETF</p>
</li>
<li><p>001717 工银瑞信前沿医疗 A</p>
</li>
<li><p>006113 汇添富创新医药 x</p>
</li>
<li><p>501009 汇添富中证生物科技 x</p>
</li>
<li><p>161726 招商国证生物医药 x</p>
</li>
</ul>
<h3 id="新能源"><a href="# 新能源" class="headerlink" title="新能源"></a>新能源</h3><p>total: 7100 - 1</p>
<ul>
<li><p>501057 汇添富中证新能源 3600 过蓓蓓</p>
</li>
<li><p>515790 光伏 ETF 1200</p>
</li>
<li><p>160225 国泰国证新能源 x</p>
</li>
<li><p>400015 东方新能源 x 2300</p>
</li>
</ul>
<h3 id="航天军工"><a href="# 航天军工" class="headerlink" title="航天军工"></a>航天军工</h3><ul>
<li>005609 富国军工 x</li>
</ul>
<h3 id="互联网"><a href="# 互联网" class="headerlink" title="互联网"></a>互联网</h3><p>total: 9000 - 2</p>
<ul>
<li><p>001668 汇添富全球</p>
</li>
<li><p>000934 国富大中华 6500 徐成 *** </p>
</li>
<li><p>006327 易方达中证海外互联网 同 513050</p>
</li>
<li><p>164906 交银海外互联网 1000</p>
</li>
<li><p>513100 纳斯达克</p>
</li>
<li><p>513050 中概互联 1500 </p>
</li>
</ul>
<h3 id="宽基指数"><a href="# 宽基指数" class="headerlink" title="宽基指数"></a>宽基指数</h3><p>total: 15400 - 3</p>
<ul>
<li><p>110020 易方达沪深 300ETF 4200 ***</p>
</li>
<li><p>160119 南方中证 500ETF 2700 ***</p>
</li>
<li><p>510300 沪深 300 3500</p>
</li>
<li><p>510500 中证 500 5000</p>
</li>
</ul>
<h3 id="雨露均沾"><a href="# 雨露均沾" class="headerlink" title="雨露均沾"></a>雨露均沾</h3><p>total: 12600 - 2.5</p>
<ul>
<li><p>163406 兴全和润混合 1000 谢治宇 ***</p>
</li>
<li><p>001216 易方达新收益混合 张清华</p>
</li>
<li><p>161005 富国天惠 3700 朱少醒</p>
</li>
<li><p>519732 交银定期支付双息 2800</p>
</li>
<li><p>270002 广发稳健增长 A 1600</p>
</li>
<li><p>233005 大摩强收益</p>
</li>
<li><p>166002 中欧新蓝筹 A 3500 x</p>
</li>
</ul>
<h3 id="半导体 - 芯片"><a href="# 半导体 - 芯片" class="headerlink" title="半导体 - 芯片"></a>半导体 - 芯片</h3><p>total: 4000 - </p>
<ul>
<li><p>004997 广发高端制造 A 4000 孙迪 ***</p>
</li>
<li><p>515000 华宝中证科技龙头 ETF</p>
</li>
<li><p>161903 万家行业优选 x</p>
</li>
<li><p>290011 泰信中小盘 x</p>
</li>
<li><p>519674 银河创新成长混合 x</p>
</li>
<li><p>320007 诺安成长混合 x</p>
</li>
</ul>
<h1 id="持仓 -1"><a href="# 持仓 -1" class="headerlink" title="持仓"></a>持仓</h1><ul>
<li>白酒消费 15800 3</li>
<li>医疗医药 5700 1</li>
<li>新能源 7100 1</li>
<li>互联网 9000 2</li>
<li>宽基指数 15400 3</li>
<li>蓝筹股 12600 2.5</li>
<li>半导体 4000 1</li>
</ul>
<p>蓝筹 倾斜 医疗</p>
<h1 id="选基"><a href="# 选基" class="headerlink" title="选基"></a>选基 </h1><p> 过去几年债市经历过一些至暗时刻，比如：</p>
<p>2015 年股灾 2016 年初熔断年底债灾 2018 年熊市 2020 年一季度疫情暴跌 20205 月份以后的债市调整</p>
<p>如果你想买的基金在以上特殊阶段都实现了正收益或者超小回撤，都是加分项。</p>
<p>如果没实现，可以进一步剔除。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/31/Decision/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="cloud">
      <meta itemprop="description" content="Less is more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cloud's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/31/Decision/" class="post-title-link" itemprop="url">Decision</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-31 23:41:13" itemprop="dateCreated datePublished" datetime="2020-12-31T23:41:13+08:00">2020-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-24 14:47:37" itemprop="dateModified" datetime="2021-03-24T14:47:37+08:00">2021-03-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Other/" itemprop="url" rel="index"><span itemprop="name">Other</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>32k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>30 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="如何形成决策"><a href="# 如何形成决策" class="headerlink" title="如何形成决策"></a>如何形成决策 </h1><p> 大家好，我是曹政，这是 caoz 的小密圈 知识星球的第三次年终福利课。那么基于读者的反馈，我们一起探讨一下关于人生决策的话题。</p>
<p>先分享个网友的犀利观点，18 岁的年轻人对社会一无所知，却要做出影响人生的重大决策，选择大学和专业。其实我们人生的很多关键决策，都是在一无所知和随心所欲的情况下做出的。这很现实，也很无奈，我们没办法改变过去，唯一能做的就是，让自己未来的决策，变得更理性，更有价值一些。</p>
<p>今天反思我的人生决策，很多星球读者也让我复盘自己的关键决策，坦白说，很多决策其实是很盲目的。</p>
<p>1993 年高考选择清华是跟家长赌气，不愿意留在天津，代价是没办法选择我喜欢的专业。1998 年毕业择业，其实没太好的选择，选择进入互联网行业，但是并没有合适的企业，投了很多软件公司和通讯公司的简历都没有着落，最后去广州其实也是无奈之举，当时手里只有这一个 offer，所以就算是名校毕业，哪怕是 90 年代的名校毕业，也不是想去哪里就去哪里的。</p>
<p>1999 年选择离职创业，我觉得方向没有大问题，但自己在产品意识和业务执行上还是有很大的问题。2004 年选择百度其实是意外，因为雅虎当时没要我。2009 年选择 4399 是我自己下的决心，事后来看，不能说结果不好，但未必是当时的最佳选择。2013 年选择去新加坡移居是基于家庭原因，代价是牺牲了事业发展的空间。</p>
<p>一切选择都是有代价的，你不可能既要，又要。我们的人生不是爽文，不可能开着挂一路平推，总有很多不如意，这是常态，没有人可以例外。即便是全民爸爸马云，这不也不能随心所欲不是么。</p>
<p>那么人生的重大决策，除了工作选择，其实还有买房的选择，实话说，这方面我的判断也并不好，2002 年买房的选择是正确的，但是地段的判断是彻底错误的。这里说来话长，就不展开了。后来几次买房的选择都有问题，卖房的时机也有问题，移民新加坡后，厦门市中心的房产卖在了暴涨的前夜，所以我不敢给别人做任何关于房产投资的分析。</p>
<p>这里插播一句，关于房产投资，一会嘉宾分享会提及。</p>
<p>当然，还有股票投资的选择，也是教训累累。上天明明给了我无数个财务自由的机会，却都被我浪费掉了。</p>
<p>所以这次，我们来做人生决策的课程，坦白说，并不是因为我一直正确，而是因为我能理解，关键决策对人生的影响和意义，并且愿意跟大家分享其中的成败得失。</p>
<h2 id="信息的获取和筛选"><a href="# 信息的获取和筛选" class="headerlink" title="信息的获取和筛选"></a>信息的获取和筛选 </h2><p> 有效决策的基础，是掌握充分的信息。</p>
<p>比如，你选择大学和专业，你应该对学校的就业情况，学术排名，校园环境，教师水平，以及学科的发展有尽可能多的认识。并且了解一些学长们的发展路线，以及校友的能量和社会分布。</p>
<p>比如，你选择一份工作，尽可能做背景调查，了解企业的发展趋势，口碑，老板的信用和能力，你直接上司的背景和人品，等等等等。</p>
<p>比如，你选择一份房产，城市的长远规划，人口的增长趋势，当地产业环境，都应该有足够的认识。</p>
<p>再比如，你选择开个小店，当地客流，人群分布，竞争对手情况，行业的成本和相关风险，要尽可能了解清楚，自己要会算账，而不是轻信一些中介的宣传。</p>
<p>在获取信息的过程中，也要有筛选能力，什么是官方信息，你要核实，什么是虚假信息，你要甄别。我看到真的有读者陷入杀猪盘，负债累累。其实挺可怜的，但复盘一下，甄别信息的能力真的是最大的问题。</p>
<p>信息的获取和筛选，首先是搜索能力。</p>
<p>搜索能力往往是被低估的一项基本素质，很多人很拽，说不能用百度，要用谷歌，其实百度也好，谷歌也好，擅长搜索的人，各取所需，不擅长搜索的人，用什么都不灵。</p>
<p>第一，你要知道关键词的不同组合，来追寻你认为有意义的信息。有些时候要多尝试，试一两个词找不到就放弃是很常见的行为。而且现在随着推荐系统越来越强大，很多人懒得去搜索，只靠平台投喂。<br><b>有价值的信息，要靠主动搜索，不要靠投喂！</b></p>
<p>第二，你要对不同关键词有好奇心，搜索引擎往往有各种提示词，有热榜。</p>
<p>多说一句，百度热榜已经废了，多看看第三方数据榜单（爱站，5118，新榜，清博等等）</p>
<p>第三，你至少要知道什么是自然结果，什么是推广结果，以及什么是官方网站，什么是山寨网站。确实有些山寨网站迷惑性很高，但你至少应该知道一些比对方式，特别是政府网站或教育系统网站的域名后缀。</p>
<p>第四，适度存疑，不要轻信别人的建议和推荐，要做适当的求证，多方信息的比对。</p>
<p>那么这里重复强调一下，你做出关键决策的时候，务必要自己主动搜索关键信息，不要指望别人把所有你需要的信息都投喂给你，如果你做出决策的依据全部是别人投喂给你的信息，我必须说，这个决策往往非常危险，如果是直系亲属，风险来自于他们的认知能力，如果不是，那么风险简直就太大了。</p>
<p>别人投喂给你的信息未必都是错的，都是坏的，比如某些自媒体的信息，我总不能说我的信息都是坏的，但如果你要基于我的信息做出决策，我建议你还是自己去主动搜索核对一下，而不是单凭我一面之词。坦白说，我不会为你的决策后果负责，你要自己为自己的决策负责。</p>
<h2 id="底层逻辑能力"><a href="# 底层逻辑能力" class="headerlink" title="底层逻辑能力"></a>底层逻辑能力 </h2><p> 俞军老师在 2000 年，新浪论坛上的帖子，和人论战，无限看好 google，对微软，雅虎的搜索计划不以为然，是基于对搜索引擎的底层逻辑判断，他很清楚，雅虎和微软，都没有真正理解搜索引擎的价值和目标，仅仅当作是门户计划锦上添花的组成部分，而搜索引擎，作为人类知识获取能力的提升方式，是足以颠覆当时的互联网生态的存在。</p>
<p>这是俞军老师当年职场规划的决策基础。</p>
<p>我 1998 年大学毕业，虽然择业上不是很顺利，但是我认为互联网是改变人类的一场革命，并坚持以此为职业目标，就这一点而言，当时的判断是极为准确的。今天看上去这个判断似乎顺理成章，但是在上个世纪末，网民只有几百万的时候，这样的认知其实挺颠覆的。</p>
<p>2010 年左右，安卓刚刚问世，我们在厦门就做出安卓智能手机将横扫市场的判断，当时很多互联网巨头还认为智能手机不是刚需，功能机将长期存在，而且认为塞班的优势不可动摇。</p>
<p>底层逻辑的基础是什么？</p>
<p>看技术，产品的底层价值，而不是仅仅看当前的市场表现。</p>
<p>即时通讯改变了人类的社交方式，造就了腾讯这样的巨头。<br>搜索引擎改变了人类的知识获取能力，造就了谷歌和百度。<br>电子商务改变了人类的购物方式，造就了阿里，京东，拼多多等等。<br>移动互联网的普及，不使用智能手机的用户会变成孤岛，其习惯将无法维系，这是 2010 年的底层逻辑。</p>
<p>但是在很多年前，很多人看不清，坦白说，我自己都看不清，至少 2000 年左右，我完全没看清腾讯和阿里的价值，否则我干嘛不去投效呢，那时候入职门槛又不高对不对。</p>
<p>底层逻辑还包括一些基本的判断准则</p>
<p>比如，我们不是天选之子，天上不会掉馅饼。<br>比如，尊重科学，没有永动机，没有水变油。<br>尊重科学还要多说一下，如果有革命性的科学成果，首先应该出现在最专业的科学期刊和杂志上，划时代的成果应该是重磅新闻，而不是只出现在某些地方媒体的广告频道里。</p>
<p>比如说，有人告诉你他们的 AI 技术超越了阿尔法狗，那你要知道，阿尔法狗可是刷了两次 nature 封面的技术成果，超越阿法狗，这种成就是值一个图灵奖的，如果连一篇 sci 都没有，那真的是半个字都不能信的。</p>
<p>比如，有人告诉你他发现了某些现代医学尚未解决的绝症的治愈手段，这是诺奖级的成果，没理由不刷爆主流媒体。而不需要用什么民族国粹之类的借口掩饰自己。</p>
<p>比如，有人告诉你，他用量子力学做成了什么牛逼的芯片产品，通常这也是国家级科技金奖的成就，新华社、人民网什么的总应该出来说两句的。如果是军用产品，那逻辑上你就不该在官方媒体通报前知道。按照这个逻辑去理解，这些骗术很容易被甄别。</p>
<p>但如果你还相信那些深山里藏着绝世武功，一出山就惊天地泣鬼神，这就没辙了。</p>
<p>底层逻辑通透，辅之信息甄别，筛选的能力，你对世界的认知就会上升一个台阶，虽然不能说你一定可以做出正确的决策，但一定能让你避免很多离谱的决策。</p>
<p>俞军老师为什么一直灌输产品经理要看经济学基础，其实就是提升底层逻辑能力。经济学理论中，博弈理论又是非常核心的，那么我们在做很多决策的时候，很多都是在进行博弈决策。</p>
<p>坦白说，现在即便很多高学历，高知识背景的人，往往也存在逻辑混乱，认知糊涂的情况。我必须强调一点，极端认知是逻辑的最大敌人，而舆论环境又特别喜欢煽动极端情绪。比如劳资关系，如果你百分百站在劳工权益这边，你觉得自己在维护劳工权益，但最终其实适得其反，资本是全球流动的，最终工作机会会被转移，劳工权益其实是受到损害的。但很多人真的看不到这一点。</p>
<p>看看博弈理论的书籍，学一些经济学的基础知识，试图理解所有革新产品的核心价值，可以把这些作为关键决策的基础。</p>
<p>tips：经济学的书籍和博弈论有关的书籍，认真研读。</p>
<h2 id="通识人性"><a href="# 通识人性" class="headerlink" title="通识人性"></a>通识人性 </h2><p> 其实卡耐基的那套鸡汤丛书《人性的优点》，《人性的弱点》，很多是讲人性的，有时候回顾一下，还是有意义的。</p>
<p>有些讲谈判的书籍也是。谈判的目标是什么，是获得别人对你的支持和认可，而不是强调谁对谁错。我们职场，创业，很多时候都需要谈判。如果你现在创业，面对投资人，你认为你的方案无懈可击，而投资人却觉得这个领域没有机会，你非要纠正投资人的认知，这恐怕是没戏的，但有些创业者可以跨越认知差异，让投资人看到自己闪光的一面，让投资人觉得人才难得，从而改变主意进行投资，为什么能做到？</p>
<p>人性是什么，趋利避害是人性，自我保护是人性，自我高估也是人性。贪婪是人性，为自己的贪婪找借口也是人性。</p>
<p>很多时候，你觉得自己是对的，你做出了正确的判断和决策，但为什么别人不相信你，为什么别人不支持你，因为你没有站在别人角度思考，没有体会别人的心态。</p>
<p>我们试图理解一些逻辑是否成立，试图理解一些计划是否可行的时候，往往需要通识人性，比如说，你应该理解，信任是有成本的，是需要逐步建立的，无论是初入职场，还是服务你的用户，你应该循序渐进让别人信任你，给你机会，而不是试图一步到位改变别人对你的认识。</p>
<p>有些创业者，拿出一套创业方案，仔细一看，产品设想完全是异想天开，为什么，因为没有迎合人性，这时候，拉你参与创业，你需要决策了，这就是考验你判断力的时候了，你如果通识人性，很容易看到这样的问题，并且及早避开这样的项目。</p>
<p>职场内也是，你希望得到晋升，你希望获得认可，你不但要有业绩，也要通识人性，让你的同事支持你，让其他部门支持你，而不是光强调自己多优秀，很多人不知不觉得罪了同事，自己浑然不知，一些关键晋升的机会就被一些七七八八的负面评价阻碍了，还觉得都是别人的错。</p>
<p>我之前讲过，感恩不只是美德，为什么这么说，因为感恩往往能够更好的获得别人的信任，从而在某个关键时刻获得支持，这么说其实挺功利的，好像感恩都是有目的的，其实你养成这个习惯，真的是受益无穷。</p>
<p>我坦白说，我见过不少创业者，有些人在我心目中有坏印象，但我也不好意思公开说。那我随便举几个例子，只有需要我帮助的时候才联系我，平时从来不打招呼的，帮过忙也没什么表示的，这是一种。未经我许可把我的聊天记录发出去的，这是一种。自来熟特别不见外的，这是一种。餐桌上当着陌生妹子荤段子不停的，这是一种。当然，不同的人可能有不同的好恶，但是很多人，都是不知不觉在别人心目中留下差评，而自己浑然不觉。</p>
<p>我其实也不例外，我相信，我也没少在别人心目中留下差评。以前说少不更事，现在其实可能也没好到哪里去。</p>
<p>我最近还在跟空降的人才聊天提到，虽然确实有很多施展才华的空间，但不要一上来想着做出各种改变，先要吸收，看看数据，和团队多做沟通，理解不同层级，不同岗位的人的诉求、目标和他们的担忧，梳理清楚，然后看看怎样求同存异，做出合适的计划，循序渐进，建立信任基础，再逐步推进自己的目标。一上来就谈很多计划，第一，都没有认真聆听别人的想法和顾虑，很多计划可能本身就有问题。第二，没有信任基础，很多事情很难得到团队支持。</p>
<p>这是有过程的。</p>
<p>通识人性，也可以让你更好的判断别人给你信息，对你支持的真伪，动机和目标。通常，你的决策可能来自于其他人的建议，其他人的鼓动，或者参考其他人的经历。那么，你要能理解这个其他人，到底有几分可信。</p>
<p>一个常见的问题是，那些真正好心的人，往往不擅长话术和套路，提出的意见和建议往往令人心生憎恶。而那些擅长收割的人，却总能显露出一切都是为了你好的诚意来。所有成功的骗子，都通识人性，只有通识人性，才能完成收割。所以，如果你能通识人性，也可以少踩很多这样的坑。</p>
<p>看看心理学的专著。比如《这才是心理学》。</p>
<p>感觉还是有点单薄，说说人性的一些案例吧。</p>
<p>某些骗子会说，有个政府主持的慈善事业，需要你的资金，但会提供非常高的回报，而且如果你带动更多人进来，还会有下线佣金。这样的骗局前几年非常多。</p>
<p>首先，强调政府主持，获取信任。用回报满足人们的贪婪心理，然后用慈善给这些人的贪婪一个借口，贪婪是需要借口的，这就是人性的典型特征。你让这些人捐款给慈善事业，他们是不肯的，你说有高回报的慈善基金，他们满足了贪婪的底层欲望，又自我感觉非常有爱心。</p>
<p>自我保护也是一种人性，如果你当众批评某个人，哪怕你是对的，别人第一感也是反驳你，或者强调自己的正确。但如果你私下、用相对委婉的方式提出对方的某个问题，很多人还是愿意接受的，甚至感谢你。当然，我们说坦诚是沟通成本最低的方式，但这也因人而异，因事而异。阿里前几年的那种破冰文化，坦白说我是无法接受的。</p>
<p>自我高估更是人性了，我们做个思想实验，假如一个项目顺利完成，让每个成员都写出自己在项目中的贡献比重，然后汇总算算看，我相信一定是大幅度超过 100% 的。有兴趣的项目负责人可以试试看，友情提醒，如果公开讨论，出现撕逼状况，我概不负责。</p>
<p>人性还有选择性记忆和选择性遗忘，很多人会选择性记忆自己历史上的高光时刻和准确预见，选择性遗忘一些愚蠢的判断和预测，所以他们总觉得自己的才华被埋没。</p>
<p>通识人性，不但可以增强你的判断能力，还能增强你把握机会的能力。很多时候，你生命中的贵人就在不经意间出现在你的身边，如果你能通识人性，把握这种机会可能就会相对容易。</p>
<p>比如关键面试，比如面对投资人，比如重要的商务合作谈判，比如面对关键客户，比如职场晋升的考核答辩，比如与自己心仪异性的一个重要的约会，等等。</p>
<p>怎样才能被人信任，怎样才能被人喜欢，怎样才能让人信服。首先你要能尽可能的理解对方。</p>
<p>营销高手刀姐曾经写过她怎么钓到她老公的，首先她一直观察男神的朋友圈，了解对方的喜好，然后设置了一个专门分组，投其所好的发布一些专门给男神看的动态信息，很快对方就主动找她聊天，建立了共同话题。</p>
<p>课程设计到这里的时候，我有点觉得不好把握，从某种意义来说，理解人性，可以更好的让我们避坑，但也可以用来收割其他人。屠龙技在手，你要做英雄，还是恶龙，只能你自己斟酌。确实，很多诈骗犯，杀猪盘都是通透人性的大师。</p>
<p>很多资金盘游戏是怎么逐步建立用户信任的，他们可能先给你一些小的好处，一步步让你建立信任，产生依赖，最后来一笔大的。那么在职场需要你跟同事交流的时候，为什么他们能做到，你就做不到了呢。</p>
<h2 id="自我认知"><a href="# 自我认知" class="headerlink" title="自我认知"></a>自我认知 </h2><p> 通识人性，有助于我们更好的了解他人，更好的与他人合作，或者更好的理解商业模式。</p>
<p>但很多时候，我们分析别人容易，分析自己难。所谓当局者迷，旁观者清。所以，前面提到的一些人性特征，不但要用来理解别人，更要用来剖析自己，坦白说，剖析自己是个有点痛苦的过程，我们会不得不面对自己的猥琐，怯懦，贪婪，乃至放荡。不得不揭下自我保护的那些借口，直面自己的底层认知，原来自己那么多冠冕堂皇的理由，其实不过是掩盖自己的贪婪和私欲。</p>
<p>说个相对容易的，至少要知道自己擅长什么，不擅长什么；知道自己热爱什么，不热爱什么；最起码，要知道自己能忍受什么，不能忍受什么。</p>
<p>很多很多人的生活和职场是拧巴的，因为长辈的劝导，因为身边亲朋好友的期许，活成别人所期望的样子，但内心纠结痛苦，挣扎烦恼。</p>
<p>所谓跳出舒适区，其实是为了进入更为广阔深远的舒适区。所谓延迟满足，延迟是过程，满足是目标。</p>
<p>当然，我们不可能完全随心所欲选择自己所期望的生活，我自己也做不到，但这个世界还是给了我们很多选择权的，在很多时候，我们有选择权的时候，我们忘了自己想要什么。</p>
<p>很多人咨询求职建议的时候，这个好不好，那个好不好，却没问问自己，你适合做什么，你希望获得什么，可能为了达成目标，也存在一个不那么愉快的过程，但你的忍耐底线在哪里，以及你的理想彼岸在何方，这些只有你自己知道，别人真的不知道。</p>
<p>有很多人说，公务员好不好，看你自己，喜欢不喜欢那种环境，愿意不愿意进入那样的氛围，你喜欢，你觉得那就是你理想的所在，我干嘛要拦着你呢；你不喜欢，你父母逼你去，那我告诉你，你应该有自己的选择。</p>
<p>一个人成长过程中，可能需要强迫自己做出某些改变，需要让自己更好的适应社会环境，需要增强自己一些不擅长的能力，这确实是有必要的，但这个是过程，是手段，不是目标；而目标，你要明确，是你的目标，不是你家人的目标，不是你父母的目标，你要知道自己的目标是什么。</p>
<p>运动员，勤奋练习，是为了赢得比赛，挑战自己的极限。<br>一个产品经理，磨练沟通技巧，是为了达成伟大的产品梦想。<br>一个技术专家，刷算法题，是为了挑战复杂的技术场景。</p>
<p>过程可能有些痛苦，有些不愉快，但最终挑战胜利的感觉是很好的。很多人努力奋斗，就是为了挑战一些目标，无论是技术、产品、还是身体机能。我说过，我读书的时候，做数学题是津津有味的，因为挑战成功的感觉很好，就跟玩游戏通关的感觉是一样的。</p>
<p>你要找到自己人生的挑战目标，基于这个目标，可以忍受一些过程中的不愉快，但最终还是要追求一个愉快的通关体验。当你很清楚自己的长远目标的时候，你对短期困境的忍耐力就会坚韧很多，持续前进的动力才会充足。</p>
<p>自我认知过程中，高估自己和低估自己都会出现，有的人倾向于高估自己，有的人倾向于低估自己。所以很早我有句话，王兴也说过类似的，现在也是适用的，别太把自己当回事，也别不把自己当回事。你可能不是天之骄子，但也不是一无是处。你需要的是，尽快确认自己的定位。</p>
<p>一些简单的自我认知的测试。</p>
<p>你上一次认为自己傻逼是什么时候，捡诛心的事情说，丢手机啦，忘了跟班主任打招呼啊，这种不算。如果你不记得自己上一次傻逼的时候，那么傻逼第一定律，“从来不认为自己傻逼的人，往往是不可救药的大傻逼”，就符合你了。</p>
<p>你觉得自己的天赋是什么，以及在你的天赋范围内，所取得的最辉煌的成就是什么？如果在你自认为的天赋领域内做不到轻松秒杀 98% 的同龄人，你的这个天赋可能有点水。</p>
<p>你最近的接受别人批评是什么时候，以及是否认为自己已经真的接受并改正了，那种“老总，我可要批评您，您太不注意保重身体了。”的批评不算。</p>
<p>这些测试，可以有助于认清自己是否存在认知障碍，过于高估自己，过于相信自己。</p>
<p>我其实很多年都没找到自我定位，我一直说自己杂而不精，确实我的职场经历比较奇葩，做过产品，做过研发，创业的时候啥都做，做过数据分析，做过 IT 售前，还写过自媒体。从领域来说，信息安全，搜索引擎，企业办公系统，电信计费营帐系统，呼叫中心，广告系统，商业分析系统，游戏社区，都有接触。其实很长时间，我都不知道自己适合做什么，也不知道自己职场目标是什么，这是真的。我没有俞军老师如此明确的追求和目标，我只是明确了互联网是个好的方向，但具体的领域，和我具体的能力，我是含糊不清的，而且很长时间，甚至说我在职场黄金期的时候，我还低估了自己所擅长的能力，这也是我职场比较吃亏的地方。</p>
<p>看到很多读者留言看不清自己的目标，其实我也不例外的</p>
<p>今天，有些话我敢说了，我的数据感超强，此外我的整体逻辑感很好，遇到一些具体技术问题，我的思维方式可以有助于快速定位问题和寻求解决途径，虽然我的算法能力不强，编程水平也一般，但分析问题和定位问题的能力，远远超过我编程体现出来的技术能力。当然，这也是十年前的表现，现在很惭愧，新的技术方案和技术路线已经看不懂了，更不要提分析问题、定位问题能力了。</p>
<p>人无完人，每个人都有自己擅长的地方，也有自己不擅长的地方，找到自己的优势，尽可能显露出来，在做关键决策的时候，尽可能选择可以显露自己优势，又能符合自己长远目标的路线。</p>
<p>前段时间和老板们谈人才话题，我就反驳了一些老板的观点，是不是公司所有问题都是人才不足的问题，我不这么认为，人才不足的问题往往是管理问题，以前 4399 招聘了很多低薪低门槛低背景的员工，这其中就有一些人，体现出了超强的成长性，成为业内的顶尖人才。我私下可以说出好几个名字，就不公开说了。</p>
<p>坦白说，他们其实短板也挺多的，低薪低门槛低背景的人，想想就知道，一开始看上去都很平庸，但如果能用其所长，给予一定的空间，发挥他们优势能力，还是有不少人可以快速成长，快速突破自己。（当然，能做到的也只是很少一部分，不可能每个人都成为顶尖人才）。</p>
<p>为什么说这个话题，回到今天的话题，我们有些背景不强的年轻人，其实也是有机会成长为顶尖人才的，但第一你要自己知道自己的优势在哪里，要想办法显露出来；第二，确实也要寻找给你空间，给你机会的舞台，也要有合适的管理者能带你成长，给你一些辅导和支持，有些时候可能确实有运气的成分，但不要轻易的放弃自己的成长可能性。不要过于低估自己的潜力。在很多领域，成为行业高端人才，未必需要强大的天赋。</p>
<p>我说真的，你要成为 TK 教主那样的顶尖人才，确实需要天赋，但我认为大部分年薪百万的职位都不太需要多高的天赋。</p>
<p>所以自我认知定位是关键决策很重要的部分，我知道这里读者有很多疑惑，怎样才能找到自己的定位，我也没有天眼，能一眼看出每个人的天赋和优势，你们需要自己不断地问自己这个问题，不断地通过其他人的反馈了解自己，不断地反思和复盘，这是个长期的事情，没有一步到位的手段。</p>
<p>关于自我认知，还有很重要的一点要说，就是量力而行。一定要量力而行，比如创业，你有什么资源，有什么强处，有什么不足，有谁愿意做你的合伙人，要做自己能掌控的事情，你说我还缺个投资人，缺个工程师，缺个什么什么，这事多半不行。</p>
<p>Q：我个人理解是如果你的生活目标特别明确，比如说这件事是你这辈子必须要做的，但它可能和你的工作关系不大，工作只是你达成这个目标的手段（挣钱）；有些人可能找到了自己热爱的工作，对他来说工作就像游戏通关，能够不断挑战自我，可能纯银老师就是这样的人</p>
<p>A：纯银老师工作中展现的那种控制和表达的欲望太强了，真心佩服。</p>
<p>比如你答应别人做什么事情，能不能做到，能不能有把握，别为了面子什么都答应，做不到的就说做不到的，可以试试的说自己尽力去试，不要轻易承诺，一个靠谱的人是承诺的事情能做到，不是什么都能承诺。</p>
<p>人们往往会因为面子，因为想要在某些人面前做出表现，而做出超出自己能力的承诺，这是很多很多灾难决策产生的原因。我希望我的读者尽力避免这一点。</p>
<h2 id="机会成本及风险评估"><a href="# 机会成本及风险评估" class="headerlink" title="机会成本及风险评估"></a>机会成本及风险评估 </h2><p> 先回顾一下，做关键决策的时候，我们要掌握充分的信息，并具有一定的筛选手段；要有底层逻辑能力，才能把信息价值最大化；要通晓人性，才能获得足够的社交支持，以及更好的理解产品及商业行为。要有足够的自我认知，能扬长避短发挥自己的价值，并确定和追寻自己的长远目标。</p>
<p>这些够了么，还不够，还差一点，就是要有成本及风险评估的意识。</p>
<p>回到开始，当我们做关键决策的时候，必须意识到，很多事情是不能兼得的，你不能既要，又要。这时候，你要有一定的评估，比如你放弃了一个优渥薪酬的职位，去加入一个有前景的创业公司，你要知道你的机会成本是多少。</p>
<p>虽然很多成功案例告诉我们，为了追求梦想，可以不惜一切代价，但我们所能看到的，往往是幸存者偏差。</p>
<p>什么是机会成本，当你面临 A、B 两个选择的时候，你选择 B 的预期收益，就是你选择 A 的机会成本。</p>
<p>自己能承担的风险底线是多少，为了追求某种回报，自己付出的机会成本是多少，这个帐算清楚。</p>
<p>那么另一个就是我重复无数遍的，真的决定去尝试风险性的决策，务必牢记止损原则。此外，我旧文提过多次的，警惕那些让你 ALL In 的人。</p>
<p>风险评估。</p>
<p>政策及法规风险肯定是第一位的，很多创业者死于政策及法规风险，项目死掉的，算还好的，人进去的，也不少。</p>
<p>那么项目可行性风险，如何规避一厢情愿，异想天开，需要通识人性，需要自我认知，也需要对信息的充分获取筛选和底层逻辑判断。</p>
<p>信用风险，第一，你是否会因为某个决策失去信用，这个要理解信用成本，往往比你以为的要高。第二，你的预期回报是否存在信用风险，合伙人或老板的信用口碑如何。第三，一些关键资源，关键合作伙伴是否存在信用风险，也是要评估的，比如你特别依赖某个供应商，或者特别依赖某个技术专家，但这个依赖方是否可能违约，也是要考虑的。</p>
<p>市场环境风险，特别涉及投资领域，这个特别特别重要。我最近也在某个投资项目上亏了一些钱，也是遇到了市场环境的急剧恶化，不过还好，投资本身就是有风险预期的，反正亏的也不多，看在我还在努力赚钱的份上，老婆都没骂我。</p>
<p>大体如此，无论是选择就业，选择投资，还是选择一份职场工作，都会存在一定的风险。但是不是绝对风险规避，我觉得没必要，一定程度上，我们追求某些高回报，总要担当一些风险。以前说解放战争的杰出将领，60% 的胜利可能性，就坚决开战了，不可能追求百分百的确定性。</p>
<p>我们的人生不止一次选择，我们的选择也不止一个结果，当我们发现存在一定的机会，具有一定的几率，只要这个几率大于某个预期值，是可以大胆去博的，谨小慎微有助于避坑，却无助于你的身价和资产增值。</p>
<p>评估风险，不代表害怕风险，或者一昧的躲避风险，正确的认识风险，但依然要有坚决果断的决心。</p>
<p>我最近几年胆子确实比较小，其实我早些年投资还是比较激进的，教训很多，失误很多，但现在毕竟也不算穷对不对。只要不 ALL In，手里一直有筹码，凡事总有周旋的余地。</p>
<p>那么关于 p2p 理财，特别是懒投资，有不少读者指责我当年替他站过台，这个我觉得还是可以复盘一下当年的投资决策。</p>
<p>第一，当年真的没有接过任何 p2p 理财广告，真的没有拿过一分钱佣金，我提及这个产品是真的我在学习互联网金融，并且作为案例来分享，但没有作为投资建议来讲。你们随便翻旧文，真的没有作为投资建议说过。</p>
<p>坦白说，我虽然怼了很多 p2p 平台，但确实没想到 p2p 金融整个行业会团灭。如果你说这个现状打我脸了，我认，但你要说我为了自身利益介绍有问题的平台给读者，我真不认。</p>
<p>第二，早期其实我家里也买了懒投资理财，真的买了，但我很保守，在现金流中严格控制了比例。</p>
<p>第三，2017 年中一些平台开始暴雷，我立即决定赎回撤出，事实上我没有任何损失，那么这里问题来了，为什么没有通知我的读者，我根本不知道懒投资的运营状况，我一直在东南亚居住，根本不在国内，我只是觉得行业形势严峻，自己保守而已，我怎么能没有任何证据就随便说懒投资有问题呢，再说，我也没推销过人家理财，我为啥突然无缘无故要出来砸人家场子呢。</p>
<p>第四，我最早提及懒投资的时候，讲的是保理模式，上市公司的采购合同担保，资金相对安全。但如果你们细心跟踪懒投资的发展，到后面其实他们很多借贷已经不是保理模式了，涉及一定程度的风险投资了；而且乐视和暴风出事后，就算是上市公司的采购合同也不安全了，这是很明面的事情。</p>
<p>我真不是给自己找借口，2015 年全互联网鼓吹 p2p 金融的时候，我已经说过行业风险，但确实无法预判整个行业的崩溃，但 2017 年中，我自己是不敢冒这个风险，今天讲这个案例，我觉得这就是投资决策的风险评估和机会成本。你能多赚多少钱呢，而行业风险是多大呢，懒投资好歹在行业内相对好一些，至少行业风险展现的时候，是可以有机会撤出的。</p>
<p>投资决策，特别是大金额投资决策，就是一个关键决策，我们今天回顾这个案例，也是因为这是很有代表性的案例，你做出这样的关键决策，对行业信息是否保持足够的敏锐呢，那些暴雷信息和各种风险提示是否一直有关注呢；你是否具有底层逻辑，能够理解超高利率 p2p 理财的不可持续性呢；你是否具有风险评估能力，在行业风险相对清晰的时候，快速决断呢。</p>
<p>为什么很多人无法做到快速决断呢，很多人习惯惯性思维，简单认为未来是过去的延续，对市场变化和风险视而不见。还有就是盲从权威，跟随某个所谓的领域大牛，专家学者决策。我不说别人，我在金融领域几次非常惨重的投资失误，都是因为盲从权威造成的。我随便说一个，2008 年金融危机的时候，看国内金融专家直播，说房利美、房地美不可能倒，全美国的房贷都是他们放的，美国政府一定会救的。信以为真，我懂这个市场么，我以为能抄底，结果，18 层地狱有没有，到今天都恢复不过来有没有。你们看看房利美，房地美在金融危机前后的股价和市值变化，就知道我说的是什么了。盲从权威，进入自己不懂的领域，放纵贪婪，最后自食恶果。</p>
<p>而很多在 p2p 损失惨重的人，连盲从权威都不是，根本就是信了一些所谓自媒体大 V 的广告，就重仓了，典型的如占豪这样的爱国大 V，当年接各种 p2p 广告佣金拿到手软有没有，不知道坑死多少人。你自己的底层逻辑在哪里，自己的风险认知在哪里。</p>
<p>今天要分享的大体如此。</p>
<p>关键决策的构成，第一，足够充分的信息和数据，以及筛选能力；第二，底层逻辑能力，从而更好的理解信息的价值。第三，通识人性，第四，自我认知，第五，机会成本和风险评估。</p>
<p>真的真的不要试图在自己不擅长的领域下重注，做风险投资。真的不要怕失去机会，这世界上有太多的机会明白么，只去抓取自己能把握的，就足够好了！</p>
<p>我还可以承认一件事，我以前也炒过币，我一直没说，我当年炒币还赚了二十多万人民币好像。就买了点 EOS，30 多人民币买的，100 多人民币卖的，不到两个月时间赚了 2 倍。以前不分享是因为我不觉得这事有啥可分享的，而且我也不认为这种决策可以复制。</p>
<p>那么今天复盘一下决策逻辑</p>
<p>第一，下注的可控性，确实这是一种赌博，但我当时投入的资金是十多万，对我而言，输光了，最多被老婆说几句，对生活没啥大影响。这是我的底气所在。我绝不可能用影响生活水平的现金去做这样的风险决策。</p>
<p>第二，信息面，我当时恰好知道一些信息，温州一些老板重资在抢所谓的投票权，也就是产币权，我分析了一下这个底层逻辑，骨子里不就是竞价排名么，这个我熟啊。抢筹游戏，一定会带来一波疯涨。</p>
<p>第三，我的人性认知告诉我，币值踩踏一定会在公网上线前发生。那些抢筹者只图获利，所谓信仰都是借口。</p>
<p>第四，基于自我认知，币圈久赌必输，不会次次好运，所以此后再也不碰。</p>
<p>结果，完全符合预期，EOS 从飙升到踩踏，直到现在都没恢复到当时的高点。</p>
<p>我 2018 年 5 月写了一篇文章提及此事，叫做“竞价排名永不倒”，当时踩踏还没有发生，被我准确预言，有兴趣的可以搜搜看。</p>
<p>这时我投资方面少有的正确决策，但是依然存在极大的运气成分和幸存者偏差在里面。那么今天复盘这个逻辑，也是希望大家能理解，一个高风险投资决策的过程，大概应该是怎样的。</p>
<p>今天作业，你们人生中的错误决策是哪些，因为什么原因，基于以上的几项因素，可以各自反思一下，其实错误决策也很常见，下一课我们一起讨论，如何复盘，纠正决策，以及我们一起分析一下常见的错误决策是怎么产生的。</p>
<h2 id="嘉宾时刻"><a href="# 嘉宾时刻" class="headerlink" title="嘉宾时刻"></a>嘉宾时刻</h2><p>《粥左罗：关键决策中的“可信人”和“可信度加权”》</p>
<p>星友们好，我是粥左罗，听闻江湖有“近曹大者富”一说，我跟曹大 2018 年就吃过饭，但我觉得吃饭合影都不算近曹大，一起搞过事情才叫近，所以 2021 我要暴富了。非常感谢曹政老师邀请我参与这次年终福利课，我知道这个福利课是曹大每年星球的重磅活动，能被邀请我很荣幸，这是曹大对我的信任，感谢曹大，我认真准备了 3500 字分享给大家。</p>
<p>这里很多人还不认识我，先介绍一下自己：</p>
<p>我是 90 年生人，2010 年到北京体育大学读书，2014 年毕业后开始北漂，摆过地摊做过服务员，2015 年 8 月进入新媒体行业做小编，后面这 5 年就一直专注在新媒体行业，从小编做到新媒体运营经理，做到内容副总裁，然后现在是内容创业者。</p>
<p>我的公众号 @粥左罗 是 2018 年 3 月开始做的，@粥左罗的好奇心 是 2019 年 10 月开始做的，都做得比较晚，但现在也有近 100 万粉丝，全都是靠写爆文涨粉，我写过一篇 1500 万阅读的文章，写过 5 篇 100 万＋，10 万＋写了几十篇。</p>
<p>我从 2016 年底开始做课程，累计学员超过 10 万人，目前主打的课程是写作课和成长思维课，以及两个主打训练营，21 天写作训练营开了 20 期，视频号训练营开到第 5 期了，这些可以在我的公众号菜单栏了解。</p>
<p>接下来我们进入主题分享：</p>
<p>曹政老师跟我说了这个主题后我就特别喜欢，在我们的一生中，我们会做出无数决策，这些决策其实都是赌，因为人生几乎没有什么东西是确定性的，我们要做的是提高赌赢的概率。</p>
<p>我今年 30 岁，从山东农村走出来，留在北京，成家立业，总体上来说，走得非常顺，这里面一定有很多幸运的元素，但我对一系列关键决策的把握能力也是至关重要的，那些决策没做对的话，我不会走到今天。</p>
<p>我准备这个内容时，课程还没开放哈，不知道曹老师分享什么，我的分享就 20 分钟左右，主要就讲两个词：可信人和可信度加权，其实说的就是一个事情的两个面，核心就是“可信”。</p>
<p>01<br>可信人</p>
<p>我先说一个结论：绝大多数人的决策，都极其糟糕，因为他们征求建议做决策时，都找错了人。</p>
<p>我们接受的教育里，有一条错误决策原则根深蒂固的植入在我们心中，那就是：做重要决策时，要征求下大家的建议。</p>
<p>为什么错误呢？</p>
<p>因为大多数人，都不可信。</p>
<p>比如，很多人高考填志愿，主要参考爸妈和亲戚朋友的建议。</p>
<p>我高考后，去哪个城市，选哪所学校，学什么专业，没有一个和父母商量过，因为他们都没上过大学，我爸是光荣的农民工，去过很多城市的工厂打工，我妈是家庭主妇，一辈子没出过山东省。</p>
<p>我超爱我的爸妈，但这样的决策，我不会让他们参与。</p>
<p>我也几乎不会参考同学们都去了哪个城市的哪所学校，生而为人，大家都是第一次上大学，你也没经验啊。</p>
<p>我成年后，做的第一个重大决策，就是复读。</p>
<p>我所在的农村，我们初中毕业后，只有不到 30% 的人能读高中，我读的那所高中，文科 6 个班，高考的本科率是多少？几乎为 0。也就是几乎没人能考上本科。</p>
<p>我 2009 年参加高考，成绩下来，我是文科第一名，唯一一个过二本线的，如果这件事放在别人身上，学校文科状元，开心坏了，爸妈肯定也会在村里置办酒席，送你去上大学。</p>
<p>但那年，我做了个决定：放弃这个二本，去复读，考一本。</p>
<p>这个决定，几乎所有人反对，爸妈觉得我这个人咋这么不知足，亲戚都觉得可惜，同学们都会觉得有个二本上就不错了，万一明年考得更差呢。</p>
<p>我谁的建议都不听，因为他们都不是可信人，提供的都不是可信信息。</p>
<p>我是一个农村孩子，高考是我几乎唯一的出路，这一生改变命运的机会，就这一次，我不能就这样过去。</p>
<p>我的决策是自己做的，但我参考了很多素未谋面的可信人：</p>
<p>1、我高三时，看了很多杂志，其中一个杂志，上面经常会报道一些已经读了大学的学生的采访，他们告诉我，读好大学和一般大学，差别非常大，去大城市和去小城市，差别非常大，他们是过来人，我信他们的。</p>
<p>2、我高三时，在网吧喜欢看一些名人大佬的演讲故事，看到俞敏洪、马云这样的人，都是复读了两次，才考上自己理想的大学，看他们的人生，我就知道，如果当年他们不这样决策，很难有后来的成功。</p>
<p>3、我通过上网、看报纸、杂志等方式，了解到省城济南一些专门的复读培训班，他们高薪从省内的一些知名高中请来名师，重点班只招收两种学生，分数高但自己不满意的，分数高也满意但是没填好志愿的，他们每年的提分率很高，普遍都能提高大几十分。越考越差的不是没有，但整体上概率很小。我自己又是情绪比较稳定，很难发挥失常的那种人。我也比较会学习，过去三年进步很大，去复读，跟更好的老师学，跟更优秀的同学一起学，我坚信自己可以大幅度的提高成绩。</p>
<p>所以，那年夏天，我们家没摆酒席，我一个人拿着一千多生活费坐着公共汽车去济南复读了。</p>
<p>一年后，我考了 623 分，如愿以偿考上北京的 211 大学，北京体育大学，学产业管理。</p>
<p>我做很多事，都不会参考“大家的建议”。</p>
<p>但我也不会“独自决策”，因为我会始终提醒自己：</p>
<p>我是在寻找最好的决策，而不是自己能得出的最好决策。</p>
<p>我会找少数人，少数可信人，让他们给我建议。</p>
<p>什么是可信人？</p>
<p>整体上，他们可以不断的取得成就，并且他们可以就自己如何做到的，有很好的解释。局部上，他们在你想咨询的领域同样有过成功经历，并且有很好的解释。你想得到一样东西，就要去找到那些已经得到了这些东西的人学习。</p>
<p>我在北京买房时，只是告诉了爸妈这个好消息，但我不会征求他们的建议，他们没有买城市里的房子的经验，也没有居住在城市的住宅楼的经验，除了他们说 18 层不要买以外，其它的我都忽略，身边人的建议我也比较少的去征求，比如我姐姐，她在泰安买过房，但是在三四线城市买房和在一线城市买房，根本不是一回事。</p>
<p>但我是一个小白，对买房一无所知，我还不能自己做决策。</p>
<p>怎么办？</p>
<p>找可信人。</p>
<p>我非常熟的朋友里，买过房的，城市、位置、总价特别匹配我需求的，几乎没有。</p>
<p>怎么办？</p>
<p>我想到一个办法，我在知识星球上，搜索讲北京房产的知识星球，判断靠谱的，我都付费加入。然后每个星球，我每天花固定时间，读一下他们的精华分享和问答。</p>
<p>我发现如获至宝，为什么呢？</p>
<p>如果我咨询我买过房的朋友，很可能他这辈子就买过那一次，自己也没研究过很多，买好买坏运气成分也有不少。</p>
<p>而这些星主，每年踩盘几百套，每年帮助很多人买房成功，他们的知识、信息、经验、判断的可信度是非常高的。</p>
<p>而且，你可以用关键词检索。<br>比如，我想知道东湖湾这个小区怎么样，我搜索东湖湾，我加入的这些星球里所有提到东湖湾的帖子，都会出来，我挨个看下来，就非常了解了。</p>
<p>比如，我搜索中介费，我就把所有提问中介费的问题都找出来了，北京各大中介可以给到的最低点我摸得非常清楚。</p>
<p>比如，如何砍价，技巧和注意事项分别是什么，如何因人而异做砍价策略，我拿到很多案例。<br>这些信息，对我帮助极大，让我最后交易的时候，像一个专家一样。价格我砍到了这两年同小区成交的最低价，比当年同一栋楼同户型的另一套房少花了 65 万。链家中介费，我拿到了 2.2％，是我知道普通人能谈到的最低点。</p>
<p>这是可信人和可信信息。</p>
<p>02<br>可信度加权</p>
<p>我再说一下，可信度加权。</p>
<p>什么意思？</p>
<p>第一，你不能找一个可信人，你要找多个可信人。</p>
<p>第二，你要综合多个可信人的建议。</p>
<p>第三，即便都是可信人，可信度也有高低之分，如果按投票来说，不能按一人一票来算，有的人可信度更高，他一人可以有三票，有的人可信度低些，可以按 0.5 票。</p>
<p>比如，我买房时，看了一百多套房子后，选了大概 9 套房子。</p>
<p>然后，我写了一段信息：</p>
<p>我认真看房一百多套，总预算在多少钱，筛选了一些，诚心求教，希望您指点一下，帮忙排序一下（全排），感谢老师！</p>
<p>1、<br>2、<br>3、<br>….<br>9</p>
<p>（每套后面有基本信息，小区，楼层，朝向，面积，单价，建成时间等。）</p>
<p>然后，我挨个提问我认为靠谱的星主，有多个是我加到他们微信，微信发大红包提问。</p>
<p>所有人都回答后，我再综合排。</p>
<p>综合排的时候，我会模糊性的加权，有的人是纯投资派，我会降权一点，因为我会长期自住，有的人是讨厌学区派，他们排学区房时都会倾向往后排，这点我要综合看，因为这个事我研究了很多可信人，其实得不到共识。</p>
<p>当然，还会努力平衡个人偏好，我并不一定非买前三名不可，因为我还要考虑自己的偏好，比如我对视野开阔尤其偏好，但我也不会买后三名，当多个可信人都认为某个选择不对时，我不会认为我是世界上最聪明的人。</p>
<p>所以，我们既不能不区分可信度的参考所有人，也不能不合逻辑的高估自己的可信度。</p>
<p>比如我在决定要买哪个后，要给链家的中介一个预期价格。</p>
<p>第一，我不会马上给。我会反问对方，你们是专业的，我花钱请你们帮我买到合适的房子，请你们给我一个参考，这个房子多少拿下是合理的。他们会给出一个价格。</p>
<p>第二，我会换个账号登陆贝壳，找机会跟卖方的经纪人探寻底价，以及卖方的其他真实信息。<br>第三，我会把我掌握的有效信息发给我认识几个高可信度的星主，问他们这个房子多少钱拿下是合理的。</p>
<p>我知道真实基本底价后，我在那基础上再大减 50 万，报给中介，中介再报给卖方中介，卖方中介再报给卖家。最后，基本确定，我这个价格是不合理的。我死守这个，是无法成交的。我于是在心里调整预期，但我绝不改口，又约了面谈。面谈过程中，我得到了新的关键信息，我知道虽然我这个价格虽然不能成交，但对方死守的底价我找到了破的可能，当时故意没谈，各自回家，然后我再让中介去谈，最终以很合适的价格拿下了。</p>
<p>我跟女朋友复盘整个决策过程，关键在于，各个维度上，我们都找到可信人拿到可信信息，我们方方面面做到了心中有数，所以才能顺利买房。</p>
<p>人的决策，基本分为两种决策方式，一种是以证据和逻辑为基础，另一种是以潜意识和情绪为基础。</p>
<p>如果你能做到更多的是以第一种方式做决策，你就比 70% 的人强，因为大多数人就算是关键决策也是稀里糊涂的。但做到了第一种，还有很大的进步空间，因为以证据和逻辑为基础，做好的前提是，你知道从何处获得以及如何获得证据和逻辑，当然是从可信人那里获得，以可信度加权的方式获得，这样你就比 90% 的人强。</p>
<p>我今天的举例用的高考和买房，但关键决策一生有很多，比如投资决策，你这一生要经历很多次，职业选择，也要经历很多次，甚至城市选择这一生也要有好几次，并不是一辈子都在一个城市，等等很多决策，都有持续深远的影响，所以大家今后要认真对待每一次关键决策。</p>
<p>我希望大家以后每次做关键决策时，都能想起，曾经有一天，有个叫粥左罗的，分享过两个关键词，一个叫可信人，一个叫可信度加权，你每次要能想到这个，可能都能提高你的决策质量。</p>
<p>以上就是我的分享，希望作为曹大福利课的彩蛋，大家能喜欢且觉得有用，最后祝大家都能做好人生关键决策。后面的课程，继续请曹大给大家讲，感谢曹大。</p>
<p>谢谢嘉宾 粥佐罗的分享，恰好说的就是我的痛点和短板，因为恰好我的买房决策和卖房决策都很糟糕。</p>
<h2 id="互动交流"><a href="# 互动交流" class="headerlink" title="互动交流"></a>互动交流 </h2><p> 谈判推荐这本书：《谈判是什么》盖温肯尼迪著，中国宇航员出版社，2018 年出了新版，改名《谈判》，民主与建设出版社：<a href="https://m.douban.com/book/subject/30203275/" target="_blank" rel="noopener">https://m.douban.com/book/subject/30203275/</a></p>
<p>Q：日常生活怎么可以更好地训练自己的决策能力？这种重大场景并不是经常出现的</p>
<p>A：多一些理性和逻辑，少一些感性和情绪。</p>
<p>Q：想去的城市，无法和伴侣协商好。这个应该怎么决策？</p>
<p>A：凡事有得有失，说的就是这种，如果能讲道理，那么从综合发展预期来讲，如果不能讲道理，就想想自己想得到什么，愿意付出什么。</p>
<p>曹老师曾经在星球里分享过俞军老师推荐的适合产品经理的十本书： 社会心理学 阿伦森 第一本经济学 学会提问 认知心理学及其启示 思考快与慢 超越智商 思维与决策 经济学原理 错误的行为：行为经济学的形成 新制度经济学</p>
<p>很多书都是锻炼逻辑思考和人性思考的。</p>
<p>推荐一本书《引爆点》，讲的是如何引发一场潮流，对人性的理解以及营销都有很多启发</p>
<p>Q：曹大，请问如何决定自己是否该考研究生，目前大三，在华东师范大学，十分感谢</p>
<p>A：看自己目标是什么，如果想当老师，有个研究生资历还是不错的。</p>
<p>Q：曹大，虽然我开发能力挺不错的，不想忍受开发岗位大部分都是闷声写代码，好几天不说话的环境。虽然大部分人说开发岗的前景比测开好太多，但是今年校招我还是接受了字节测开 offer, 放弃了其它公司的开发岗 offer, 除了待遇上测开有优势外，还是想通过测开岗位训练自己的沟通能力，因为我不太擅长表达，我了解到能走长远的人都需要一个良好的表达能力，我也有意想锻炼自己的表达能力和底层思考能力。 另外就是觉得测开岗女生比较多，感觉工作应该会稍微更有乐趣一些。 想请教曹大我对测开和开发岗位的工作日常认知有没有问题，以及我这个决策是不是做错了</p>
<p>A：任何岗位的天花板都挺高的，看自己能到什么级别。微信测试的负责人是张小龙从谷歌挖的老同事，你体会一下。 我还有个朋友做测试在上市公司做到总监也差不多财务自由了。当然，沟通能力还是很需要提升的，无论什么岗位，你想升职的时候，不仅仅是你的工作表现也包括别人对你的评价和认知</p>
<p>A：问测试岗的那位同学，测试岗绝对是一个有挑战的岗位，但是开发能力不能掉。平常测试过程一定不能走人肉测试的路线，多想想怎么提高测试效率，让大家看到测试的价值。</p>
<p>Q：曹大，我是北京化工大学（一所不太出名 211）的大三本科生，说实话我不太喜欢自己的专业，而且感觉自己并不太适合这种应试教育（其实也确实学不过），我做过两年的外联，有一年的投资、套利经验，今年四月份加入了生财有术，凭借一定的学习能力和执行力赚到了人生的第一个 10w+。我的家境是三四线城市的中产，虽然供我读书没问题。但是远远不能和大城市的资源，人脉相提并论。 目前最纠结的【人生选择】就是 1. 考研 2. 就业 3. 跟着生财等继续探索更多赚钱项目（我理解为小型创业）请问曹大能帮我分析一下吗？万分感谢！</p>
<p>A：作为学生已经不错了，大学专业不是终身绑定的，俞军老师也是化工专业的。就业和探索不冲突</p>
<p>Q：请教曹大，我目前是化工专业的硕士，我想了解行业的信息、想未来工作一段后创业，学校老师是可靠的信息渠道吗？网上的各种论坛值得参考吗？另外，我听一些投资人朋友说技术很重要，那我应该读博吗？</p>
<p>A：老师说的可以听，但不能只听老师的，自己多搜索，多看看发展最好的学长在做什么，多跟他们了解，以及尽可能认识一些跨领域的高手，多一些思路</p>
<p>Q：请问曹大：做关键决策的时间是不是也不能拖太久，导致失去某些机会。这种度要如何拿捏呢？像帅张老师说的这种情况——就怕看完一百多套，房价又暴涨了，没来及买</p>
<p>A：会有这情况，一切要靠自己判断和取舍。而且不要求全责备，你不可能总是买在最低点，也不可能卖在最高点。</p>
<p>Q：如何正确找到自己的目标？</p>
<p>A：前面提到了，多复盘，多跟身边熟悉的人交流，问问别人对你的印象和评价，多思考自己的价值在哪里。</p>
<p>Q：曹大，感觉自己有点恐惧面试，因为准备换行找工作，总是想着多准备准备再去面试，曹大能给一些建议吗？</p>
<p>A：多去几次就不恐惧了。</p>
<p>Q：该继续工作，还是出来做个自由职业者，决策成本都好高，时机拿捏不了，见识少，没法判断。曹大能给一些建议吗？</p>
<p>A：自由职业收入预期大于职场，当然可以继续，你可是龙珠王啊（曹家蒙）</p>
<h1 id="如何复盘及改变决策"><a href="# 如何复盘及改变决策" class="headerlink" title="如何复盘及改变决策"></a>如何复盘及改变决策 </h1><p> 大家好，我是曹政，这是年终福利课的第二节，关于如何复盘决策，改变决策，以及错误决策是怎么形成的。</p>
<p>我们上一节讲的是如何制定决策，那么决策如果是错的，或者不是最优的，是不是就完蛋了呢？</p>
<p>有两点请大家务必记住。</p>
<p>第一，人生不止一个关键决策，不止一个机会，绝大部分情况下，你有其他的选择机会。学会拥抱变化是人生的一部分。</p>
<p>第二，错误的决策，或者没有选择最优决策，未必一定是坏的结果，凡事都有两面。</p>
<p>首先，要学会不断反思，复盘。正如前面所提，如果从不觉得自己之前的判断和决策傻逼过，那肯定是不可救药的大傻逼。有错误，有问题，是正常的，发现问题，找到原因，是成长的一部分。认知的成长，有助于在后续决策中，做出正确的选择。</p>
<h2 id="人生决策的四种类型"><a href="# 人生决策的四种类型" class="headerlink" title="人生决策的四种类型"></a>人生决策的四种类型 </h2><p> 如果我们今天再整理一下，可以分为四种决策。<br>1、最优决策<br>2、正向决策<br>3、负向决策<br>4、灾难决策</p>
<p>最优决策，顾名思义，最佳的选择路线，但说实话，能做到的是极少数，甚至我们即便严谨复盘，也可能无法发现什么才是当时的最优决策。</p>
<p>正向决策，长期来说，对个人成长，价值提升是正向的。但正向决策也存在很大的差异，比如 15 年前两份 offer 摆在面前，一份是腾讯，一份是华为，那么正常情况下，这两个选择都是正向选择，但不同选择的收益差异，却可能是非常巨大的。</p>
<p>也就是，我们要追求在正向决策中倾向于最优决策的路线。</p>
<p>负向决策，长期来说，对个人成长，价值提升是负向的。比如有人从一个很有前途的公司跳槽到一个资金盘的公司，然后钱没赚到还惹了一身麻烦。</p>
<p>灾难决策，导致无可挽回的灾难局面。</p>
<p>比如，欠一大笔赌债，或被杀猪盘骗的一无所有负债累累。<br>比如，做严重违法的事情，深陷牢狱之灾。<br>比如，做出肮脏丑陋的事情被曝光，遭遇行业封杀、社会性死亡。<br>比如，因一意孤行导致家庭破裂或亲人丧生，追悔莫及。<br>比如，酒驾导致严重交通事故，导致身体残疾。</p>
<p>我们关键决策追求的目标是，在保证做出正向决策的同时，尽可能靠近最优决策。</p>
<p>我们很难做到最优决策，但做到正向决策却不难，甚至于，普通人的大部分决策都是正向决策，比如你坚持读书学习，去报考大学，争取选择更好的 offer，都是正向决策，我们的目标是达到最优决策，但这个很难，那么维持正向决策，不断向最优决策靠拢，是我们的目标。</p>
<p>在很多时候，我们所认为的错误决策，其实只是正向的程度不够，离最优决策距离有点远。比如在诸多 offer 中没有选择到成长最快，长期回报最高的企业。比如过早的卖出了重要资产，踏空了大幅的增值空间。这些其实都不是负向决策，但确实都存在进一步优化的空间。</p>
<p>同时，要尽力避免负向决策，不要被坑，被骗，不要以个人信用为代价换取蝇头小利，要有法律观点和道德底线等等。</p>
<p>灾难决策是很难挽救的，可能需要很长时间弥合创伤，很长时间的自我恢复。我希望我的读者不要出现这样的决策，真的真的承担不起。</p>
<p>而做出灾难决策，往往是一时冲动，以及对风险不以为然。。。</p>
<p>我相信这里的读者大部分应该自己没有经历过灾难决策，都可以复盘一下，自己不满意的关键决策里，哪些是正向的，哪些是负向的。</p>
<h2 id="谈谈关于决策的复盘"><a href="# 谈谈关于决策的复盘" class="headerlink" title="谈谈关于决策的复盘"></a>谈谈关于决策的复盘 </h2><p> 复盘是什么，</p>
<p>首先，要看你决策后的发展预期，是否和现实一致。比如你投资的回报，是否和你预计一致。比如你选择的职业和工作，是否符合你原本的预期。比如你创业设计的项目上线，用户的反馈，获客成本，团队组建，成本开销等等，是否与你计划一致。</p>
<p>如果不符合，原因是什么，是否有自己之前未考虑，未明确的地方，或者判断错误的地方。</p>
<p>其次，看市场及社会环境的变化，客观条件的变化，你之前做出决策的客观条件，市场环境是否还在维持，还是有了较大的变化，计划没有变化快是很常见的。意想不到的市场变化很容易带来自己计划的失败。</p>
<p>第三，不断反思自己认知上的误区，扩展视野边界，也许你之前的决策是当时认知中的最佳选择，但是你的认知提升了，视野提升了，资源提升了，你就应该想想，也许存在更好的决策。</p>
<p>第四，即便一切顺利，也要不断追寻细节，是否存在可能遗漏的风险和危机点。</p>
<p>比如，有那种早期加入巨头的，很好的选择，待遇和职位都还不错，人生也没什么苛求了，觉得一切都好。但是巨头老板要年轻化，要革命，要淘汰老白兔，很不幸，40 来岁下岗了，这种还能去做什么呢？</p>
<p>一切顺利也是存在隐患和危机的，随时要用心体会，用心挖掘，给自己多一些选择，多一些后路。</p>
<p>还有很多投资者、创业者不懂得见好就收，可能做出了成功的投资决策和创业决策，但没有能及时收手，在市场环境剧烈变化的时候，因为厌恶损失，不断投入，最后一步步坠落到灾难决策。</p>
<p>这样的案例是很多的，为什么一些上市公司老板最后身陷囹圄。身价多少亿的时候，过于自信，失去了自我认知，市场逆转的时候，不断地试图挽救，最后铤而走险，做出灾难决策，导致自己失去自由。</p>
<p>不断复盘，总结之前决策的成败得失，第一是可以针对性的做出调整和改变。第二是有助于提升新的决策能力。</p>
<h2 id="谈谈关于决策调整"><a href="# 谈谈关于决策调整" class="headerlink" title="谈谈关于决策调整"></a>谈谈关于决策调整 </h2><p> 复盘不代表一定要推翻决策，但根据复盘的心得，对决策可能需要做出一定的调整。</p>
<p>第一，优化决策</p>
<p>如果发现之前的决策结果，符合预期，甚至优于预期，但早期决策可能更多是方向上的，那么后续就应该有细化，或者更明确的调整。</p>
<p>比如工作决策选择某个岗位 offer，并且指定了发展规划，进来之后发现确实不错，上司给力，同事都很融洽，那么下一步就应该细化这个规划，跟领导聊聊，是否有自己没想明白的地方，是否还有哪里可以提升，以及市场是否有新的变化，自己的发展规划是否应该与时俱进。</p>
<p>再正确的决策，也要不断迭代，来适应时代的变化。不要墨守陈规，觉得自己当年判断决策挺准的，就不再反思和调整了。</p>
<p>其实很多人真的是做出了正确的决策，也有一个很好的发展，但是就躺在了成功上，不思进取，那么时代在进步，过不了多久，可能这个正确的决策最后也不见得实现成功。</p>
<p>第二，改变和调整决策</p>
<p>市场环境发生了改变，或者虽然选对了方向，但发展远远达不到预期，这时候可能涉及改变决策。</p>
<p>列举一些常见的决策改变</p>
<p>更务实，摈弃一些好高骛远的目标，学会更好的理解所掌握的资源和能力局限，学会在有限资源，有限能力下做出最好的成果，这是一种常见的决策调整。</p>
<p>个人方向调整，比如在一个新公司，觉得公司发展前途很好，但自己的发挥空间有限，那么寻求公司内部调动的机会，寻求更好的发展空间。这也很常见。</p>
<p>修改商业模式，比如创业过程中，虽然用户指标达到了预期，但收入指标远远达不到预期，也许是模式产生了偏差，通过请教业内的懂行人士，以及基于用户行为的深度分析，调整商业模式，改变收入路径，突破困境。</p>
<p>横向拓展，发现新兴领域与自己核心业务具有高度的关联性，快速调整，横向拓展，覆盖新兴领域，搭上市场顺风车。</p>
<p>基于条件转变，比如创业公司招聘中发现一个超级牛人，有自己深刻的想法，或者在商业合作洽谈中发现有一个非常有潜力的合作伙伴，提供了令人无法拒绝的资源，那么基于新的资源新的竞争优势，对创业方向进行改变和调整。</p>
<p>改变和调整是很常见的，但并不是说你看到了什么好的方向，好的领域，就一定要调整，我见过一些创业者，确实思维敏捷，市场敏锐度高，但是改变和调整实在太频繁，做了很长时间，看上去什么风口都可以去抓，最后没有积累。</p>
<p>这里要强调一点，就是改变和调整虽然很多时候是有必要的，但请随时保持一定的积累。保持自身能力、价值的增长，尽量选择做有积累的事情。</p>
<p>第三，推翻和放弃决策</p>
<p>如果发现市场环境的改变，或者基于认知的提升，发现原有的决策所处的逻辑基础不再存在，或者发现原有的机会已经失去，要有坚决止损的决心。</p>
<p>很多时候，甚至可以说非常高的比例的情况下，人们之所以陷入困境，并不是因为做出了错误的决策，而是在有机会脱身的时候，没有止损。所谓投资高手，或者所谓一些顶尖牛人，他们决策的成功率未必高于普通人，但他们能够把决策错误的损失降到最低，而把决策正确的收益坚持到最大。</p>
<p>认知提升可以纠正很多错误决策，然后呢，就是快速止损。</p>
<p>Q：我的错误决策，在选大学的时候没有意识到这个决定会影响我的一生，草率的做出了决定</p>
<p>A：18 岁的时候，谁又能保证做出正确决策呢。</p>
<p>损失厌恶心理是人们常见的心理特征，很多人因为产生了损失，试图弥补损失而做出更荒谬的决策，从而造成更大的损失，杀猪盘游戏也是利用这个心理，不断地榨干受害人的所有积蓄，而现在，更残忍，榨干受害人在各个平台的信贷额度。</p>
<p>灾难性决策往往是一时上头触发的，在损失厌恶的心理驱动下，人们很容易失去理智判断的能力。</p>
<p>通常，我们做出负向决策是一个糟糕的体验，但其实往往不致命，然而，如果因为厌恶损失，从而在错误决策上越走越远，就可能导致灾难性决策，绝大部分灾难性决策，都是这样演进的。</p>
<p>第四，坚持正确的决策</p>
<p>这里再提一个非常关键的心得，就是坚持正确的事情，其实也很难。</p>
<p>有人说，坚持正确的事情怎么会难呢，我举个例子，比如你有 10% 的几率博取 20 倍的回报，你会不会投入？从概率统计来说，这就是正确的事情，第一次投入，失败了，第二次投入，失败了，第三次，你还会投入么？很多人就退缩了，不要说你，我也是，而且很多次，没有坚持正确的决策。</p>
<p>正确的决策，未必立即会有正确的结果，因为很多事情，并不是你决策正确就一定可以获得回报的，或者这个回报周期可能会比较长，很多人，做出了正确的决策，但受到了一些挫折，然后就退缩了，那么其实再坚持一下，可能就是非常光明的前程，就在黎明前的一刻，退缩了。</p>
<p>复盘的意义就在于此，你复盘得失成败的时候，要知道什么是对的，什么是错的，比如你投资一个企业股票，市场环境是否变化了，企业产品竞争力是否变化了，企业人力资源是否变化了，企业价值逻辑是否变化了，你对行业的认知是否变化了，你推断下来，发现虽然有所变化，但并没有发现根本利空的变化，而这个企业因为某些市场环境波动，股票下跌了，那么，你敢坚持正确么？</p>
<p>或者你发现，确实产生了一些不利的变化，但你厌恶损失，不想止损，还想再等等看，这就是上一段提到的问题。</p>
<p>Q：怎么定义正确，还是要靠多看书吗</p>
<p>A：这是第一课的内容，底层逻辑，信息筛选，人性认知，自我认知，还记得这些么？</p>
<p>决策就是这样，很多时候你很纠结，不知道自己是对是错，但你要建立自己的判断逻辑和价值逻辑，然后基于此做出决断，并承担自己决断的后果。</p>
<h2 id="做好当下，机会无处不在"><a href="# 做好当下，机会无处不在" class="headerlink" title="做好当下，机会无处不在"></a>做好当下，机会无处不在 </h2><p> 错误的决策，未必一定都是非常糟糕的结局。正确的决策，也未必能达到正确的彼岸。</p>
<p>怎么理解呢，比如你选择工作，一时被人忽悠，放弃了一个很好的巨头工作，选择了一个不靠谱的，必然失败的创业公司，按说，这是一个错误决策，但如果你在这个创业过程中，全身心投入，把所有踩过的坑，犯过的错，以及得到的经验教训都整理清楚，这个成长的收获，可能会大于你在一个很好的巨头里按部就班的工作经历，如果你不气馁，不丧，那么后续还有很大机会，在其他工作机会上，体现自己的价值，一个经历过创业惨痛教训并能够认真反思总结的人，在职场上往往具有更全面的视野和更高的格局，更可以胜任一些开创性的管理岗位。</p>
<p>比如你误信所谓专家推荐，投资决策，亏了一大笔钱，你当然很心疼，很绝望，但你认真分析和整理了这些套路和话术，不断反思和查询有关资料；第一增强了你后续的免疫力，防止后续被欺诈；第二提升了认知和视野，在后续的投资中能够正确控制风险边界，可能这个收获在未来会让你避免更大的损失。所以网上也有一种观点，年轻人早点被坑未必是坏事，总好过人到中年被坑的一无所有。</p>
<p>所谓祸兮福所依，福兮祸所依，还是有一些道理的。其实很多行业大佬，巨头老板创业早期很多都有被骗，被坑的经历，还有更多好高骛远，或者错失良机的经历，网上可以搜到很多这样的八卦案例。很多时候，错误决策也是成长的一部分，如果能很好的反思，复盘和吸取教训，可能比正确决策带来的收获更大。</p>
<p>Q：家里人，借几十万给朋友，朋友还不起，喊再借点缓过来就可以全部还。于是损失厌恶心理导致，最后借了两百多万人找不到了</p>
<p>A：底层逻辑么，没有信用的人不可以再信的了。</p>
<p>所以，无论决策对与错，很关键的一点是，做好当下。</p>
<p>如果决策无法更改，就要做好当下，扎扎实实做好每一步。</p>
<p>大学没有选择正确的学校、专业，可以继续好好读书，还有双学位、考研的机会。<br>工作没有选择正确的 offer ，一样要好好表现，好好学习，让自己再进一步，还会有新的选择机会。</p>
<p>不要丧，不要自暴自弃，不要因为选择错误就觉得自己前途尽毁，凡事事在人为。</p>
<p>当然，很关键的是，不要让自己丧失了继续选择的机会，要保持拥有继续下注的筹码。</p>
<p>这个筹码是什么呢</p>
<p>第一，你的身体，一定要让身体健康，没有健康，没有一切。<br>第二，你的信用，信用的重建是需要极高成本的，信用丧失，你再想翻身，就需要很多倍的努力。<br>第三，不要欠债，资产少一点没关系，不要欠一大笔网贷！不要欠一大笔网贷！不要欠一大笔网贷！任何人让你借网贷帮他，或者让你借网贷投资，都不要应允，任何人！！！除非至亲生命危险，需要救命，否则，绝不能用自己的网贷来帮助别人。</p>
<p>错误的决策不是末日，尽可能做好当下，然后你会遇到新的机会，做出合理的决策调整，还是能回到正确的轨道上。</p>
<p>而且，很多时候，很多人眼里所谓错误的决策，可能也并不见得是坏的决策，可能只不过不是当时的最优决策，比如你选择了 B offer，放弃了 A offer，你觉得 A 发展更好，自己很遗憾，但其实 B 可能已经超过了很多其他选择。不要总是求全责备，自怨自艾。</p>
<p>比如我说过的，在信息产业，考研并不是获得好工作的最优决策，但考研也并不是一个坏的决策。</p>
<p>Q：总觉得生活中被紧急而不重要的事情充斥，有时候会忽略判断决策的重要性。所以在实践操作时有什么建议吗？比如多久进行复盘，或者重大决策之前思考多久</p>
<p>A：因事而异吧，自己养成不断反思复盘的习惯就好。</p>
<h2 id="如何避免做出坏的决策"><a href="# 如何避免做出坏的决策" class="headerlink" title="如何避免做出坏的决策"></a>如何避免做出坏的决策 </h2><p> 我们来看看，坏的决策都是怎么做出来的。</p>
<h3 id="分不清重点，短视，缺乏格局"><a href="# 分不清重点，短视，缺乏格局" class="headerlink" title="分不清重点，短视，缺乏格局"></a>分不清重点，短视，缺乏格局 </h3><p> 非常常见的决策问题，比如找工作时纠缠于一些细枝末节，比如贪图一点点眼前利益做损失信用的事情。<br>很多人年轻人初入职场会犯这样的错误，为了一点蝇头小利，为了一点鸡毛蒜皮，花大量的时间和精力。<br>有时候我们还说不得，为啥呢，因为人家有道理啊，我吃亏了难道维权有错么，你不让我维权是不是屁股坐歪了。我不是不让你维权，而是你做出的一切得不偿失。<br>真要是有重大利益损失，找个律师授权去维权，自己该干嘛干嘛去，别瞎耽误功夫，你说找律师太贵，那就算了，赶紧抓正事去。</p>
<p>很多糟糕的决策都是因为过于关注细节，而忽视了重点。而一些割韭菜的大师们恰恰善于营造某些让你觉得愉悦的细节，从而掩盖他们的动机。<br>很多老年人受骗，是因为骗子的套路和话术让他们很舒服，很愉悦，为什么亲人反而说不过骗子，因为你让他们不舒服了么。这也算暗黑版的“细节决定成败”吧。</p>
<p>还有一些刚毕业的学生，为了工资高低一两千斤斤计较，当然人家也有道理，一两千对基层老百姓来说不是小数目了，但你的成长目标是什么，你的长远价值是什么，从五年，十年的职场发展看，什么才是最重要的。</p>
<h3 id="缺乏法律意识和风险意识"><a href="# 缺乏法律意识和风险意识" class="headerlink" title="缺乏法律意识和风险意识"></a>缺乏法律意识和风险意识 </h3><p> 最近这些年，我朋友圈陷入牢狱之灾的有好几个，那么没有陷入牢狱之灾，但被判了缓刑的也有不少，此外，监视居住的，被边控限制出境的，躲在海外不敢回国的，都有。<br>当然也有一些自己到没什么大碍，但投资或参股的项目出事，损失惨重的；合伙人被抓的；创业项目被勒令关停的；这些就非常非常多了。<br>很多年轻人没这个概念，总觉得很遥远，其实一点都不遥远。<br>版权问题，税务问题，隐私滥用问题，信息安全问题。</p>
<p>说真的，我年轻的时候，其实也挺危险的，从网上搜一个安全手册，看到一些入侵的途径技巧，也不懂么，就各种扫描；学了 SQL 注入，就敢各处去试，也是当时互联网相对新生，传统的法律还不太关注这部分，整体社会比较纵容，要按现在的法律执行标准，我那时的行为其实也是，那个、那个很有问题的。</p>
<p>很多时候，我们觉得自己的行为没有恶意，不是做坏事，请注意，评判的资格和标准，不是我们自己说了算的。</p>
<p>很多创业者对内容安全没概念，对内容审核成本没概念，这种项目有一个算一个，死的很脆。这种创业决策，有一个算一个，都是坏决策。</p>
<p>找工作的时候，不注重风险，被卷入诈骗公司，最后无法脱身，连带自己深陷囹圄的，最近这些年也有很多。</p>
<h3 id="惯性思维"><a href="# 惯性思维" class="headerlink" title="惯性思维"></a>惯性思维 </h3><p> 以为过去的表现代表未来的趋势。<br>为什么那么多庞氏骗局那么容易得手，中国人口红利啊，三个月分红，六个月分红，一年分红，两年分红，好像很安全，很多人赚到钱了，很多人就会以为很安全很稳定了么。<br>P2P 理财也是，2017 年第一波暴雷跑不掉的，这种是真的没救，为什么很多人 2018 不跑，2019 还不跑，自己买的没暴雷，就总觉得没问题么。<br>以为上涨的会一直上涨，以为历史业绩会代表未来。</p>
<p>还有就是产业的变迁，技术的革命，很多时候，你在某个领域可能已经登峰造极，突然，降维打击来了，这个领域没了。比如说，燃油车的发动机，可能已经研究了几十年，突然，电动车来了，对不起，全部不需要了。但很多人真的没有转过弯来，他们会本能拒绝新时代，拒绝新技术，这也是一种惯性思维。</p>
<p>我自己也要面对这个问题，我觉得自己数据库优化的经验很丰富，但现在年轻人用 clickhouse，用 pingcap，用很多新的技术和架构，以前的经验真的不适用了，这事要认，再倚老卖老，确实不对了。</p>
<p>摆脱惯性思维，对每个人的认知和视野都是有很大的挑战，其实越是岁数大的人，惯性思维越严重，但有些年轻人，说真的，也会老气横秋。与时俱进不是说说而已，要做到不容易。</p>
<h3 id="损失厌恶心理"><a href="# 损失厌恶心理" class="headerlink" title="损失厌恶心理"></a>损失厌恶心理 </h3><p> 不肯止损，越输越要赌。<br>之前币圈有个自杀的，就是不肯止损，越输下注越大，高杠杆试图翻本，结果爆出了天文数字的亏损，自杀了。不是穷人啊，原本是个有钱人啊。<br>还有，金立手机董事长，亿万富翁，围棋高手，智商不低的，财富和身价也不低的，在塞班输出去十几亿，公司也完了，怎么输出去的，你说是不是杀猪盘我不敢乱说，但那么高的资产身价，如果肯止损，怎么会到这个境地。</p>
<p>我也有读者反馈被杀猪盘坑的很惨的经历，越输越想回本，越陷越深。<br>我以前炒股炒权证也有这样的经历，因为损失厌恶心理，亏的很惨，但所幸没有欠债。总还是有筹码在手上，总还可以继续下去，所以不至于一蹶不振。</p>
<p>任何时候，基于当下做决策，不要把前面的损失和收益考虑在里面，该止损止损，该收手收手。</p>
<h3 id="感性冲动"><a href="# 感性冲动" class="headerlink" title="感性冲动"></a>感性冲动 </h3><p> 很多收割韭菜的宣传活动，会营造一种氛围，很容易让用户觉得兴奋，紧张的氛围，很多人因此中招，在各种托，各种狂热氛围的衬托下，急促下单，迫不及待的上去送人头。<br>最后三个，最后两个，最后一个。<br>今天的价格绝对超值，错过今天，后悔一生。<br>今天成为我们 vip 会员，明年的今天你就会拥有怎样怎样的生活，看看谁谁谁，曾经如何窘迫，加入我们团队多久购买了豪车；谁谁谁，曾经如何挣扎，加入我们团队多久购买了豪宅，你不想和他们一样么，赶紧加入，最后的机会，名额有限，马上截至。</p>
<p>Q：政府国企，在公务员群里集资算不算 P2P</p>
<p>A：我觉得不好说，最近信托都暴雷，你要自己斟酌</p>
<p>美好的宣传，倒计时的催促，一群托的衬托，各种诱惑性的前景，以及伪专家伪学者的背书。</p>
<p>所以理性是非常重要的，拥有坚强理性思维的人，对这种场景的免疫力是很高的。实际上生活中我们也常常不理性，突然兴致起来，买一个心仪的游戏周边，或者突然想去哪里旅游，或者突然约一个老朋友去喝点酒，可能都不是理性决策。我们不是说人必须无条件理性，但我们要知道在什么场景下，不要让感性压制理性。</p>
<p>比如旅游的时候，被人忽悠买了一堆纪念品，或者路过某个商场促销，一时兴奋花了点钱，这种事无伤大雅；但做人生关键决策的时候，一定要理性，这个是非常值得强调的。</p>
<p>冲动还包括好面子，一时为了让别人看得起，往往会做出非常不理性的决策。成年人请记住，好面子往往做出愚蠢的决策。很多时候，往往因为一些小事，却冲动做出非常灾难性的决策。</p>
<p>争勇斗狠，走上犯罪道路，那就是追悔莫及了。</p>
<p>冲动是一瞬间的事情，为冲动后悔是半生漫长的记忆。</p>
<p>看过有个新闻，曾经有个女生，嫌她男朋友怂，面对别人欺负没有胆气，结果她男朋友冲动去表现了一把，被坏人捅死了，这个女生后悔也来不及了。</p>
<h3 id="侥幸心理"><a href="# 侥幸心理" class="headerlink" title="侥幸心理"></a>侥幸心理 </h3><p> 明知道有问题，明知道不合法，总觉得，自己可以成功逃脱。<br>最近那个案例，那个 42 亿美元的什么币来着，按照非法传销，所有违法收入全部充公。<br>什么，你说你是受害者，别揣着明白装糊涂，你忽悠下线的时候，明明就是帮凶。</p>
<p>最近这些年，我写有关文章就被人喷过无数次，“你傻逼，你不懂，那是新经济。”<br>出事后，这些人说自己是受害人。我特么的才是受害人，我那么人畜无害还会被他们喷，我才不可怜他们。</p>
<p>记着墨菲定律，凡是担心的事情，就一定会发生。牢记这句话，可以少犯很多错误。</p>
<p>很多事情的发展，我们不能完全预测，一个基本原则是，向最好的方向努力，但也要做好最坏的打算。如果你有这样的思维方式，就可以知道什么事情是不能碰的，你没办法做最坏的打算的事情，坚决不要碰。</p>
<h3 id="权威盲从"><a href="# 权威盲从" class="headerlink" title="权威盲从"></a>权威盲从 </h3><p> 上一讲我讲过自己经历过这样的傻逼案例，有兴趣的可以回顾一下上一讲内容。</p>
<p>那么多说一点，这还要结合一个概念来说，就是选择性阅读。<br>你认为什么会涨，你就会主动挑选这个东西会涨的文章，某个专家说这个会涨，会加深你的观点和偏见。其实还有专家说这个会跌，你是看不见的，或者看见了也不以为然的。<br>权威盲从，其实是自己给自己的偏见找了一个信用背书的借口，人们总是试图找各种借口来证明自己，安慰自己。</p>
<p>所以这就是为什么我希望你的信息不要来自于投喂，投喂是基于你的选择，会加剧你的偏见。一定要主动搜索！相对来说，可能会好一丢丢。<br>还有，我们对权威的认定也是有误区的，特别是免疫力不高的年轻人，或者知识层次不高的老人，很容易被一些伪权威，伪专家忽悠。</p>
<p>哪怕是真权威，也会忽悠你的，还记得让你 ALL In 区块链的投资人么，那可是货真价实的权威。人家没 ALL In，人家删帖了，你再追究人家也不承认了。</p>
<p>之前不是有文章说么，诺贝尔奖获得者都是可以收买站台的，而且我们知道奥巴马也是可以花钱站台的，还有什么权威是绝对可信的。</p>
<p>不要盲从权威，要有自己的判断力。更不要盲从伪权威，一定要建立自己的底层逻辑和判断力。再大的权威也有被利益锁定的时候。</p>
<h3 id="不留余地"><a href="# 不留余地" class="headerlink" title="不留余地"></a>不留余地 </h3><p> 人生中难免出现一些错误决策，或者说负向决策，但只要快速止损，通常不致命。而且只要肯积极反思复盘，也许可以有积极的一面。</p>
<p>旧文反复强调，不要 ALL In。如果你为一个负向决策 ALL In 了，那么想翻身就难了。<br>史玉柱经历过一次，当然他了不起，成功翻身了，但你问问他还想再来一次不？</p>
<p>人生最大的错误，不是做出错误的决策，而是为错误的决策 ALL In。</p>
<p>当然，有些年轻人，对未来收入预期较为乐观，毕竟年轻是本钱，ALL In 一些创业项目，也不见得就不行，但记住保障自己的身体和后续的职场口碑，留住这些，总还有机会。 但也尽量别负债，或者别承担超出自己收入能力的债务。</p>
<p>Q：但，有些时候，不知道谁是可信人，虽然上讲说了，但现实。。。。</p>
<p>A：可以参照一些牛人的观点和意见，但要有自己的判断和逻辑，不要盲从，不是一句都不听。</p>
<p>还有就是，可以看看牛人们做什么，如果能了解到，而不是听他们说什么，心口不一的太多了，特别是一些老江湖。</p>
<p>很多时候，大佬们做什么是演出来的，这个也挺难判断的。</p>
<p>幸存者偏差会告诉你，他们 ALL In , 并且成功了。<br>记住，你未必每次都幸运，甚至，你可能第一次就不幸运。</p>
<p>如果是中年人，想创业，想做一点有梦想的事情，至少给家人留一点保障。</p>
<h3 id="自我认知障碍"><a href="# 自我认知障碍" class="headerlink" title="自我认知障碍"></a>自我认知障碍 </h3><p> 高估自己，或者低估自己，都是容易造成错误决策的原因。<br>低估自己通常不致命，但面对好机会可能会错过。<br>而高估自己是有可能犯下大错的。太多错误决策来自于盲目自信，所谓淹死的都是会水的。我看过一个记载，一个专业的顶尖自由潜的救生员，是怎么出事送命的，过于自信，准备不足，在接应队友的时候连续犯错，结果葬送了自己</p>
<p>很多人会以为自己很专业，会以为自己可以控制和处理复杂的局面，但其实他们并没有他们想象的那么有能力。</p>
<p>说个可能让大家不太舒服的例子，科比不应该在天气恶劣的时候，驾驶飞机出行。</p>
<p>前一讲有自我认知评估的测试，建议读者回顾一下。自我认知是个长期的过程，需要不断地反思自己，剖析自己。当然，可能也需要至亲的好友的反馈，那种愿意讲真话的朋友。</p>
<p>网上有很多自我认知象限的测试，有兴趣的可以自己试试，其实我觉得有些也挺扯，有些可以作为参考，不用尽信，看看也没坏处。</p>
<h3 id="环境和市场认知障碍"><a href="# 环境和市场认知障碍" class="headerlink" title="环境和市场认知障碍"></a>环境和市场认知障碍 </h3><p> 我接触过很多创业者，也见识过很多非常不靠谱的创业方案。</p>
<p>说一些典型的认知问题。</p>
<p>对获客成本没概念，总以为用户可以轻松获取。</p>
<p>对流量运营的方法和技巧没概念。</p>
<p>对策略风控没概念，比如不知道所有 ugc 内容的平台，审核成本和安全边界都是非常非常超出常人认知的。</p>
<p>最怕的还有，对人性没概念，产品充满理想主义，缺乏对可能的破坏行为的预防措施。</p>
<p>这种认知问题带来的决策，当然都是问题重重，失败率极高。</p>
<p>那存在认知障碍的情况下，怎样能够不失败呢，两个要点，第一是学习能力足够快，能够在上线运营的过程中，最短时间发现问题并快速解决。第二是资源足够多，有足够的资源支持交学费，支持不断迭代前进。通常这二者缺一不可，稍微差一点都是必死无疑。</p>
<p>更好的理解这个世界，理解商业，理解社会环境，理解政策法规，理解市场运营的机制，提升对世界的认知，有助于你做出相对来说正确的决策。</p>
<p>特别要说的是，世界不是非黑即白，不是非此即彼，很多商业的逻辑不是简单的好坏对错，不能用二元思维去看世界。一个成功的项目，可能有诸多因素的共同成就，包括实力，包括资本，也包括运气。很多人喜欢简单归因，并自以为掌握了世界的真谛，这种认知是要不得的。</p>
<p>但是反过来说呢，做决策的时候也要懂得抓大放小，要知道有所取舍，不能说我理解世界的复杂性了，就必须要用非常复杂的策略来应对。理解复杂的世界，然后做出简单的应对策略，这才是非常非常优秀的，顶尖人才的特质。</p>
<p>那么总结一下，如何避免坏的决策，前面十条，对号入座。</p>
<h2 id="总结"><a href="# 总结" class="headerlink" title="总结"></a>总结 </h2><p> 那么我要分享的内容呢，差不多也就这些了，我最后总结一下</p>
<p>第一呢，如何尽量做出正确的决策，也就是我们需要基于什么做出决策。这是第一讲的内容，真的希望多回顾一下。</p>
<p>第二呢，是做出决策后，依然需要不断地复盘，以及针对性的调整。好的决策也可能是多次决策迭代出来的。</p>
<p>第三，做出错误的决策，或者说，不够优秀的决策，也不是说末日，认清现实后，继续追求最好的行动，可以减少错误决策的损失，甚至有可能让错误的决策发挥正确的效用。人们总是沉浸于后悔和懊恼，而缺乏改变现实的勇气和决心。</p>
<p>第四，我把常见的错误决策的原因列出来，也是希望大家能够和自己对照一下，尽量避免一些这样的情形。</p>
<h2 id="嘉宾时刻 -1"><a href="# 嘉宾时刻 -1" class="headerlink" title="嘉宾时刻"></a>嘉宾时刻 </h2><h3 id="stormzhang"><a href="#stormzhang" class="headerlink" title="stormzhang"></a>stormzhang</h3><p> 大家好，我是 stormzhang，这里很多人都认识我，我就不过多介绍了。感谢曹大的这次邀请，曹大是我的人生导师，能在曹大星球的年终福利课分享是我的荣幸。</p>
<p>曹大福利课的主题是决策，所以我也复盘了下从职场到创业这些年，我之所以能走到现在，发展的很顺利，其中有三次非常关键的决策我做对了，今天就跟大家聊聊我这三次经历，分享的不好请大家多多包涵。</p>
<p>第一次是决定测试转行开发，然后选择了移动开发。</p>
<p>其实我转行做开发的初衷很简单，就是偶然得知，做开发工资很高，于是我决定要转行开发，多赚钱。但是开发方向也分很多种，因为公司是做 .NET 的，所以我一开始选择的就是 .NET，但是我的主管说了一句话提醒我了，这句话说改变我人生都不为过。</p>
<p>他说：.NET 都十来年了，而且人家都在学校学了多少年了，你现在才学，会落后很多，不如选择最近比较火的移动开发。</p>
<p>我突然醒悟，觉得我主管说的特别对，那是 11 年，移动开发基本刚起步，所以我选择了移动开发，之后找到了一份开发工作，成功转型，并且吃到了红利。</p>
<p>这次决策虽然不是我自己做出的，是我的领导提醒了我，但是现在复盘，这次决策最正确的地方在于，跟随时代发展的趋势，大大缩短了我跟别人的差距，因为在面对新兴行业，新兴事物，所有人都是同样起点，这给了我很大的优势，因为本身已经比别人落后太多的我，能有一条路让我不比别人落后太多，这就是一种很大的优势。</p>
<p>第二次是，我在做技术那会，开始了写博客之旅，并且坚持写博客，坚持在社交平台输出观点，这为后来我积累影响力奠定了基础。</p>
<p>其实我之所以坚持写博客，输出观点，很大的一个原因是我看那些大神经常写博客，发微博，我虽然不知道这有什么用，但那时就认为这是大神的标配，如果我想当大神，那必须有这些，所以我就把这件事坚持下去了。</p>
<p>后面出现了知乎，公众号等平台，我依然坚持输出观点，输出文章，直到后面做出了很大的影响力，有很多读者关注，同时也发挥了巨大的商业价值。</p>
<p>现在回头看，让我坚持分享输出这个事的决策就是跟随，跟随牛人，跟随比你更厉害的人。即便当时我不知道写博客，发微博有什么用，我依然跟随他们的脚步。包括后面我坚定的写公众号，也是跟随冯老师，我很长一段时间写博客，写公众号一毛钱都不赚，也不知道如何赚钱，也不知道这些居然还可以赚钱，直到后面才慢慢发现原来写作这玩意还能赚钱。</p>
<p>所以，我后面一直坚定一条，在做重要决策的时候，一定要多重视比你牛逼的人的建议，多观察比你牛逼的人的行为，也许你现在看不懂，但是那些走在前面的前辈，他们的行为和观点，一定有他们的道理。</p>
<p>即便现在，我在创业过程中有一些困惑的时候，也多会去问冯大和曹大的建议，他们的建议我不一定会无脑相信，但我会非常重视，作为我最终做出正确决策的一个参考。</p>
<p>这几年，也有很多人追随我的动作，毫不夸张的说，一大堆技术号主都说受我影响，后面他们也进而做出了点成绩，其实道理是一样的，他们追随我，就如我当时追随那些技术大牛，追随冯老师曹大一个道理。</p>
<p>第三次是我的公众号在 17 年的时候改名了，从原来的 AndroidDeveloper 改成了现在的 stormzhang，很多人可能以为我的公众号一直是 stormzhang，其实不是，这个过程老读者是知道的。</p>
<p>因为我最初是做 Android 开发的，最初的内容也多是技术为主，但是到了 17 年下半年的时候，我自己本身在公司的工作已经不是纯技术了，我更多的参与产品，运营这块了，技术已经逐渐抛开了，另外一个市场的变化是，移动开发在那会其实已经有饱和甚至下坡状态了，再也没有我刚做开发那会的红利与火爆了。</p>
<p>所以我犹豫了很久，最终还是放弃了我深耕多年的 AndroidDeveloper，改成 stormzhang，公众号的内容也从原来的技术分享定位为互联网各领域的分享。</p>
<p>这次改名很痛苦，改名的前一段时间甚至取关很多，包括后面分享的内容不是纯技术了，每天都一堆人质疑，说我扯淡，说我不务正业。</p>
<p>曹大虽然找我比较晚，但是既然曹大开口当嘉宾，通宵 24 小时也得搞定，我的态度，关键时刻，绝不掉链子。</p>
<p>但是现在过来了，回头看，那次决策简直是正确的不能再正确。</p>
<p>曹大的课程里提到一点，市场是变化的，任何决策一定要适应市场，我这次决策刚好印证了这条，市场不仅在变化，其实关于我个人的认知，发展方向，能力等等也都在变化，那么这时候再死守原来的决策是一种看似稳妥，实则不求上进的做法。</p>
<p>我们做决策一定要追求长期，那次改名让我短期很痛，但是长期来看，是必须要经历的一个过程，现在蜕变之后，我逐渐的打造了 stormzhang 的个人品牌，并且覆盖领域人群更广，发展空间比之前要大的多的多。</p>
<p>以上就是我职场到创业的三次关键的决策，庆幸的是，都做对了，不然也不会走到现在，更没机会在这里分享了，总结了下，我这三次关键决策的几个原则：</p>
<p>1、一定要跟随时代发展的趋势，多尝试新事物，多拥抱新兴行业，务必记得我常说的一句话：早就是优势。</p>
<p>2、多追随牛人，多重视比你牛逼的人的建议，他们的一言一行，他们的一举一动都值得你格外关注。也许你当下的认知还不理解他们那么做的目的，但是不妨碍你立即追随，不然等你领悟的时候，已经晚了。</p>
<p>3、生活也好，职场也好，创业也罢，不要追求一招鲜吃遍天，要知道这个世界是一直在变化，世界在变化，也就意味着你的决策要跟上时代的变化，不然你只会被时代抛弃，就如我们中的大部分，都认为我们的父辈们思想落后，他们的决策大部分是落伍的一样。</p>
<p>4、我再额外补充一条，决策的目的是要对自己有利，所以我们做任何决策之前都要想想这个事情。</p>
<p>因为我做自媒体，我常看到的一种现象是，很多人总是对别人过于苛刻，觉得别人不行，喷这个喷那个，即便是你在网上的一句评论其实也是一种决策，互联网时代，你可以随意冒犯甚至中伤他人，但是想想对你有什么好处？然而多支持他人，多赞美他人反而是对自己有利的，未来的某一天，说不定你会因为对别人的支持与认可而得到意料不到的回馈。</p>
<p>追随的时候，要看权威的举动和言行是否一致</p>
<p>永远记得，宁结善缘，不种恶果。</p>
<p>以上，就是我的一点随意分享，希望对大家有点用处。最后，我看很多人说想见曹大本人，奈何没机会，这里经得曹大同意，也宣传下明天晚上 9 点我在视频号的跨年直播，其中会跟我的人生导师曹大、冯大连麦，一睹大佬风采，明晚不见不散，也希望大家以后，多支持曹大，多在曹大的星球贡献价值。</p>
<p><a href="http://note.youdao.com/s/MDBP0RhX" target="_blank" rel="noopener">http://note.youdao.com/s/MDBP0RhX</a></p>
<p>Q：张哥有没有遇到一些不靠谱的权威，是如何分析后绕开的</p>
<p>A：币圈一大堆不靠谱权威</p>
<p>Q：曹大和帅张晚上好，想请问一个关于职业方向选择以及该如何准备的问题。本人是华东师范大学西班牙语专业的大三生，英语水平也较好，平时对电脑软硬件一类的科技产品很感兴趣，但对编程方面接触很少。我希望以后职业上能进入互联网公司（如果可以的话），或是数码评测类的自媒体里面工作（兴趣的方向），但也有考虑当英语或西语老师，或是进入到能利用到这两门语言技能的岗位中工作（不管哪种方向，都只是想找到一份薪资还过得去的工作，我现在怕自己找不到工作）。所以想请问一下，现在可以为以后找工作做好哪些准备（比如该自学哪些技能），以及该如何定下之后的努力方向（例如该实习还是该考研），非常感谢！</p>
<p>A：看半天感觉好乱，你应该先找机会实习一下，理解一下职场需要什么样的人才。</p>
<p>Q：想请教一下，做技术开发应用一定要紧跟最前沿吗，有些新技术开发也有些忽悠人的，如果身边没有行业人士资源，如何判断这样的技术最后能否落地，或者成为新风口呢？非常感谢！</p>
<p>A：新技术你要看谁在用，哪些公司在支持，哪些团队在使用，学新技术也不一定非要抢在最前面。至少看到有强大的行业支撑</p>
<p>Q：权威的言论在网上比较容易查到，但怎么知道权威是否有做出对应的行为呢?</p>
<p>A：不知道的话，建议保持一定的怀疑。包括对我的言论也一样。</p>
<h3 id="蓝驰创投合伙人朱天宇"><a href="# 蓝驰创投合伙人朱天宇" class="headerlink" title="蓝驰创投合伙人朱天宇"></a>蓝驰创投合伙人朱天宇</h3><p><a href="https://www.brv.com.cn/" target="_blank" rel="noopener">https://www.brv.com.cn/</a></p>
<p>大家可以百度一下，投中了非常多的独角兽企业，是我当年的老同事，在投资领域目前如日中天，包括理想汽车，包括趣分期，美丽说等等等等。</p>
<p>作为资深投资人，欢迎他来分享他的关键决策。</p>
<p>一命二运三风水四积德五读书</p>
<p>三个选择：</p>
<ol>
<li>Gap year：自我发现 - 个人使命选择，空窗期 新疆 - 西藏 寻找自我</li>
<li>回到互联网行业：男怕入错行 - 风水选择</li>
<li>投资理想汽车：追求不确定中的确定性 - 价值观选择</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/04/what-is-context/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="cloud">
      <meta itemprop="description" content="Less is more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cloud's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/04/what-is-context/" class="post-title-link" itemprop="url">What is Context</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-04 14:34:10" itemprop="dateCreated datePublished" datetime="2020-12-04T14:34:10+08:00">2020-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-03 21:59:39" itemprop="dateModified" datetime="2021-01-03T21:59:39+08:00">2021-01-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>30k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>27 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="概述"><a href="# 概述" class="headerlink" title="概述"></a>概述 </h3><p>What is Context?<br> 这是一个好问题，官方的解释是这样:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Interface to global information about an application environment.  This is</span><br><span class="line"> * an abstract class whose implementation is provided by</span><br><span class="line"> * the Android system.  It</span><br><span class="line"> * allows access to application-specific resources and classes, as well as</span><br><span class="line"> * up-calls for application-level operations such as launching activities,</span><br><span class="line"> * broadcasting and receiving intents, etc.</span><br><span class="line"> *&#x2F;</span><br></pre></td></tr></table></figure>
<p>大致意思是一个应用环境的抽象类，它的实现由安卓系统提供。用来访问一些应用内资源、类，也可以调用系统服务开启 Activity 、Service 、发送和接收广播等</p>
<p>那么我们来看看 Context 的实现类 （图片来自 Gityuan 大佬）<br><img src="https://tvax3.sinaimg.cn/large/d7f9b0f4gy1glasf972q8j20t60lnmzj.jpg" alt="context"></p>
<p>根据类关系图，可以看到四大组件里 Activity 和 Service 都是 Context , 应用的 Context 数就是 Activity 、Service、Application 的个数之和，顺便说一下 Application 如果是多进程应用就会有多个</p>
<p>应用里有 Activity 、Service、Application 这些 Context ，我们先说说它们的共同点，它们都是 ContextWrapper 的子类，而 ContextWrapper 的成员变量 mBase 可以用来存放系统实现的 ContextImpl，这样我们在调用如 Activity 的 Context 方法时，都是通过静态代理的方式最终调用到 ContextImpl 的方法。我们调用 ContextWrapper 的 getBaseContext 方法就能拿到 ContextImpl 的实例 <br> 再说它们的不同点，它们有各自不同的生命周期；在功能上，只有 Activity 显示界面，正因为如此，Activity 继承的是 ContextThemeWrapper 提供一些关于主题，界面显示的能力，间接继承了 ContextWrapper ； 而 Applicaiton 、Service 都是直接继承 ContextWrapper ，所以我们要记住一点，凡是跟 UI 有关的，都应该用 Activity 作为 Context 来处理，否则要么会报错，要么 UI 会使用系统默认的主题。</p>
<p>接下来我们就来看看四大组件是如何初始化的，另外由于组件是依托于 Application 的，同时就研究下 Application 的初始化过程  </p>
<p>p.s. Android Environment: API-28</p>
<h3 id="组件创建流程"><a href="# 组件创建流程" class="headerlink" title="组件创建流程"></a>组件创建流程 </h3><h4 id="Activity 创建–-gt-performLaunchActivity"><a href="#Activity 创建–-gt-performLaunchActivity" class="headerlink" title="Activity 创建–&gt;performLaunchActivity"></a>Activity 创建–&gt;performLaunchActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**  Core implementation of activity launch. */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">        ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">        <span class="comment">// 1. 获取 LoadedApk 对象</span></span><br><span class="line">        <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                    Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 2. 创建 ContextImpl 对象</span></span><br><span class="line">        ContextImpl appContext = createBaseContextForActivity(r);</span><br><span class="line">        Activity activity = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3. 通过 ContextImpl 获取类加载器，传入 Instrumentation 创建 Activity 对象</span></span><br><span class="line">            java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">            r.intent.setExtrasClassLoader(cl);</span><br><span class="line">            r.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                r.state.setClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to instantiate activity"</span> + component</span><br><span class="line">                    + <span class="string">":"</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 4. 创建 Application 对象</span></span><br><span class="line">            Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">                Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">                <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    config.updateFrom(r.overrideConfig);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Launching activity"</span></span><br><span class="line">                        + r.activityInfo.name + <span class="string">"with config"</span> + config);</span><br><span class="line">                Window window = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">                    window = r.mPendingRemoveWindow;</span><br><span class="line">                    r.mPendingRemoveWindow = <span class="keyword">null</span>;</span><br><span class="line">                    r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                appContext.setOuterContext(activity);</span><br><span class="line">                <span class="comment">// 4. 将 ContextImpl 与 Activity 绑定</span></span><br><span class="line">                activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window, r.configCallback);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    activity.mIntent = customIntent;</span><br><span class="line">                &#125;</span><br><span class="line">                r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">                checkAndBlockForNetworkAccess();</span><br><span class="line">                activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line">                <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                    activity.setTheme(theme);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// 5. 执行 Activity 的 onCreate() 方法回调</span></span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                        <span class="string">"Activity"</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                        <span class="string">"did not call through to super.onCreate()"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.activity = activity;</span><br><span class="line">            &#125;</span><br><span class="line">            r.setState(ON_CREATE);</span><br><span class="line"></span><br><span class="line">            mActivities.put(r.token, r);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to start activity"</span> + component</span><br><span class="line">                    + <span class="string">":"</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Activity 创建流程"><a href="#Activity 创建流程" class="headerlink" title="Activity 创建流程"></a>Activity 创建流程</h4><ol>
<li>获取 LoadedApk 对象</li>
<li>创建 ContextImpl 对象</li>
<li>通过 ContextImpl 获取类加载器，传入 Instrumentation 创建 Activity 对象</li>
<li>将 ContextImpl 与 Activity 绑定</li>
<li>执行 Activity 的 onCreate()方法回调</li>
</ol>
<h4 id="Service 创建–-gt-handleCreateService"><a href="#Service 创建–-gt-handleCreateService" class="headerlink" title="Service 创建–&gt;handleCreateService"></a>Service 创建–&gt;handleCreateService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">        <span class="comment">// we are back active so skip it.</span></span><br><span class="line">        unscheduleGcIdler();</span><br><span class="line">        <span class="comment">// 1. 获取 LoadedApk 对象 </span></span><br><span class="line">        LoadedApk packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                data.info.applicationInfo, data.compatInfo);</span><br><span class="line">        Service service = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. 通过 LoadedApk 获取类加载器，创建 Service 对象</span></span><br><span class="line">            java.lang.ClassLoader cl = packageInfo.getClassLoader();</span><br><span class="line">            service = packageInfo.getAppFactory()</span><br><span class="line">                    .instantiateService(cl, data.info.name, data.intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to instantiate service"</span> + data.info.name</span><br><span class="line">                    + <span class="string">":"</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Creating service"</span> + data.info.name);</span><br><span class="line">            <span class="comment">// 3. 创建 ContextImpl 对象</span></span><br><span class="line">            ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo);</span><br><span class="line">            context.setOuterContext(service);</span><br><span class="line">            <span class="comment">// 4. 创建 Application 对象</span></span><br><span class="line">            Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">            <span class="comment">// 5. 将 ContextImpl 与 Service 绑定</span></span><br><span class="line">            service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app,</span><br><span class="line">                    ActivityManager.getService());</span><br><span class="line">            <span class="comment">// 6. 执行 Service 的 onCreate() 方法回调</span></span><br><span class="line">            service.onCreate();</span><br><span class="line">            mServices.put(data.token, service);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 7. 通知 ActivityManagerService 当前 Service 异步执行</span></span><br><span class="line">                ActivityManager.getService().serviceDoneExecuting(</span><br><span class="line">                        data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to create service"</span> + data.info.name</span><br><span class="line">                    + <span class="string">":"</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Service 创建流程"><a href="#Service 创建流程" class="headerlink" title="Service 创建流程"></a>Service 创建流程</h4><ol>
<li>获取 LoadedApk 对象</li>
<li>通过 LoadedApk 获取类加载器，创建 Service 对象</li>
<li>创建 ContextImpl 对象</li>
<li>创建 Application 对象</li>
<li>将 ContextImpl, Application 与 Service 绑定</li>
<li>执行 Service 的 onCreate()方法回调</li>
<li>通知 ActivityManagerService 当前 Service 异步执行</li>
</ol>
<h4 id="BroadcastReceiver 创建–-gt-handleReceiver"><a href="#BroadcastReceiver 创建–-gt-handleReceiver" class="headerlink" title="BroadcastReceiver 创建–&gt;handleReceiver"></a>BroadcastReceiver 创建–&gt;handleReceiver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleReceiver</span><span class="params">(ReceiverData data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">        <span class="comment">// we are back active so skip it.</span></span><br><span class="line">        unscheduleGcIdler();</span><br><span class="line"></span><br><span class="line">        String component = data.intent.getComponent().getClassName();</span><br><span class="line">        <span class="comment">// 1. 获取 LoadedApk 对象 </span></span><br><span class="line">        LoadedApk packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                data.info.applicationInfo, data.compatInfo);</span><br><span class="line"></span><br><span class="line">        IActivityManager mgr = ActivityManager.getService();</span><br><span class="line"></span><br><span class="line">        Application app;</span><br><span class="line">        BroadcastReceiver receiver;</span><br><span class="line">        ContextImpl context;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. 创建 Application 对象</span></span><br><span class="line">            app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">            <span class="comment">// 3. 获取 ContextImpl 对象</span></span><br><span class="line">            context = (ContextImpl) app.getBaseContext();</span><br><span class="line">            <span class="keyword">if</span> (data.info.splitName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                context = (ContextImpl) context.createContextForSplit(data.info.splitName);</span><br><span class="line">            &#125;</span><br><span class="line">            java.lang.ClassLoader cl = context.getClassLoader();</span><br><span class="line">            data.intent.setExtrasClassLoader(cl);</span><br><span class="line">            data.intent.prepareToEnterProcess();</span><br><span class="line">            data.setExtrasClassLoader(cl);</span><br><span class="line">            <span class="comment">// 4. 通过 ContextImpl 获取类加载器，创建 BroadcastReceiver 对象 </span></span><br><span class="line">            receiver = packageInfo.getAppFactory()</span><br><span class="line">                    .instantiateReceiver(cl, data.info.name, data.intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.i(TAG,</span><br><span class="line">                    <span class="string">"Finishing failed broadcast to"</span> + data.intent.getComponent());</span><br><span class="line">            data.sendFinished(mgr);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate receiver"</span> + component</span><br><span class="line">                + <span class="string">":"</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sCurrentBroadcastIntent.set(data.intent);</span><br><span class="line">            receiver.setPendingResult(data);</span><br><span class="line">            <span class="comment">// 5. 执行 BroadcastReceiver 的 onReceive() 方法回调</span></span><br><span class="line">            receiver.onReceive(context.getReceiverRestrictedContext(),</span><br><span class="line">                    data.intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.i(TAG,</span><br><span class="line">                    <span class="string">"Finishing failed broadcast to"</span> + data.intent.getComponent());</span><br><span class="line">            data.sendFinished(mgr);</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(receiver, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to start receiver"</span> + component</span><br><span class="line">                    + <span class="string">":"</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            sCurrentBroadcastIntent.set(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (receiver.getPendingResult() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            data.finish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="BroadcastReceiver 创建流程"><a href="#BroadcastReceiver 创建流程" class="headerlink" title="BroadcastReceiver 创建流程"></a>BroadcastReceiver 创建流程</h4><ol>
<li>获取 LoadedApk 对象</li>
<li>创建 Application 对象</li>
<li>获取 ContextImpl 对象</li>
<li>通过 ContextImpl 获取类加载器，创建 BroadcastReceiver 对象</li>
<li>执行 BroadcastReceiver 的 onReceive()方法回调</li>
</ol>
<h4 id="ContentProvider 创建–-gt-installProvider"><a href="#ContentProvider 创建–-gt-installProvider" class="headerlink" title="ContentProvider 创建–&gt;installProvider"></a>ContentProvider 创建–&gt;installProvider</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ContentProviderHolder <span class="title">installProvider</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">            ContentProviderHolder holder, ProviderInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> noisy, <span class="keyword">boolean</span> noReleaseNeeded, <span class="keyword">boolean</span> stable)</span> </span>&#123;</span><br><span class="line">        ContentProvider localProvider = <span class="keyword">null</span>;</span><br><span class="line">        IContentProvider provider;</span><br><span class="line">        <span class="keyword">if</span> (holder == <span class="keyword">null</span> || holder.provider == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Context c = <span class="keyword">null</span>;</span><br><span class="line">            ApplicationInfo ai = info.applicationInfo;</span><br><span class="line">            <span class="comment">// 1. 获取 Context 对象</span></span><br><span class="line">            <span class="keyword">if</span> (context.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">                c = context;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInitialApplication != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    mInitialApplication.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">                c = mInitialApplication;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    c = context.createPackageContext(ai.packageName,</span><br><span class="line">                            Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                    <span class="comment">// Ignore</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 2. 通过 Context 获取类加载器，创建 ContentProvider 对象</span></span><br><span class="line">                <span class="keyword">final</span> java.lang.ClassLoader cl = c.getClassLoader();</span><br><span class="line">                LoadedApk packageInfo = peekPackageInfo(ai.packageName, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// System startup case.</span></span><br><span class="line">                    packageInfo = getSystemContext().mPackageInfo;</span><br><span class="line">                &#125;</span><br><span class="line">                localProvider = packageInfo.getAppFactory()</span><br><span class="line">                        .instantiateProvider(cl, info.name);</span><br><span class="line">                provider = localProvider.getIContentProvider();</span><br><span class="line">                <span class="comment">// 3. 将 Context 与 ContentProvider 绑定</span></span><br><span class="line">                localProvider.attachInfo(c, info);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (java.lang.Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mInstrumentation.onException(<span class="keyword">null</span>, e)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                            <span class="string">"Unable to get provider"</span> + info.name</span><br><span class="line">                            + <span class="string">":"</span> + e.toString(), e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            provider = holder.provider;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> retHolder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ContentProvider 创建流程"><a href="#ContentProvider 创建流程" class="headerlink" title="ContentProvider 创建流程"></a>ContentProvider 创建流程</h4><ol>
<li>获取 Context 对象</li>
<li>通过 Context 获取类加载器，创建 ContentProvider 对象</li>
<li>将 Context 与 ContentProvider 绑定</li>
</ol>
<h4 id="Application 创建–-gt-handleBindApplication"><a href="#Application 创建–-gt-handleBindApplication" class="headerlink" title="Application 创建–&gt;handleBindApplication"></a>Application 创建–&gt;handleBindApplication</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 1. 获取 LoadedApk 对象 </span></span><br><span class="line">        data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 2. 创建 ContextImpl 对象</span></span><br><span class="line">        <span class="keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="keyword">this</span>, data.info);</span><br><span class="line">        updateLocaleListFromAppContext(appContext,</span><br><span class="line">                mResourcesManager.getConfiguration().getLocales());</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">if</span> (ii != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> LoadedApk pi = getPackageInfo(instrApp, data.compatInfo,</span><br><span class="line">                    appContext.getClassLoader(), <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">final</span> ContextImpl instrContext = ContextImpl.createAppContext(<span class="keyword">this</span>, pi);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 3. 通过 ContextImpl 获取类加载器，创建 Instrumentation 对象</span></span><br><span class="line">                <span class="keyword">final</span> ClassLoader cl = instrContext.getClassLoader();</span><br><span class="line">                mInstrumentation = (Instrumentation)</span><br><span class="line">                    cl.loadClass(data.instrumentationName.getClassName()).newInstance();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to instantiate instrumentation"</span></span><br><span class="line">                    + data.instrumentationName + <span class="string">":"</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ComponentName component = <span class="keyword">new</span> ComponentName(ii.packageName, ii.name);</span><br><span class="line">            mInstrumentation.init(<span class="keyword">this</span>, instrContext, appContext, component,</span><br><span class="line">                    data.instrumentationWatcher, data.instrumentationUiAutomationConnection);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">            mInstrumentation.basicInit(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Application app;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// If the app is being launched for full backup or restore, bring it up in</span></span><br><span class="line">            <span class="comment">// a restricted environment with the base application class.</span></span><br><span class="line">            <span class="comment">// 4. 创建 Application 对象</span></span><br><span class="line">            app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Propagate autofill compat state</span></span><br><span class="line">            app.setAutofillCompatibilityEnabled(data.autofillCompatibilityEnabled);</span><br><span class="line"></span><br><span class="line">            mInitialApplication = app;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// don't bring up providers in restricted mode; they may depend on the</span></span><br><span class="line">            <span class="comment">// app's custom Application class</span></span><br><span class="line">            <span class="keyword">if</span> (!data.restrictedBackupMode) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!ArrayUtils.isEmpty(data.providers)) &#123;</span><br><span class="line">                    <span class="comment">// 5. 初始化 ContentProvider</span></span><br><span class="line">                    installContentProviders(app, data.providers);</span><br><span class="line">                    <span class="comment">// For process that contains content providers, we want to</span></span><br><span class="line">                    <span class="comment">// ensure that the JIT is enabled "at some point".</span></span><br><span class="line">                    mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Do this after providers, since instrumentation tests generally start their</span></span><br><span class="line">            <span class="comment">// test thread at this point, and we don't want that racing.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Exception thrown in onCreate() of "</span></span><br><span class="line">                    + data.instrumentationName + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 6. 执行 Application 的 onCreate() 方法回调</span></span><br><span class="line">                mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                      <span class="string">"Unable to create application "</span> + app.getClass().getName()</span><br><span class="line">                      + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Application 创建流程"><a href="#Application 创建流程" class="headerlink" title="Application 创建流程"></a>Application 创建流程</h4><ol>
<li>获取 LoadedApk 对象</li>
<li>创建 ContextImpl 对象</li>
<li>通过 ContextImpl 获取类加载器，创建 Instrumentation 对象</li>
<li>创建 Application 对象</li>
<li>初始化 ContentProvider</li>
<li>执行 Application 的 onCreate()方法回调</li>
</ol>
<h3 id="核心对象"><a href="# 核心对象" class="headerlink" title="核心对象"></a>核心对象 </h3><p> 根据以上创建流程，可以发现 LoadedApk、ContextImpl、Application 是核心创建对象</p>
<h4 id="LoadedApk- 创建"><a href="#LoadedApk- 创建" class="headerlink" title="LoadedApk 创建"></a>LoadedApk 创建</h4><h5 id="ActivityThread-getPackageInfo"><a href="#ActivityThread-getPackageInfo" class="headerlink" title="ActivityThread.getPackageInfo"></a>ActivityThread.getPackageInfo</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> LoadedApk <span class="title">getPackageInfo</span><span class="params">(ApplicationInfo ai, CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> includeCode = (flags&amp;Context.CONTEXT_INCLUDE_CODE) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> securityViolation = includeCode &amp;&amp; ai.uid != <span class="number">0</span></span><br><span class="line">                &amp;&amp; ai.uid != Process.SYSTEM_UID &amp;&amp; (mBoundApplication != <span class="keyword">null</span></span><br><span class="line">                        ? !UserHandle.isSameApp(ai.uid, mBoundApplication.appInfo.uid)</span><br><span class="line">                        : <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">boolean</span> registerPackage = includeCode &amp;&amp; (flags&amp;Context.CONTEXT_REGISTER_PACKAGE) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((flags&amp;(Context.CONTEXT_INCLUDE_CODE</span><br><span class="line">                |Context.CONTEXT_IGNORE_SECURITY))</span><br><span class="line">                == Context.CONTEXT_INCLUDE_CODE) &#123;</span><br><span class="line">            <span class="keyword">if</span> (securityViolation) &#123;</span><br><span class="line">                String msg = <span class="string">"Requesting code from"</span> + ai.packageName</span><br><span class="line">                        + <span class="string">"(with uid"</span> + ai.uid + <span class="string">")"</span>;</span><br><span class="line">                <span class="keyword">if</span> (mBoundApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    msg = msg + <span class="string">"to be run in process"</span></span><br><span class="line">                        + mBoundApplication.processName + <span class="string">"(with uid"</span></span><br><span class="line">                        + mBoundApplication.appInfo.uid + <span class="string">")"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getPackageInfo(ai, compatInfo, <span class="keyword">null</span>, securityViolation, includeCode,</span><br><span class="line">                registerPackage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当 securityViolation 是 true 时，抛出 SecurityException</p>
<h5 id="ActivityThread-getPackageInfo-1"><a href="#ActivityThread-getPackageInfo-1" class="headerlink" title="ActivityThread.getPackageInfo"></a>ActivityThread.getPackageInfo</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> LoadedApk <span class="title">getPackageInfo</span><span class="params">(ApplicationInfo aInfo, CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            ClassLoader baseLoader, <span class="keyword">boolean</span> securityViolation, <span class="keyword">boolean</span> includeCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> registerPackage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> differentUser = (UserHandle.myUserId() != UserHandle.getUserId(aInfo.uid));</span><br><span class="line">        <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">            WeakReference&lt;LoadedApk&gt; ref;</span><br><span class="line">            <span class="keyword">if</span> (differentUser) &#123;</span><br><span class="line">                <span class="comment">// Caching not supported across users</span></span><br><span class="line">                ref = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (includeCode) &#123;</span><br><span class="line">                <span class="comment">// 查询包名对应的 LoadedApk 弱引用对象</span></span><br><span class="line">                ref = mPackages.get(aInfo.packageName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ref = mResourcePackages.get(aInfo.packageName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LoadedApk packageInfo = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span> || (packageInfo.mResources != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; !packageInfo.mResources.getAssets().isUpToDate())) &#123;</span><br><span class="line">                <span class="comment">// 创建 LoadedApk 对象</span></span><br><span class="line">                packageInfo =</span><br><span class="line">                    <span class="keyword">new</span> LoadedApk(<span class="keyword">this</span>, aInfo, compatInfo, baseLoader,</span><br><span class="line">                            securityViolation, includeCode &amp;&amp;</span><br><span class="line">                            (aInfo.flags&amp;ApplicationInfo.FLAG_HAS_CODE) != <span class="number">0</span>, registerPackage);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mSystemThread &amp;&amp; <span class="string">"android"</span>.equals(aInfo.packageName)) &#123;</span><br><span class="line">                    packageInfo.installSystemApplicationInfo(aInfo,</span><br><span class="line">                            getSystemContext().mPackageInfo.getClassLoader());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (differentUser) &#123;</span><br><span class="line">                    <span class="comment">// Caching not supported across users</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (includeCode) &#123;</span><br><span class="line">                    <span class="comment">// 创建 LoadedApk 弱饮用对象并加入到 mPackages</span></span><br><span class="line">                    mPackages.put(aInfo.packageName,</span><br><span class="line">                            <span class="keyword">new</span> WeakReference&lt;LoadedApk&gt;(packageInfo));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mResourcePackages.put(aInfo.packageName,</span><br><span class="line">                            <span class="keyword">new</span> WeakReference&lt;LoadedApk&gt;(packageInfo));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> packageInfo;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>‘final ArrayMap&lt;String, WeakReference<LoadedApk>&gt; mPackages = new ArrayMap&lt;&gt;();’ 记录了每一个包名对应的 LoadedApk 对象的弱引用,<br>当 mPackages 中找不到对应的 LoadedApk 对象时，则创建该 LoadedApk 对象并加入到 mPackages 中</p>
<h4 id="Application- 创建"><a href="#Application- 创建" class="headerlink" title="Application 创建"></a>Application 创建</h4><h5 id="LoadedApk-makeApplication"><a href="#LoadedApk-makeApplication" class="headerlink" title="LoadedApk.makeApplication"></a>LoadedApk.makeApplication</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadedApk</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 保证一个 LoadedApk 对象只创建一个对应的 Application 对象</span></span><br><span class="line">        <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mApplication;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"makeApplication"</span>);</span><br><span class="line"></span><br><span class="line">        Application app = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        String appClass = mApplicationInfo.className;</span><br><span class="line">        <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">// 默认类名 或 forceDefaultAppClass 为 true</span></span><br><span class="line">            appClass = <span class="string">"android.app.Application"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">            <span class="keyword">if</span> (!mPackageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,</span><br><span class="line">                        <span class="string">"initializeJavaContextClassLoader"</span>);</span><br><span class="line">                initializeJavaContextClassLoader();</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 根据 mActivityThread 创建对应 ContextImpl 对象</span></span><br><span class="line">            ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">// 创建 Application 并把 ContextImpl 对象赋值给 Application 的 mBase 变量</span></span><br><span class="line">            <span class="comment">// 并把当前 LoadedApk 对象赋值给 Application 的 mLoadedApk 变量</span></span><br><span class="line">            app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                    cl, appClass, appContext);</span><br><span class="line">            <span class="comment">// 把 application 对象赋值给 ContextImpl 的 mOuterContext 变量</span></span><br><span class="line">            appContext.setOuterContext(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to instantiate application"</span> + appClass</span><br><span class="line">                    + <span class="string">":"</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mActivityThread.mAllApplications.add(app);</span><br><span class="line">        mApplication = app;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (instrumentation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                instrumentation.callApplicationOnCreate(app);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!instrumentation.onException(app, e)) &#123;</span><br><span class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"Unable to create application"</span> + app.getClass().getName()</span><br><span class="line">                        + <span class="string">":"</span> + e.toString(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程梳理：</p>
<ol>
<li>根据包名是否包含”android”判断调用 initializeJavaContextClassLoader()方法</li>
<li>根据 mActivityThread 创建对应 ContextImpl 对象</li>
<li>创建 Application 并赋值 mBase 变量和 mLoadedApk 变量</li>
<li>把刚创建的 plication 对象保存到 ContextImpl 的 mOuterContext 变量</li>
</ol>
<p>关于应用类名采用的是 Apk 中声明的应用类名, 即 Manifest.xml 中定义的类名. 有两种特殊情况会强制 设置应用类名为”android.app.Application”:</p>
<ol>
<li>当 forceDefaultAppClass=true, 目前只有 system_server 进程初始化包名为”android”的 apk 过程会调用</li>
<li>Apk 没有自定义应用类名的情况</li>
</ol>
<h5 id="Instrumentation-newApplication"><a href="#Instrumentation-newApplication" class="headerlink" title="Instrumentation.newApplication"></a>Instrumentation.newApplication</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Instrumentation</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(ClassLoader cl, String className, Context context)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span></span><br><span class="line"><span class="function">            ClassNotFoundException </span>&#123;</span><br><span class="line">        Application app = getFactory(context.getPackageName())</span><br><span class="line">                .instantiateApplication(cl, className);</span><br><span class="line">        app.attach(context); <span class="comment">// 绑定 application 与 context</span></span><br><span class="line">        <span class="keyword">return</span> app;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="AppComponentFactory-instantiateApplication"><a href="#AppComponentFactory-instantiateApplication" class="headerlink" title="AppComponentFactory.instantiateApplication"></a>AppComponentFactory.instantiateApplication</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppComponentFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@NonNull</span> <span class="function">Application <span class="title">instantiateApplication</span><span class="params">(@NonNull ClassLoader cl,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull String className)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 Application</span></span><br><span class="line">        <span class="keyword">return</span> (Application) cl.loadClass(className).newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ContextImpl- 创建"><a href="#ContextImpl- 创建" class="headerlink" title="ContextImpl 创建"></a>ContextImpl 创建 </h4><p> 根据以上创建流程，可以发现不同组件创建 ContextImpl 的方法不同</p>
<ul>
<li>Activity: ActivityThread.createBaseContextForActivity()</li>
<li>Service/Application: ContextImpl.createAppContext()</li>
<li>BroadcastReceiver: Application.getBaseContext()</li>
<li>ContentProvider: Context.createPackageContext()</li>
</ul>
<h5 id="Activity–-gt-ActivityThread-createBaseContextForActivity"><a href="#Activity–-gt-ActivityThread-createBaseContextForActivity" class="headerlink" title="Activity–&gt;ActivityThread.createBaseContextForActivity"></a>Activity–&gt;ActivityThread.createBaseContextForActivity</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> ContextImpl <span class="title">createBaseContextForActivity</span><span class="params">(ActivityClientRecord r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> displayId;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            displayId = ActivityManager.getService().getActivityDisplayId(r.token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ContextImpl appContext = ContextImpl.createActivityContext(</span><br><span class="line">                <span class="keyword">this</span>, r.packageInfo, r.activityInfo, r.token, displayId, r.overrideConfig);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> appContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextImpl</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createActivityContext</span><span class="params">(ActivityThread mainThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            LoadedApk packageInfo, ActivityInfo activityInfo, IBinder activityToken, <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration overrideConfiguration)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"packageInfo"</span>);</span><br><span class="line"></span><br><span class="line">        String[] splitDirs = packageInfo.getSplitResDirs();</span><br><span class="line">        ClassLoader classLoader = packageInfo.getClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (packageInfo.getApplicationInfo().requestsIsolatedSplitLoading()) &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_RESOURCES, <span class="string">"SplitDependencies"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                classLoader = packageInfo.getSplitClassLoader(activityInfo.splitName);</span><br><span class="line">                splitDirs = packageInfo.getSplitPaths(activityInfo.splitName);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Nothing above us can handle a NameNotFoundException, better crash.</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_RESOURCES);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ContextImpl context = <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread, packageInfo, activityInfo.splitName,</span><br><span class="line">                activityToken, <span class="keyword">null</span>, <span class="number">0</span>, classLoader);</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Service-Application–-gt-ContextImpl-createAppContext"><a href="#Service-Application–-gt-ContextImpl-createAppContext" class="headerlink" title="Service/Application–&gt;ContextImpl.createAppContext"></a>Service/Application–&gt;ContextImpl.createAppContext</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextImpl</span> <span class="keyword">extends</span> <span class="title">Context</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createAppContext</span><span class="params">(ActivityThread mainThread, LoadedApk packageInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"packageInfo"</span>);</span><br><span class="line">        ContextImpl context = <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread, packageInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>,</span><br><span class="line">                <span class="keyword">null</span>);</span><br><span class="line">        context.setResources(packageInfo.getResources());</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="BroadcastReceiver–-gt-Application-getBaseContext"><a href="#BroadcastReceiver–-gt-Application-getBaseContext" class="headerlink" title="BroadcastReceiver–&gt;Application.getBaseContext"></a>BroadcastReceiver–&gt;Application.getBaseContext</h5><p>getBaseContext()返回的 mBase 对象，就是在 Application 在创建时赋值的 ContextImpl 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextWrapper</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">getBaseContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBase;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ContentProvider–-gt-Context-createPackageContext"><a href="#ContentProvider–-gt-Context-createPackageContext" class="headerlink" title="ContentProvider–&gt;Context.createPackageContext"></a>ContentProvider–&gt;Context.createPackageContext</h5><p>其实是调用了 mBase 的 createPackageContext()方法，而 mBase 就是 ContextImpl 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextImpl</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">createPackageContext</span><span class="params">(String packageName, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createPackageContextAsUser(packageName, flags, mUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">createPackageContextAsUser</span><span class="params">(String packageName, <span class="keyword">int</span> flags, UserHandle user)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (packageName.equals(<span class="string">"system"</span>) || packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">            <span class="comment">// The system resources are loaded in every application, so we can safely copy</span></span><br><span class="line">            <span class="comment">// the context without reloading Resources.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ContextImpl(<span class="keyword">this</span>, mMainThread, mPackageInfo, <span class="keyword">null</span>, mActivityToken, user,</span><br><span class="line">                    flags, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LoadedApk pi = mMainThread.getPackageInfo(packageName, mResources.getCompatibilityInfo(),</span><br><span class="line">                flags | CONTEXT_REGISTER_PACKAGE, user.getIdentifier());</span><br><span class="line">        <span class="keyword">if</span> (pi != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ContextImpl c = <span class="keyword">new</span> ContextImpl(<span class="keyword">this</span>, mMainThread, pi, <span class="keyword">null</span>, mActivityToken, user,</span><br><span class="line">                    flags, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> displayId = mDisplay != <span class="keyword">null</span></span><br><span class="line">                    ? mDisplay.getDisplayId() : Display.DEFAULT_DISPLAY;</span><br><span class="line"></span><br><span class="line">            c.setResources(createResources(mActivityToken, pi, <span class="keyword">null</span>, displayId, <span class="keyword">null</span>,</span><br><span class="line">                    getDisplayAdjustments(displayId).getCompatibilityInfo()));</span><br><span class="line">            <span class="keyword">if</span> (c.mResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> c;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Should be a better exception.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManager.NameNotFoundException(</span><br><span class="line">                <span class="string">"Application package"</span> + packageName + <span class="string">"not found"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Context-attach"><a href="#Context-attach" class="headerlink" title="Context attach"></a>Context attach</h3><p>从以上创建过程，可以看到 Context 的身影无处不在，那么 Context 是如何与四大组件和 Application 绑定的呢？</p>
<h4 id="Activity-amp-Context"><a href="#Activity-amp-Context" class="headerlink" title="Activity &amp; Context"></a>Activity &amp; Context</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Activity</span> <span class="keyword">extends</span> <span class="title">ContextThemeWrapper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            Window window, ActivityConfigCallback activityConfigCallback)</span> </span>&#123;</span><br><span class="line">        attachBaseContext(context); <span class="comment">// 调用父类方法赋值 mBase 变量</span></span><br><span class="line"></span><br><span class="line">        mFragments.attachHost(<span class="keyword">null</span> <span class="comment">/*parent*/</span>);</span><br><span class="line"></span><br><span class="line">        mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window, activityConfigCallback);</span><br><span class="line">        mWindow.setWindowControllerCallback(<span class="keyword">this</span>);</span><br><span class="line">        mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">        mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line">        mWindow.getLayoutInflater().setPrivateFactory(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</span><br><span class="line">            mWindow.setSoftInputMode(info.softInputMode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (info.uiOptions != <span class="number">0</span>) &#123;</span><br><span class="line">            mWindow.setUiOptions(info.uiOptions);</span><br><span class="line">        &#125;</span><br><span class="line">        mUiThread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        mMainThread = aThread;</span><br><span class="line">        mInstrumentation = instr;</span><br><span class="line">        mToken = token;</span><br><span class="line">        mIdent = ident;</span><br><span class="line">        mApplication = application;</span><br><span class="line">        mIntent = intent;</span><br><span class="line">        mReferrer = referrer;</span><br><span class="line">        mComponent = intent.getComponent();</span><br><span class="line">        mActivityInfo = info;</span><br><span class="line">        mTitle = title;</span><br><span class="line">        mParent = parent;</span><br><span class="line">        mEmbeddedID = id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将创建的 ContextImpl 对象赋值给父亲类 ContextWrapper 的 mBase 变量</p>
<h4 id="Service-amp-Context"><a href="#Service-amp-Context" class="headerlink" title="Service &amp; Context"></a>Service &amp; Context</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Service</span> <span class="keyword">extends</span> <span class="title">ContextWrapper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityThread thread, String className, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">            Application application, Object activityManager)</span> </span>&#123;</span><br><span class="line">        attachBaseContext(context); <span class="comment">// 调用父类方法赋值 mBase 变量</span></span><br><span class="line">        mThread = thread;           <span class="comment">// <span class="doctag">NOTE:</span>  unused - remove?</span></span><br><span class="line">        mClassName = className;</span><br><span class="line">        mToken = token;</span><br><span class="line">        mApplication = application;</span><br><span class="line">        mActivityManager = (IActivityManager)activityManager;</span><br><span class="line">        mStartCompatibility = getApplicationInfo().targetSdkVersion</span><br><span class="line">                &lt; Build.VERSION_CODES.ECLAIR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将创建的 ContextImpl 对象赋值给父亲类 ContextWrapper 的 mBase 变量</p>
<h4 id="BroadcastReceiver-amp-Context"><a href="#BroadcastReceiver-amp-Context" class="headerlink" title="BroadcastReceiver &amp; Context"></a>BroadcastReceiver &amp; Context</h4><p><code>receiver.onReceive(context.getReceiverRestrictedContext(),data.intent);</code><br>是将 getOuterContext()获得的 ContextImpl 对象封装到 ReceiverRestrictedContext 对象里面，<br>然后通过 onReceive()方法传递过去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextImpl</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> Context <span class="title">getReceiverRestrictedContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mReceiverRestrictedContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mReceiverRestrictedContext;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mReceiverRestrictedContext = <span class="keyword">new</span> ReceiverRestrictedContext(getOuterContext());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ContentProvider-amp-Context"><a href="#ContentProvider-amp-Context" class="headerlink" title="ContentProvider &amp; Context"></a>ContentProvider &amp; Context</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attachInfo</span><span class="params">(Context context, ProviderInfo info)</span> </span>&#123;</span><br><span class="line">        attachInfo(context, info, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attachInfo</span><span class="params">(Context context, ProviderInfo info, <span class="keyword">boolean</span> testing)</span> </span>&#123;</span><br><span class="line">        mNoPerms = testing;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Only allow it to be set once, so after the content service gives</span></span><br><span class="line"><span class="comment">         * this to us clients can't change it.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 将创建的 ContextImpl 对象赋值给 ContentProvider 的 mContext 变量 </span></span><br><span class="line">            mContext = context;</span><br><span class="line">            <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mTransport.mAppOpsManager = (AppOpsManager) context.getSystemService(</span><br><span class="line">                        Context.APP_OPS_SERVICE);</span><br><span class="line">            &#125;</span><br><span class="line">            mMyUid = Process.myUid();</span><br><span class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">                setReadPermission(info.readPermission);</span><br><span class="line">                setWritePermission(info.writePermission);</span><br><span class="line">                setPathPermissions(info.pathPermissions);</span><br><span class="line">                mExported = info.exported;</span><br><span class="line">                mSingleUser = (info.flags &amp; ProviderInfo.FLAG_SINGLE_USER) != <span class="number">0</span>;</span><br><span class="line">                setAuthorities(info.authority);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 执行 onCreate() 回调</span></span><br><span class="line">            ContentProvider.<span class="keyword">this</span>.onCreate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>将创建的 ContextImpl 对象赋值给 ContentProvider 的 mContext 变量</li>
<li>执行 ContentProvider 的 onCreate()方法回调</li>
</ol>
<h4 id="Application-amp-Context"><a href="#Application-amp-Context" class="headerlink" title="Application &amp; Context"></a>Application &amp; Context</h4><p>绑定过程发生在创建 Application 时，在 Instrumentation 类 newApplication()方法中调用了 attach()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">ContextWrapper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        attachBaseContext(context); <span class="comment">// 调用父类方法赋值 mBase 变量</span></span><br><span class="line">        mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>将创建的 ContextImpl 对象赋值给父类 ContextWrapper 的 mBase 变量</li>
<li>将当前的 LoadedApk 对象赋值给 Application 的 mLoadedApk 变量</li>
</ol>
<h4 id="Context- 核心方法"><a href="#Context- 核心方法" class="headerlink" title="Context 核心方法"></a>Context 核心方法</h4><ol>
<li>Activity.getApplication() 返回 Application 即当前 Activity 所属的 Application</li>
<li>Service.getApplication() 返回 Application 即当前 Service 所属的 Application</li>
<li>ContextWrapper.getBaseContext() 返回 ContextImpl 即 mBase 变量</li>
<li>ContextWrapper.getApplicationContext() 返回 Application</li>
<li>ContextImpl.getApplicationContext() 返回 Application</li>
<li>ContextImpl.getOuterContext() 返回 ContextImpl 即 mOuterContext 变量</li>
<li>ContextImpl.getApplicationInfo() 返回 ApplicationInfo 即 mPackageInfo.mApplicationInfo</li>
</ol>
<h5 id="getApplication"><a href="#getApplication" class="headerlink" title="getApplication"></a>getApplication</h5><ul>
<li>Activity 的 mApplication 变量是在 ActivityThread 类 performLaunchActivity()方法中调用 makeApplication()创建的，赋值是在 Activity 调用 attach()方法</li>
<li>Service 的 mApplication 变量是在 ActivityThread 类 handleCreateService()方法中调用 makeApplication()创建的，赋值是在 Service 调用 attach() 方法</li>
<li>BroadcastReceiver 虽然没有直接保存 mApplication 变量，但可以通过 onReceive()方法中的 ContextImpl 对象指向当前所在的 Application</li>
<li>ContentProvider 无法获取 Application，因为 Provider 创建时并没有初始化 application，所以其所在 application 不一定初始化</li>
</ul>
<h5 id="getApplicationContext"><a href="#getApplicationContext" class="headerlink" title="getApplicationContext"></a>getApplicationContext</h5><p><code>ContextWrapper.getApplicationContext()</code>是通过 mBase 变量，也就是 ContextImpl 对象去获取 applicationContext 的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextImpl</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (mPackageInfo != <span class="keyword">null</span>) ?</span><br><span class="line">                mPackageInfo.getApplication() : mMainThread.getApplication();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mPackageInfo 就是 LoadedApk 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadedApk</span> </span>&#123;</span><br><span class="line">    <span class="function">Application <span class="title">getApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mMainThread 就是 ActivityThread 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Application <span class="title">getApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mInitialApplication;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>mPackageInfo.getApplication(): 返回的是 LoadedApk.mApplication, 该变量初始化是在 makeApplication()方法中，对于同一个 apk 只会执行一次</li>
<li>mMainThread.getApplication(): 返回的是 ActivityThread.mInitialApplication, 该变量赋值方法有两个：</li>
<li><ul>
<li>ActivityThread.handleBindApplication()赋值;</li>
</ul>
</li>
<li><ul>
<li>system_server 进程的 ActivityThread.attach()赋值;</li>
</ul>
</li>
</ul>
<h5 id="getOuterContext"><a href="#getOuterContext" class="headerlink" title="getOuterContext"></a>getOuterContext</h5><p>ContextImpl 的 mOuterContext 对象默认是在 ContextImpl 创建时初始化的，另外也可以通过 setOuterContext()方法进行赋值。</p>
<ul>
<li>performLaunchActivity 的 createBaseContextForActivity 过程, mOuterContext 指向 Activity;</li>
<li>handleCreateService()过程, mOuterContext 指向 Service;</li>
<li>BroadcastReceiver/Provider 则采用默认值 ContextImpl;</li>
<li>makeApplication 过程, mOuterContext 指向 Application;</li>
</ul>
<h3 id="总结"><a href="# 总结" class="headerlink" title="总结"></a>总结 </h3><h4 id="组件创建"><a href="# 组件创建" class="headerlink" title="组件创建"></a> 组件创建</h4><p><img src="https://tva1.sinaimg.cn/large/d7f9b0f4gy1glbxt9886qj20jp06kgm7.jpg" alt="component-initialization"></p>
<p>每个 Apk 都对应唯一的 Application 对象和 LoadedApk 对象, 当 Apk 中任意组件的创建过程中, 当其所对应的的 LoadedApk 和 Application 没有初始化则会创建, 且只会创建一次.</p>
<p>另外大家会注意到唯有 Provider 在初始化过程并不会去创建所相应的 Application 对象. 也就意味着当有多个 Apk 运行在同一个进程的情况下,<br>第二个 Apk 通过 Provider 初始化过程再调用 getContext().getApplicationContext()返回的并非 Application 对象, 而是 NULL. 这里要注意会抛出空指针异常.</p>
<h4 id="Context-attach-1"><a href="#Context-attach-1" class="headerlink" title="Context attach"></a>Context attach</h4><p>Application:</p>
<ul>
<li>调用 attachBaseContext()将新创建 ContextImpl 赋值到父类 ContextWrapper.mBase 变量;</li>
<li>可通过 getBaseContext()获取该 ContextImpl;</li>
</ul>
<p>Activity/Service:</p>
<ul>
<li>调用 attachBaseContext() 将新创建 ContextImpl 赋值到父类 ContextWrapper.mBase 变量;</li>
<li>可通过 getBaseContext()获取该 ContextImpl;</li>
<li>可通过 getApplication()获取其所在的 Application 对象;</li>
</ul>
<p>ContentProvider:</p>
<ul>
<li>调用 attachInfo()将新创建 ContextImpl 保存到 ContentProvider.mContext 变量;</li>
<li>可通过 getContext()获取该 ContextImpl;</li>
</ul>
<p>BroadcastReceiver:</p>
<ul>
<li>在 onCreate 过程通过参数将 ReceiverRestrictedContext 传递过去的.</li>
</ul>
<p>ContextImpl:</p>
<ul>
<li>可通过 getApplicationContext()获取 Application;</li>
</ul>
<h4 id="getApplicationContext-1"><a href="#getApplicationContext-1" class="headerlink" title="getApplicationContext"></a>getApplicationContext</h4><p>绝大多数情况下, getApplication()和 getApplicationContext()这两个方法完全一致, 返回值也相同;<br> 那么两者到底有什么区别呢? 真正理解这个问题的人非常少. 接下来彻底地回答下这个问题:</p>
<p>getApplicationContext()这个的存在是 Android 历史原因. 我们都知道 getApplication()只存在于 Activity 和 Service 对象;<br>那么对于 BroadcastReceiver 和 ContentProvider 却无法获取 Application, 这时就需要一个能在 Context 上下文直接使用的方法, 那便是 getApplicationContext().</p>
<p>两者对比:</p>
<p>对于 Activity/Service 来说, getApplication()和 getApplicationContext()的返回值完全相同; 除非厂商修改过接口;<br>BroadcastReceiver 在 onReceive 的过程, 能使用 getBaseContext().getApplicationContext 获取所在 Application, 而无法使用 getApplication;<br>ContentProvider 能使用 getContext().getApplicationContext()获取所在 Application. 绝大多数情况下没有问题, 但是有可能会出现空指针的问题, 情况如下:<br>当同一个进程有多个 apk 的情况下, 对于第二个 apk 是由 provider 方式拉起的, 前面介绍过 provider 创建过程并不会初始化所在 application,<br>此时执行 getContext().getApplicationContext()返回的结果便是 NULL. 所以对于这种情况要做好判空.</p>
<p>Tips: 如果对于 Application 理解不够深刻, 建议 getApplicationContext()方法谨慎使用, 做好是否为空的判定, 防止出现空指针异常.</p>
<h3 id="参考资料"><a href="# 参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://gityuan.com/2017/04/09/android_context/" target="_blank" rel="noopener">http://gityuan.com/2017/04/09/android_context/</a><br><a href="https://www.yuque.com/beesx/beesandroid/sfzs75#d696d2a6" target="_blank" rel="noopener">https://www.yuque.com/beesx/beesandroid/sfzs75#d696d2a6</a>  </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/08/classic_movie_top/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="cloud">
      <meta itemprop="description" content="Less is more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cloud's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/08/classic_movie_top/" class="post-title-link" itemprop="url">经典电影 Top</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-08 11:02:44" itemprop="dateCreated datePublished" datetime="2020-08-08T11:02:44+08:00">2020-08-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-17 10:41:53" itemprop="dateModified" datetime="2021-03-17T10:41:53+08:00">2021-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Other/" itemprop="url" rel="index"><span itemprop="name">Other</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>963</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-10"><a href="#1-10" class="headerlink" title="1-10"></a>1-10</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">肖申克的救赎 </span><br><span class="line"></span><br><span class="line"> 霸王别姬 </span><br><span class="line"></span><br><span class="line"> 阿甘正传 </span><br><span class="line"></span><br><span class="line"> 这个杀手不太冷 </span><br><span class="line"></span><br><span class="line"> 泰坦尼克号 </span><br><span class="line"></span><br><span class="line"> 美丽人生 </span><br><span class="line"></span><br><span class="line"> 千与千寻 </span><br><span class="line"></span><br><span class="line"> 辛德勒的名单 </span><br><span class="line"></span><br><span class="line"> 盗梦空间 </span><br><span class="line"></span><br><span class="line"> 忠犬八公的故事</span><br></pre></td></tr></table></figure>

<h3 id="11-20"><a href="#11-20" class="headerlink" title="11-20"></a>11-20</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">星际穿越 </span><br><span class="line"></span><br><span class="line"> 楚门的世界 </span><br><span class="line"></span><br><span class="line"> 海上钢琴师 </span><br><span class="line"></span><br><span class="line"> 三傻大闹宝莱坞 </span><br><span class="line"></span><br><span class="line"> 机器人总动员 </span><br><span class="line"></span><br><span class="line"> 放牛班的春天 </span><br><span class="line"></span><br><span class="line"> 大话西游之大圣娶亲 </span><br><span class="line"></span><br><span class="line"> 疯狂动物城 </span><br><span class="line"></span><br><span class="line"> 无间道 </span><br><span class="line"></span><br><span class="line"> 熔炉</span><br></pre></td></tr></table></figure>

<h3 id="21-30"><a href="#21-30" class="headerlink" title="21-30"></a>21-30</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">教父 </span><br><span class="line"></span><br><span class="line"> 当幸福来敲门 </span><br><span class="line"></span><br><span class="line"> 龙猫 </span><br><span class="line"></span><br><span class="line"> 怦然心动 </span><br><span class="line"></span><br><span class="line"> 控方证人 </span><br><span class="line"></span><br><span class="line"> 触不可及 </span><br><span class="line"></span><br><span class="line"> 蝙蝠侠：黑暗骑士 </span><br><span class="line"></span><br><span class="line"> 末代皇帝 </span><br><span class="line"></span><br><span class="line"> 寻梦环游记 </span><br><span class="line"></span><br><span class="line"> 活着</span><br></pre></td></tr></table></figure>

<h3 id="31-40"><a href="#31-40" class="headerlink" title="31-40"></a>31-40</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">何以为家 </span><br><span class="line"></span><br><span class="line"> 乱世佳人 </span><br><span class="line"></span><br><span class="line"> 指环王 3：王者无敌 </span><br><span class="line"></span><br><span class="line"> 哈利波特与魔法石 </span><br><span class="line"></span><br><span class="line"> 飞屋环游记 </span><br><span class="line"></span><br><span class="line"> 摔跤吧！爸爸 </span><br><span class="line"></span><br><span class="line"> 素媛 </span><br><span class="line"></span><br><span class="line"> 少年派的奇幻漂流 </span><br><span class="line"></span><br><span class="line"> 十二怒汉 </span><br><span class="line"></span><br><span class="line"> 哈尔的移动城堡</span><br></pre></td></tr></table></figure>

<h3 id="41-50"><a href="#41-50" class="headerlink" title="41-50"></a>41-50</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">鬼子来了 </span><br><span class="line"></span><br><span class="line"> 大话西游之月光宝盒 </span><br><span class="line"></span><br><span class="line"> 天空之城 </span><br><span class="line"></span><br><span class="line"> 我不是药神 </span><br><span class="line"></span><br><span class="line"> 罗马假日 </span><br><span class="line"></span><br><span class="line"> 闻香识女人 </span><br><span class="line"></span><br><span class="line"> 辩护人 </span><br><span class="line"></span><br><span class="line"> 天堂电影院 </span><br><span class="line"></span><br><span class="line"> 猫鼠游戏 </span><br><span class="line"></span><br><span class="line"> 大闹天宫</span><br></pre></td></tr></table></figure>

<h3 id="51-60"><a href="#51-60" class="headerlink" title="51-60"></a>51-60</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">搏击俱乐部 </span><br><span class="line"></span><br><span class="line"> 教父 2</span><br><span class="line"></span><br><span class="line">狮子王 </span><br><span class="line"></span><br><span class="line"> 钢琴家 </span><br><span class="line"></span><br><span class="line"> 指环王 2：双塔奇兵 </span><br><span class="line"></span><br><span class="line"> 死亡诗社 </span><br><span class="line"></span><br><span class="line"> 黑客帝国 </span><br><span class="line"></span><br><span class="line"> 指环王 1：魔戒再现 </span><br><span class="line"></span><br><span class="line"> 饮食男女 </span><br><span class="line"></span><br><span class="line"> 让子弹飞</span><br></pre></td></tr></table></figure>

<h3 id="61-70"><a href="#61-70" class="headerlink" title="61-70"></a>61-70</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">美丽心灵 </span><br><span class="line"></span><br><span class="line"> 绿皮书 </span><br><span class="line"></span><br><span class="line"> 窃听风暴 </span><br><span class="line"></span><br><span class="line"> 两杆大烟枪 </span><br><span class="line"></span><br><span class="line"> 海蒂和爷爷 </span><br><span class="line"></span><br><span class="line"> 本杰明巴顿奇事 </span><br><span class="line"></span><br><span class="line"> 飞越疯人院 </span><br><span class="line"></span><br><span class="line"> 看不见的客人 </span><br><span class="line"></span><br><span class="line"> 西西里的美丽传说 </span><br><span class="line"></span><br><span class="line"> 拯救大兵瑞恩</span><br></pre></td></tr></table></figure>

<h3 id="71-80"><a href="#71-80" class="headerlink" title="71-80"></a>71-80</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">穿条纹睡衣的男孩 </span><br><span class="line"></span><br><span class="line"> 小鞋子 </span><br><span class="line"></span><br><span class="line"> 音乐之声 </span><br><span class="line"></span><br><span class="line"> 情书 </span><br><span class="line"></span><br><span class="line"> 海豚湾 </span><br><span class="line"></span><br><span class="line"> 美国往事 </span><br><span class="line"></span><br><span class="line"> 致命魔术 </span><br><span class="line"></span><br><span class="line"> 沉默的羔羊 </span><br><span class="line"></span><br><span class="line"> 禁闭岛 </span><br><span class="line"></span><br><span class="line"> 低俗小说</span><br></pre></td></tr></table></figure>

<h3 id="81-90"><a href="#81-90" class="headerlink" title="81-90"></a>81-90</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">蝴蝶效应 </span><br><span class="line"></span><br><span class="line"> 心灵捕手 </span><br><span class="line"></span><br><span class="line"> 七宗罪 </span><br><span class="line"></span><br><span class="line"> 布达佩斯大饭店 </span><br><span class="line"></span><br><span class="line"> 春光乍泄 </span><br><span class="line"></span><br><span class="line"> 哈利波特与死亡圣器 (下)</span><br><span class="line"></span><br><span class="line"> 阿凡达 </span><br><span class="line"></span><br><span class="line"> 摩登时代 </span><br><span class="line"></span><br><span class="line"> 被嫌弃的松子的一生 </span><br><span class="line"></span><br><span class="line"> 喜剧之王</span><br></pre></td></tr></table></figure>

<h3 id="91-100"><a href="#91-100" class="headerlink" title="91-100"></a>91-100</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">致命 ID</span><br><span class="line"></span><br><span class="line">杀人回忆 </span><br><span class="line"></span><br><span class="line"> 剪刀手爱德华 </span><br><span class="line"></span><br><span class="line"> 加勒比海盗 </span><br><span class="line"></span><br><span class="line"> 勇敢的心 </span><br><span class="line"></span><br><span class="line"> 狩猎 </span><br><span class="line"></span><br><span class="line"> 请以你的名字呼唤我 </span><br><span class="line"></span><br><span class="line"> 天使爱美丽 </span><br><span class="line"></span><br><span class="line"> 断背山 </span><br><span class="line"></span><br><span class="line"> 红辣椒</span><br></pre></td></tr></table></figure>

<h3 id="101-110"><a href="#101-110" class="headerlink" title="101-110"></a>101-110</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="111-120"><a href="#111-120" class="headerlink" title="111-120"></a>111-120</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="121-130"><a href="#121-130" class="headerlink" title="121-130"></a>121-130</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="131-140"><a href="#131-140" class="headerlink" title="131-140"></a>131-140</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="141-150"><a href="#141-150" class="headerlink" title="141-150"></a>141-150</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="151-160"><a href="#151-160" class="headerlink" title="151-160"></a>151-160</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="161-170"><a href="#161-170" class="headerlink" title="161-170"></a>161-170</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="171-180"><a href="#171-180" class="headerlink" title="171-180"></a>171-180</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="181-190"><a href="#181-190" class="headerlink" title="181-190"></a>181-190</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="191-200"><a href="#191-200" class="headerlink" title="191-200"></a>191-200</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="201-210"><a href="#201-210" class="headerlink" title="201-210"></a>201-210</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="211-220"><a href="#211-220" class="headerlink" title="211-220"></a>211-220</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="221-230"><a href="#221-230" class="headerlink" title="221-230"></a>221-230</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="231-240"><a href="#231-240" class="headerlink" title="231-240"></a>231-240</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="241-250"><a href="#241-250" class="headerlink" title="241-250"></a>241-250</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/06/dialy_question_02_java_collection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="cloud">
      <meta itemprop="description" content="Less is more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cloud's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/06/dialy_question_02_java_collection/" class="post-title-link" itemprop="url">「每日一问」Java 集合</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-06 19:58:02" itemprop="dateCreated datePublished" datetime="2020-08-06T19:58:02+08:00">2020-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-17 10:41:53" itemprop="dateModified" datetime="2021-03-17T10:41:53+08:00">2021-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE/" itemprop="url" rel="index"><span itemprop="name">每日一问</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/06/daily_question_01_synchronized_volatile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="cloud">
      <meta itemprop="description" content="Less is more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cloud's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/06/daily_question_01_synchronized_volatile/" class="post-title-link" itemprop="url">「每日一问」聊聊 synchronized, volatile</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-06 19:17:52" itemprop="dateCreated datePublished" datetime="2020-08-06T19:17:52+08:00">2020-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-09 11:15:46" itemprop="dateModified" datetime="2021-04-09T11:15:46+08:00">2021-04-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%97%AE/" itemprop="url" rel="index"><span itemprop="name">每日一问</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>60</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="synchronized- 与 -volatile- 的异同"><a href="#synchronized- 与 -volatile- 的异同" class="headerlink" title="synchronized 与 volatile 的异同"></a>synchronized 与 volatile 的异同 </h3><h3 id="多线程下如何解决线程安全问题"><a href="# 多线程下如何解决线程安全问题" class="headerlink" title="多线程下如何解决线程安全问题"></a> 多线程下如何解决线程安全问题</h3><h3 id="synchronized：类锁和对象锁的区别"><a href="#synchronized：类锁和对象锁的区别" class="headerlink" title="synchronized：类锁和对象锁的区别"></a>synchronized：类锁和对象锁的区别</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/28/okhttp_source_code_analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="cloud">
      <meta itemprop="description" content="Less is more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cloud's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/28/okhttp_source_code_analysis/" class="post-title-link" itemprop="url">OkHttp 源码分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-28 20:58:40" itemprop="dateCreated datePublished" datetime="2020-07-28T20:58:40+08:00">2020-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-03 20:18:35" itemprop="dateModified" datetime="2021-01-03T20:18:35+08:00">2021-01-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="OkHttp 请求流程"><a href="#OkHttp 请求流程" class="headerlink" title="OkHttp 请求流程"></a>OkHttp 请求流程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 OkHttpClient 对象</span></span><br><span class="line">OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient().newBuilder().build();</span><br><span class="line"><span class="comment">// 创建 Request 对象</span></span><br><span class="line">Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">        .url(url)</span><br><span class="line">        .build();</span><br><span class="line"><span class="comment">// 同步发起请求</span></span><br><span class="line">Response execute = okHttpClient.newCall(request).execute();</span><br><span class="line"><span class="comment">// 异步发起请求</span></span><br><span class="line">okHttpClient.newCall(request).enqueue(<span class="keyword">new</span> Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="创建 -OkHttpClient- 对象"><a href="# 创建 -OkHttpClient- 对象" class="headerlink" title="创建 OkHttpClient 对象"></a>创建 OkHttpClient 对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OkHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(<span class="keyword">new</span> Builder());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建造者模式</span></span><br><span class="line">OkHttpClient(Builder builder) &#123;</span><br><span class="line">    <span class="comment">// 自定义拦截器</span></span><br><span class="line">    <span class="comment">// 自定义连接池</span></span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建 -Request- 对象"><a href="# 创建 -Request- 对象" class="headerlink" title="创建 Request 对象"></a>创建 Request 对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建造者模式</span></span><br><span class="line">Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">    .url(url)</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>

<h4 id="同步执行请求"><a href="# 同步执行请求" class="headerlink" title="同步执行请求"></a>同步执行请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Response execute = okHttpClient.newCall(request).execute();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Prepares the &#123;<span class="doctag">@code</span> request&#125; to be executed at some point in the future.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Call <span class="title">newCall</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 实际是通过 RealCall 来执行请求的</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RealCall(<span class="keyword">this</span>, request, <span class="keyword">false</span> <span class="comment">/* for web socket */</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="RealCall-execute"><a href="#RealCall-execute" class="headerlink" title="RealCall#execute()"></a>RealCall#execute()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 每个 Call 只能执行一次</span></span><br><span class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</span><br><span class="line">      executed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    captureCallStackTrace();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 通知 dispatcher 当前请求进入同步请求队列</span></span><br><span class="line">      client.dispatcher().executed(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 通过一系列拦截器请求处理和响应处理得到 Response </span></span><br><span class="line">      Response result = getResponseWithInterceptorChain();</span><br><span class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 通知 dispatcher 当前请求执行结束，移除队列</span></span><br><span class="line">      client.dispatcher().finished(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="Dispatcher-executed"><a href="#Dispatcher-executed" class="headerlink" title="Dispatcher#executed()"></a>Dispatcher#executed()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正在运行的同步请求队列</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;RealCall&gt; runningSyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">executed</span><span class="params">(RealCall call)</span> </span>&#123;</span><br><span class="line">    runningSyncCalls.add(call);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="RealCall-getResponseWithInterceptorChain"><a href="#RealCall-getResponseWithInterceptorChain" class="headerlink" title="RealCall#getResponseWithInterceptorChain()"></a>RealCall#getResponseWithInterceptorChain()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Response <span class="title">getResponseWithInterceptorChain</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Build a full stack of interceptors.</span></span><br><span class="line">    List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 创建 okHttpClient 时设置的 interceptors</span></span><br><span class="line">    interceptors.addAll(client.interceptors());</span><br><span class="line">    <span class="comment">// 负责失败重试以及重定向</span></span><br><span class="line">    interceptors.add(retryAndFollowUpInterceptor);</span><br><span class="line">    <span class="comment">// 请求时负责添加 header，响应时负责移除 header</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> BridgeInterceptor(client.cookieJar()));</span><br><span class="line">    <span class="comment">// 负责写入缓存，读取缓存，更新缓存</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> CacheInterceptor(client.internalCache()));</span><br><span class="line">    <span class="comment">// 负责和服务器建立连接</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> ConnectInterceptor(client));</span><br><span class="line">    <span class="keyword">if</span> (!forWebSocket) &#123;</span><br><span class="line">        <span class="comment">// 创建 okHttpClient 设置的 networkInterceptors</span></span><br><span class="line">      interceptors.addAll(client.networkInterceptors());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 负责向服务器发送请求数据，从服务器读取响应数据</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> CallServerInterceptor(forWebSocket));</span><br><span class="line"></span><br><span class="line">    Interceptor.Chain chain = <span class="keyword">new</span> RealInterceptorChain(</span><br><span class="line">        interceptors, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, originalRequest);</span><br><span class="line">    <span class="comment">// 使用责任链模式开启链式调用</span></span><br><span class="line">    <span class="keyword">return</span> chain.proceed(originalRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="RealInterceptorChain-proceed"><a href="#RealInterceptorChain-proceed" class="headerlink" title="RealInterceptorChain#proceed()"></a>RealInterceptorChain#proceed()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">proceed</span><span class="params">(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec,</span></span></span><br><span class="line"><span class="function"><span class="params">      Connection connection)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the next interceptor in the chain.</span></span><br><span class="line">    <span class="comment">// 实例化下一个拦截器对应的 RealInterceptorChain 对象 </span></span><br><span class="line">    RealInterceptorChain next = <span class="keyword">new</span> RealInterceptorChain(</span><br><span class="line">        interceptors, streamAllocation, httpCodec, connection, index + <span class="number">1</span>, request);</span><br><span class="line">    <span class="comment">// 获取当前拦截器</span></span><br><span class="line">    Interceptor interceptor = interceptors.get(index);</span><br><span class="line">    <span class="comment">// 调用当前拦截器的 intercept() 方法，并传入下一个拦截器的 RealInterceptorChain 对象，最后得到响应</span></span><br><span class="line">    Response response = interceptor.intercept(next);</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="异步执行请求"><a href="# 异步执行请求" class="headerlink" title="异步执行请求"></a>异步执行请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">okHttpClient.newCall(request).enqueue(<span class="keyword">new</span> Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call call, IOException e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="RealCall-enqueue"><a href="#RealCall-enqueue" class="headerlink" title="RealCall#enqueue()"></a>RealCall#enqueue()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Callback responseCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</span><br><span class="line">      executed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    captureCallStackTrace();</span><br><span class="line">    <span class="comment">// 通知 dispatcher 添加请求到异步请求队列</span></span><br><span class="line">    client.dispatcher().enqueue(<span class="keyword">new</span> AsyncCall(responseCallback));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="Dispatcher-enqueue"><a href="#Dispatcher-enqueue" class="headerlink" title="Dispatcher#enqueue()"></a>Dispatcher#enqueue()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 准备中的异步请求队列</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;AsyncCall&gt; readyAsyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line"><span class="comment">// 正在运行的异步请求队列</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;AsyncCall&gt; runningAsyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(AsyncCall call)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果正在运行的异步请求队列长度小于最大请求数，且 call 占用的 host 小于最大 host 数</span></span><br><span class="line">    <span class="comment">// 就把 call 放入 runningAsyncCalls 中，同时使用线程池执行 call</span></span><br><span class="line">    <span class="comment">// 否则将 call 放入 readyAsyncCalls 等待执行</span></span><br><span class="line">    <span class="keyword">if</span> (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</span><br><span class="line">      runningAsyncCalls.add(call);</span><br><span class="line">      executorService().execute(call);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      readyAsyncCalls.add(call);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h5 id="AsyncCall-execute"><a href="#AsyncCall-execute" class="headerlink" title="AsyncCall#execute()"></a>AsyncCall#execute()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">boolean</span> signalledCallback = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 通过一系列拦截器请求处理和响应处理得到 Response </span></span><br><span class="line">        Response response = getResponseWithInterceptorChain();</span><br><span class="line">        <span class="keyword">if</span> (retryAndFollowUpInterceptor.isCanceled()) &#123;</span><br><span class="line">          signalledCallback = <span class="keyword">true</span>;</span><br><span class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          signalledCallback = <span class="keyword">true</span>;</span><br><span class="line">          responseCallback.onResponse(RealCall.<span class="keyword">this</span>, response);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (signalledCallback) &#123;</span><br><span class="line">          <span class="comment">// Do not signal the callback twice!</span></span><br><span class="line">          Platform.get().log(INFO, <span class="string">"Callback failure for"</span> + toLoggableString(), e);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          responseCallback.onFailure(RealCall.<span class="keyword">this</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        client.dispatcher().finished(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最后拦截器的链式调用对 okhttp 做了以下处理：</p>
<ul>
<li>okHttpClient 配置的自定义普通拦截器</li>
<li>RetryAndFollowUpInterceptor(重试，重定向)</li>
<li>BridgeInterceptor(header 处理)</li>
<li>CacheInterceptor(缓存处理)</li>
<li>ConnectInterceptor(服务器连接处理)</li>
<li>okHttpClient 配置的自定义网络拦截器</li>
<li>CallServerInterceptor(向服务器发起请求，读取响应)</li>
</ul>
<h3 id="缓存处理 -CacheInterceptor"><a href="# 缓存处理 -CacheInterceptor" class="headerlink" title="缓存处理 CacheInterceptor"></a>缓存处理 CacheInterceptor</h3><h4 id="CacheInterceptor-intercept"><a href="#CacheInterceptor-intercept" class="headerlink" title="CacheInterceptor#intercept()"></a>CacheInterceptor#intercept()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// okhttp 的缓存接口，具体实现其实是 Cache 类，缓存是通过 DiskLruCache 对象实现的</span></span><br><span class="line"><span class="keyword">final</span> InternalCache cache;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 根据 request 获取 cache 中缓存的 response</span></span><br><span class="line">    Response cacheCandidate = cache != <span class="keyword">null</span></span><br><span class="line">        ? cache.get(chain.request())</span><br><span class="line">        : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// request 判断缓存策略，是否使用网络请求缓存，响应数据缓存或两者都有</span></span><br><span class="line">    CacheStrategy strategy = <span class="keyword">new</span> CacheStrategy.Factory(now, chain.request(), cacheCandidate).get();</span><br><span class="line">    Request networkRequest = strategy.networkRequest;</span><br><span class="line">    Response cacheResponse = strategy.cacheResponse;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cache.trackResponse(strategy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cacheCandidate != <span class="keyword">null</span> &amp;&amp; cacheResponse == <span class="keyword">null</span>) &#123;</span><br><span class="line">      closeQuietly(cacheCandidate.body()); <span class="comment">// The cache candidate wasn't applicable. Close it.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we're forbidden from using the network and the cache is insufficient, fail.</span></span><br><span class="line">    <span class="keyword">if</span> (networkRequest == <span class="keyword">null</span> &amp;&amp; cacheResponse == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Response.Builder()</span><br><span class="line">          .request(chain.request())</span><br><span class="line">          .protocol(Protocol.HTTP_1_1)</span><br><span class="line">          .code(<span class="number">504</span>)</span><br><span class="line">          .message(<span class="string">"Unsatisfiable Request (only-if-cached)"</span>)</span><br><span class="line">          .body(Util.EMPTY_RESPONSE)</span><br><span class="line">          .sentRequestAtMillis(-<span class="number">1L</span>)</span><br><span class="line">          .receivedResponseAtMillis(System.currentTimeMillis())</span><br><span class="line">          .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we don't need the network, we're done.</span></span><br><span class="line">    <span class="comment">// 不执行网络请求，直接返回缓存的响应数据</span></span><br><span class="line">    <span class="keyword">if</span> (networkRequest == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cacheResponse.newBuilder()</span><br><span class="line">          .cacheResponse(stripBody(cacheResponse))</span><br><span class="line">          .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Response networkResponse = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 调用下一个拦截器, 传入缓存的网络请求获取 response</span></span><br><span class="line">      networkResponse = chain.proceed(networkRequest);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// If we're crashing on I/O or otherwise, don't leak the cache body.</span></span><br><span class="line">      <span class="keyword">if</span> (networkResponse == <span class="keyword">null</span> &amp;&amp; cacheCandidate != <span class="keyword">null</span>) &#123;</span><br><span class="line">        closeQuietly(cacheCandidate.body());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we have a cache response too, then we're doing a conditional get.</span></span><br><span class="line">    <span class="comment">// 如果本地已经存在 cacheResponse，同网络获取的 networkResponse 做比较，决定是否更新 cacheResponse</span></span><br><span class="line">    <span class="keyword">if</span> (cacheResponse != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (networkResponse.code() == HTTP_NOT_MODIFIED) &#123;</span><br><span class="line">        Response response = cacheResponse.newBuilder()</span><br><span class="line">            .headers(combine(cacheResponse.headers(), networkResponse.headers()))</span><br><span class="line">            .sentRequestAtMillis(networkResponse.sentRequestAtMillis())</span><br><span class="line">            .receivedResponseAtMillis(networkResponse.receivedResponseAtMillis())</span><br><span class="line">            .cacheResponse(stripBody(cacheResponse))</span><br><span class="line">            .networkResponse(stripBody(networkResponse))</span><br><span class="line">            .build();</span><br><span class="line">        networkResponse.body().close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the cache after combining headers but before stripping the</span></span><br><span class="line">        <span class="comment">// Content-Encoding header (as performed by initContentStream()).</span></span><br><span class="line">        cache.trackConditionalCacheHit();</span><br><span class="line">        cache.update(cacheResponse, response);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        closeQuietly(cacheResponse.body());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Response response = networkResponse.newBuilder()</span><br><span class="line">        .cacheResponse(stripBody(cacheResponse))</span><br><span class="line">        .networkResponse(stripBody(networkResponse))</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (HttpHeaders.hasBody(response)) &#123;</span><br><span class="line">        <span class="comment">// 缓存 之前没有缓存的 response</span></span><br><span class="line">      CacheRequest cacheRequest = maybeCache(response, networkResponse.request(), cache);</span><br><span class="line">      response = cacheWritingResponse(cacheRequest, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="CacheInterceptor-maybeCache"><a href="#CacheInterceptor-maybeCache" class="headerlink" title="CacheInterceptor#maybeCache()"></a>CacheInterceptor#maybeCache()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> CacheRequest <span class="title">maybeCache</span><span class="params">(Response userResponse, Request networkRequest,</span></span></span><br><span class="line"><span class="function"><span class="params">      InternalCache responseCache)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (responseCache == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Should we cache this response for this request?</span></span><br><span class="line">    <span class="keyword">if</span> (!CacheStrategy.isCacheable(userResponse, networkRequest)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (HttpMethod.invalidatesCache(networkRequest.method())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          responseCache.remove(networkRequest);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">          <span class="comment">// The cache cannot be written.</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Offer this request to the cache.</span></span><br><span class="line">    <span class="keyword">return</span> responseCache.put(userResponse);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>缓存拦截器会根据网络请求的信息和缓存响应的信息来判断是否存在缓存可用，如果有可以使用的缓存，那么就返回该缓存给用户，否则就继续使用责任链模式来从服务器中获取响应。当获取到响应的时候，又会把响应缓存到磁盘上。</p>
<h3 id="连接处理 -ConnectInterceptor"><a href="# 连接处理 -ConnectInterceptor" class="headerlink" title="连接处理 ConnectInterceptor"></a>连接处理 ConnectInterceptor</h3><h4 id="连接复用"><a href="# 连接复用" class="headerlink" title="连接复用"></a>连接复用</h4><h5 id="ConnectInterceptor-intercept"><a href="#ConnectInterceptor-intercept" class="headerlink" title="ConnectInterceptor#intercept()"></a>ConnectInterceptor#intercept()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    RealInterceptorChain realChain = (RealInterceptorChain) chain;</span><br><span class="line">    Request request = realChain.request();</span><br><span class="line">    StreamAllocation streamAllocation = realChain.streamAllocation();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We need the network to satisfy this request. Possibly for validating a conditional GET.</span></span><br><span class="line">    <span class="keyword">boolean</span> doExtensiveHealthChecks = !request.method().equals(<span class="string">"GET"</span>);</span><br><span class="line">    <span class="comment">// HttpCodec 负责 HTTP 协议的封装和解析，有两个实现：Http1Codec 和 Http2Codec 分别对应 HTTP/1.1 和 HTTP/2</span></span><br><span class="line">    HttpCodec httpCodec = streamAllocation.newStream(client, doExtensiveHealthChecks);</span><br><span class="line">    RealConnection connection = streamAllocation.connection();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> realChain.proceed(request, streamAllocation, httpCodec, connection);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="StreamAllocation-newStream"><a href="#StreamAllocation-newStream" class="headerlink" title="StreamAllocation#newStream()"></a>StreamAllocation#newStream()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现连接池的复用处理</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpCodec <span class="title">newStream</span><span class="params">(OkHttpClient client, <span class="keyword">boolean</span> doExtensiveHealthChecks)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> connectTimeout = client.connectTimeoutMillis();</span><br><span class="line">    <span class="keyword">int</span> readTimeout = client.readTimeoutMillis();</span><br><span class="line">    <span class="keyword">int</span> writeTimeout = client.writeTimeoutMillis();</span><br><span class="line">    <span class="keyword">boolean</span> connectionRetryEnabled = client.retryOnConnectionFailure();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      RealConnection resultConnection = findHealthyConnection(connectTimeout, readTimeout,</span><br><span class="line">          writeTimeout, connectionRetryEnabled, doExtensiveHealthChecks);</span><br><span class="line">      HttpCodec resultCodec = resultConnection.newCodec(client, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">synchronized</span> (connectionPool) &#123;</span><br><span class="line">        codec = resultCodec;</span><br><span class="line">        <span class="keyword">return</span> resultCodec;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RouteException(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="StreamAllocation-findHealthyConnection"><a href="#StreamAllocation-findHealthyConnection" class="headerlink" title="StreamAllocation#findHealthyConnection()"></a>StreamAllocation#findHealthyConnection()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Finds a connection and returns it if it is healthy. If it is unhealthy the process is repeated</span></span><br><span class="line"><span class="comment">   * until a healthy connection is found.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> RealConnection <span class="title">findHealthyConnection</span><span class="params">(<span class="keyword">int</span> connectTimeout, <span class="keyword">int</span> readTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> writeTimeout, <span class="keyword">boolean</span> connectionRetryEnabled, <span class="keyword">boolean</span> doExtensiveHealthChecks)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 循环查找可用的连接</span></span><br><span class="line">      RealConnection candidate = findConnection(connectTimeout, readTimeout, writeTimeout,</span><br><span class="line">          connectionRetryEnabled);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If this is a brand new connection, we can skip the extensive health checks.</span></span><br><span class="line">      <span class="keyword">synchronized</span> (connectionPool) &#123;</span><br><span class="line">        <span class="keyword">if</span> (candidate.successCount == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> candidate;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Do a (potentially slow) check to confirm that the pooled connection is still good. If it</span></span><br><span class="line">      <span class="comment">// isn't, take it out of the pool and start again.</span></span><br><span class="line">      <span class="keyword">if</span> (!candidate.isHealthy(doExtensiveHealthChecks)) &#123;</span><br><span class="line">        noNewStreams();</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> candidate;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="StreamAllocation-findConnection"><a href="#StreamAllocation-findConnection" class="headerlink" title="StreamAllocation#findConnection()"></a>StreamAllocation#findConnection()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns a connection to host a new stream. This prefers the existing connection if it exists,</span></span><br><span class="line"><span class="comment">   * then the pool, finally building a new connection.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> RealConnection <span class="title">findConnection</span><span class="params">(<span class="keyword">int</span> connectTimeout, <span class="keyword">int</span> readTimeout, <span class="keyword">int</span> writeTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> connectionRetryEnabled)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Route selectedRoute;</span><br><span class="line">    <span class="keyword">synchronized</span> (connectionPool) &#123;</span><br><span class="line">      <span class="keyword">if</span> (released) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"released"</span>);</span><br><span class="line">      <span class="keyword">if</span> (codec != <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"codec != null"</span>);</span><br><span class="line">      <span class="keyword">if</span> (canceled) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Attempt to use an already-allocated connection.</span></span><br><span class="line">        <span class="comment">// 尝试使用已分配的连接，如果连接可以创建新的流，就直接返回</span></span><br><span class="line">      RealConnection allocatedConnection = <span class="keyword">this</span>.connection;</span><br><span class="line">      <span class="keyword">if</span> (allocatedConnection != <span class="keyword">null</span> &amp;&amp; !allocatedConnection.noNewStreams) &#123;</span><br><span class="line">        <span class="keyword">return</span> allocatedConnection;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Attempt to get a connection from the pool.</span></span><br><span class="line">        <span class="comment">// 尝试从连接池中获取一个连接，如果连接不为空，就直接返回</span></span><br><span class="line">      Internal.instance.get(connectionPool, address, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      selectedRoute = route;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we need a route, make one. This is a blocking operation.</span></span><br><span class="line">    <span class="keyword">if</span> (selectedRoute == <span class="keyword">null</span>) &#123;</span><br><span class="line">      selectedRoute = routeSelector.next();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a connection and assign it to this allocation immediately. This makes it possible for</span></span><br><span class="line">    <span class="comment">// an asynchronous cancel() to interrupt the handshake we're about to do.</span></span><br><span class="line">    RealConnection result;</span><br><span class="line">    <span class="keyword">synchronized</span> (connectionPool) &#123;</span><br><span class="line">      route = selectedRoute;</span><br><span class="line">      refusedStreamCount = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 创建一个新的连接，并立即分配</span></span><br><span class="line">      result = <span class="keyword">new</span> RealConnection(connectionPool, selectedRoute);</span><br><span class="line">      acquire(result);</span><br><span class="line">      <span class="keyword">if</span> (canceled) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do TCP + TLS handshakes. This is a blocking operation.</span></span><br><span class="line">    <span class="comment">// 进行 TCP 和 TLS 握手</span></span><br><span class="line">    result.connect(connectTimeout, readTimeout, writeTimeout, connectionRetryEnabled);</span><br><span class="line">    routeDatabase().connected(result.route());</span><br><span class="line"></span><br><span class="line">    Socket socket = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (connectionPool) &#123;</span><br><span class="line">      <span class="comment">// Pool the connection.</span></span><br><span class="line">        <span class="comment">// 将该连接放入连接池中</span></span><br><span class="line">      Internal.instance.put(connectionPool, result);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If another multiplexed connection to the same address was created concurrently, then</span></span><br><span class="line">      <span class="comment">// release this connection and acquire that one.</span></span><br><span class="line">        <span class="comment">// 如果同时创建了另一个到同一地址的多路复用连接，则释放这个连接并获取那个连接。</span></span><br><span class="line">      <span class="keyword">if</span> (result.isMultiplexed()) &#123;</span><br><span class="line">        socket = Internal.instance.deduplicate(connectionPool, address, <span class="keyword">this</span>);</span><br><span class="line">        result = connection;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    closeQuietly(socket);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>以上源码分析可知：</p>
<p>StreamAllocation 对象，它相当于一个管理类，维护了服务器连接、并发流和请求之间的关系，该类还会初始化一个 Socket 连接对象，获取输入 / 输出流对象。</p>
<ul>
<li>判断当前的连接是否可以使用：流是否关闭，且已经被限制创建新的流</li>
<li>如果当前 de 连接无法使用，就从连接池中获取一个连接</li>
<li>如果连接池中没有可用的连接，就创建一个新的连接，进行握手，然后放入连接池中</li>
</ul>
<p>连接复用的好处：省去了进行 TCP 和 TLS 握手的一个过程（因为建立连接需要消耗一些时间，连接复用后可以提升网络访问的效率）</p>
<p>那么，ConnectionPool 是如何实现连接管理的？</p>
<h4 id="连接管理"><a href="# 连接管理" class="headerlink" title="连接管理"></a>连接管理 </h4><p>OkHttp 的缓存管理分成两个步骤，一边当我们创建了一个新的连接的时候，我们要把它放进连接池里面；另一边，我们还要来对连接池进行清理。<br> 在 ConnectionPool 中，当我们向连接池中缓存一个连接的时候，只要调用双端队列的 add() 方法，将其加入到双端队列即可，而清理连接缓存的操作则交给线程池来定时执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 双端队列的设计意义是什么？</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;RealConnection&gt; connections = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">put</span><span class="params">(RealConnection connection)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> (Thread.holdsLock(<span class="keyword">this</span>));</span><br><span class="line">    <span class="keyword">if</span> (!cleanupRunning) &#123;</span><br><span class="line">      cleanupRunning = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// 使用线程池执行清理任务 </span></span><br><span class="line">      executor.execute(cleanupRunnable);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将新建的连接插入到双端队列中</span></span><br><span class="line">    connections.add(connection);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable cleanupRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 调用 cleanup() 方法清理无效的连接</span></span><br><span class="line">        <span class="keyword">long</span> waitNanos = cleanup(System.nanoTime());</span><br><span class="line">        <span class="keyword">if</span> (waitNanos == -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (waitNanos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">long</span> waitMillis = waitNanos / <span class="number">1000000L</span>;</span><br><span class="line">          waitNanos -= (waitMillis * <span class="number">1000000L</span>);</span><br><span class="line">          <span class="keyword">synchronized</span> (ConnectionPool.<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              ConnectionPool.<span class="keyword">this</span>.wait(waitMillis, (<span class="keyword">int</span>) waitNanos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxIdleConnections; <span class="comment">// 最大闲置连接数，默认是 5 个，可以通过传参配置</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> keepAliveDurationNs; <span class="comment">// 最长连接存活时间，默认是 5 分钟，可以通过传参配置</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">cleanup</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> inUseConnectionCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> idleConnectionCount = <span class="number">0</span>;</span><br><span class="line">    RealConnection longestIdleConnection = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">long</span> longestIdleDurationNs = Long.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find either a connection to evict, or the time that the next eviction is due.</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 遍历连接池</span></span><br><span class="line">      <span class="keyword">for</span> (Iterator&lt;RealConnection&gt; i = connections.iterator(); i.hasNext();) &#123;</span><br><span class="line">        RealConnection connection = i.next();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the connection is in use, keep searching.</span></span><br><span class="line">        <span class="comment">// 如果当前连接正在使用，继续遍历</span></span><br><span class="line">        <span class="keyword">if</span> (pruneAndGetAllocationCount(connection, now) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          inUseConnectionCount++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        idleConnectionCount++;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the connection is ready to be evicted, we're done.</span></span><br><span class="line">        <span class="comment">// 如果找到了一个可以被清理的连接，对比最长闲置时间，寻找闲置最久的连接进行释放</span></span><br><span class="line">        <span class="keyword">long</span> idleDurationNs = now - connection.idleAtNanos;</span><br><span class="line">        <span class="keyword">if</span> (idleDurationNs &gt; longestIdleDurationNs) &#123;</span><br><span class="line">          longestIdleDurationNs = idleDurationNs;</span><br><span class="line">          longestIdleConnection = connection;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">      <span class="keyword">if</span> (longestIdleDurationNs &gt;= <span class="keyword">this</span>.keepAliveDurationNs</span><br><span class="line">          || idleConnectionCount &gt; <span class="keyword">this</span>.maxIdleConnections) &#123;</span><br><span class="line">        <span class="comment">// We've found a connection to evict. Remove it from the list, then close it below (outside</span></span><br><span class="line">        <span class="comment">// of the synchronized block).</span></span><br><span class="line">        <span class="comment">// 该连接的时长超出了最长闲置时间或闲置的连接数量超出了最大闲置数量，直接移除</span></span><br><span class="line">        connections.remove(longestIdleConnection);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idleConnectionCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// A connection will be ready to evict soon.</span></span><br><span class="line">        <span class="comment">// 闲置的连接数量大于 0，等待一段时间</span></span><br><span class="line">        <span class="keyword">return</span> keepAliveDurationNs - longestIdleDurationNs;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inUseConnectionCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// All connections are in use. It'll be at least the keep alive duration'til we run again.</span></span><br><span class="line">        <span class="comment">// 所有连接都在使用中，等待最长闲置时间</span></span><br><span class="line">        <span class="keyword">return</span> keepAliveDurationNs;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No connections, idle or in use.</span></span><br><span class="line">        <span class="comment">// 没有连接</span></span><br><span class="line">        cleanupRunning = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    closeQuietly(longestIdleConnection.socket());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cleanup again immediately.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>首先会对缓存中的连接进行遍历，以寻找一个闲置时间最长的连接，然后根据该连接的闲置时长和最大允许的连接数量等参数来决定是否应该清理该连接。<br>同时注意上面的方法的返回值是一个时间，如果闲置时间最长的连接仍然需要一段时间才能被清理的时候，会返回这段时间的时间差，然后会在这段时间之后再次对连接池进行清理。</p>
<h3 id="总结"><a href="# 总结" class="headerlink" title="总结"></a>总结 </h3><h3 id="参考"><a href="# 参考" class="headerlink" title="参考"></a> 参考</h3><ul>
<li>OkHttp-3.6.0-source</li>
<li><a href="https://jsonchao.github.io/2018/12/01/Android 主流三方库源码分析（一、深入理解 OKHttp 源码）/" target="_blank" rel="noopener">https://jsonchao.github.io/2018/12/01/Android 主流三方库源码分析（一、深入理解 OKHttp 源码）/</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/27/%E7%A2%8E%E7%A2%8E%E5%BF%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="cloud">
      <meta itemprop="description" content="Less is more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cloud's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/27/%E7%A2%8E%E7%A2%8E%E5%BF%B5/" class="post-title-link" itemprop="url">碎碎念</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-27 20:42:46" itemprop="dateCreated datePublished" datetime="2020-07-27T20:42:46+08:00">2020-07-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-17 10:41:53" itemprop="dateModified" datetime="2021-03-17T10:41:53+08:00">2021-03-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Other/" itemprop="url" rel="index"><span itemprop="name">Other</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>233</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>“周末的下午，刷刷朋友圈，别人创业升职、结婚生子，而自己在只有一个人的出租屋里无聊地睡过去。醒来时已是深夜，夜风从忘了关的窗户里灌进来，除了开着保温的电水壶里水犹自温热外，感觉不到和这个世界的一丝联系。”</p>
<p> 成功的秘诀不仅仅在于自身的努力和奋斗，而是要让已经成功的人为自己提供帮助，让即将成功的人和自己并肩作战，让不会成功的人为自己服务。</p>
<p> 在油管上看到一条社畜精品发言：“入职以后，公司给每位员工发了一台电脑，表面上看是每个人拥有了一台电脑，其实是给每个电脑配了一个人。”</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/22/%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="cloud">
      <meta itemprop="description" content="Less is more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cloud's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/22/%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">编译优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-22 18:14:46" itemprop="dateCreated datePublished" datetime="2020-07-22T18:14:46+08:00">2020-07-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-03 20:18:35" itemprop="dateModified" datetime="2021-01-03T20:18:35+08:00">2021-01-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="历史优化方案"><a href="# 历史优化方案" class="headerlink" title="历史优化方案"></a>历史优化方案 </h3><h4 id="maven- 代理优化 -sync- 时间"><a href="#maven- 代理优化 -sync- 时间" class="headerlink" title="maven 代理优化 sync 时间"></a>maven 代理优化 sync 时间</h4><h5 id="背景"><a href="# 背景" class="headerlink" title="背景"></a> 背景 </h5><p>gradle 工程中会在 repositories 中 添加一些 maven 仓库地址，作为组件依赖获取的查找路径，<br> 是按照 maven 仓库配置的顺序依次查找的，如果某个组件存在于最后一个仓库中，那前面的多个仓库会依次发起网络请求查找，<br>并且在请求失败后才查找下一个，如果大多数组件存在位置比较靠后，就会造成累加的查找时间过长。</p>
<h5 id="优化方案"><a href="# 优化方案" class="headerlink" title="优化方案"></a>优化方案</h5><ol>
<li><p>搭建公司 maven 私服，设置代理仓库，为 google，jcenter，mavenCentral 等仓库配置代理，<br>在代理仓库创建好后，在 Negative Cache 配置项中关闭 cache 开关：<br>如果查找时没有找到依赖库时会缓存失败结果，一段时间内不会重新去 maven 仓库查找对应依赖库，<br>即使 maven 仓库中已经有该版本的依赖库，查找时仍然返回失败的结果。</p>
</li>
<li><p>建立仓库组，统一管理所有仓库，依赖查找时只需要在这个仓库组内查找，降低遍历仓库时的网络请求耗时</p>
</li>
</ol>
<h4 id="模块 -aar- 化"><a href="# 模块 -aar- 化" class="headerlink" title="模块 aar 化"></a>模块 aar 化 </h4><h5 id="背景 -1"><a href="# 背景 -1" class="headerlink" title="背景"></a> 背景 </h5><p> 项目如果使用了组件化和模块化开发时，会产生大量的子模块，如果这些子模块都 inclue 在项目中，在 clean build 的过程中，<br>就需要重新编译所有的子模块代码。在团队开发时，开发人员往往只负责少数几个模块，无需改动大多数模块的代码，<br>所以别的模块的配置和编译时间就成了负担。</p>
<h5 id="优化方案 -1"><a href="# 优化方案 -1" class="headerlink" title="优化方案"></a>优化方案 </h5><p> 将所有模块打包成 aar，在项目中默认通过 maven 依赖这些编译好的组件，<br>而在改动模块代码时，通过配置项将该模块的依赖形式调整为源码依赖，做到编译时只编译改动的模块。<br>弊端是需要开发人员自觉将模块打包成 aar，并在该模块修改完成后，改回依赖形式。</p>
<p>更新方案：</p>
<ol>
<li>开发过程中，master 分支上的代码一定是全部依赖 aar 的，除了 app 模块 没有任何子模块是源码引入的</li>
<li>需要修改对应模块时，通过修改 local.properties 里的 INCLUDES 参数指定源码引入的模块</li>
<li>开发完成后，push 代码到远端，触发代码合并流程后，在 ci 预编译过程与合并目标分支做对比，检测修改的模块，<br> 将这些模块按照依赖关系打包成新的 aar 替换原来的旧版本，这就保证了每次代码合并后，master 分支上的依赖全部是 aar 依赖</li>
</ol>
<p>Tips：<br>    ci / cb ：Continuous Integration 持续集成, Continuous Delivery 持续交付, 都是 GitLab 提供的服务</p>
<h5 id="收益"><a href="# 收益" class="headerlink" title="收益"></a>收益 </h5><p> 将源码依赖改为 aar 依赖后，clean build 耗时从 7，8 分钟降低至 4，5 分钟，接近 50%</p>
<h4 id="增量 -java-kotlin- 编译"><a href="# 增量 -java-kotlin- 编译" class="headerlink" title="增量 java/kotlin 编译"></a>增量 java/kotlin 编译 </h4><h5 id="背景 -2"><a href="# 背景 -2" class="headerlink" title="背景"></a> 背景 </h5><p> 在非 clean build 的情况下，更改 java/kotlin 代码虽然会做增量编译， 但是 gradle 会根据依赖关系，<br>为了保证编译的正确性，可能选择重新编译代码，这就导致了增量编译的失效。</p>
<h5 id="优化方案 -2"><a href="# 优化方案 -2" class="headerlink" title="优化方案"></a>优化方案 </h5><p> 所以为了快速编译展示结果，可以在编译正确性和编译速度上做一个折中：</p>
<ol>
<li>禁用原始的 javac/kotlinCompile 等 task, 手动实现代码增量修改判断，只编译修改的代码。</li>
<li>动态禁用 kapt 相关的 task，降低 kapt，kaptGenerateStub 等 task 的耗时。</li>
</ol>
<h5 id="小结"><a href="# 小结" class="headerlink" title="小结"></a>小结 </h5><p> 上述三个方案虽然在涉及常量修改，方法签名变更等方面存在一些并不常见的问题（如常量内联），<br>但极大的提升了编译效率，利大于弊。</p>
<p>Tips：<br>kapt：Kotlin Annotation Processing Tool（Kotlin 注释处理工具）<br>常量内联：静态编译器 javac 在编译时会内联一些静态最终变量，并把值直接放入常量池中。</p>
<h3 id="编译耗时恶化"><a href="# 编译耗时恶化" class="headerlink" title="编译耗时恶化"></a>编译耗时恶化</h3><ol>
<li>kotlin 大量使用，kapt 新增了很多注解处理逻辑。</li>
<li>引入 java8 支持，语法糖增加了编译耗时</li>
<li>大量的字节码插桩需求，添加了很多 transform，大幅度提升了增量编译耗时</li>
</ol>
<h3 id="近期优化方案"><a href="# 近期优化方案" class="headerlink" title="近期优化方案"></a>近期优化方案 </h3><h4 id="app- 壳模块 -kapt- 优化"><a href="#app- 壳模块 -kapt- 优化" class="headerlink" title="app 壳模块 kapt 优化"></a>app 壳模块 kapt 优化</h4><h5 id="背景 -3"><a href="# 背景 -3" class="headerlink" title="背景"></a> 背景 </h5><p> 经历过模块化，组件化重构后，app 模块只是一个空壳。<br>但从 build profile（执行 gradle 命令时添加 –profile 参数会在编译完成后输出相关 task 耗时的统计文件）的数据来看：<br>只有 2 个类的 app 模块 kapt (annotationProcessor 注解处理) 却耗时近 1 分钟。</p>
<p>通过分析这 2 个类的代码发现，使用了 6 种 kapt 库，但实际生效的只是其中 ServiceImpl 一个注解（内部的 SerivceManager 框架，<br>用于指定生产 Proxy 类，对模块之间代码调用进行解耦），最终编译得到的是 2 个固定的 Proxy 类。</p>
<h5 id="优化方案 -3"><a href="# 优化方案 -3" class="headerlink" title="优化方案"></a>优化方案 </h5><p> 把固定生成的 Proxy 类从 generate 目录下移动到 src 目录下，同时禁止 app 模块中 kapt 相关的 task, 并添加管控方案，<br>检测到不合理的情况马上抛出异常，防止其他人添加新增的 kapt 库。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">project.afterEvaluate&#123;</span><br><span class="line">    android.applicationVariants.each &#123; variant -&gt;</span><br><span class="line">        project.tasks.getByName(<span class="string">"kapt$&#123;variant.name.capitalize()&#125;Kotlin"</span>).enabled = <span class="keyword">false</span></span><br><span class="line">        project.tasks.getByName(<span class="string">"kaptGenerateStubs$&#123;variant.name.capitalize()&#125;Kotlin"</span>).enabled = <span class="keyword">false</span></span><br><span class="line">    &#125;   </span><br><span class="line">    def set = <span class="keyword">new</span> HashSet&lt;String&gt;()</span><br><span class="line">    android.applicationVariants.each &#123; variant -&gt;</span><br><span class="line">        configurations.getByName(<span class="string">"kapt"</span>).dependencies.each &#123; depend -&gt;</span><br><span class="line">            set.add(<span class="string">"$&#123;depend.getGroup()&#125;:$&#123;depend.getName()&#125;:$&#123;depend.getVersion()&#125;"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!set.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadException((<span class="string">"已禁止 app 模块所有 kapt, 请勿添加新的 kapt"</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="收益 -1"><a href="# 收益 -1" class="headerlink" title="收益"></a>收益</h5><ol>
<li>mac clean build 减少了 40s 耗时</li>
<li>ci clean build 减少了 20s 耗时</li>
</ol>
<h4 id="kapt- 隔离优化"><a href="#kapt- 隔离优化" class="headerlink" title="kapt 隔离优化"></a>kapt 隔离优化 </h4><h5 id="背景 -4"><a href="# 背景 -4" class="headerlink" title="背景"></a> 背景 </h5><p> 项目中为了方便，定义了 library.gradle, 作用是定义项目中通用的 Android dsl (domain-specific language) 和共有的基础依赖，<br>因此所有的子模块都 apply 了这个文件，但是后续的开发中，这个文件被不同的业务添加新的 kapt 注解处理库，在全源码编译时，所有子模块 <br> 都得执行 library 模块中定义的全部 kapt, 即使该模块不需要用到注解处理。</p>
<p>问题的根源在于：相比纯 java 模块的注解处理，kotlin 代码需要先通过 kaptGenerateStub 将 kt 文件转换为 java，让 apt 处理程序能够统一的面向 java 做注解扫描和处理。<br>但实际上很多模块没有任何 kapt 处理操作，所以就白白做了一次 kt 到 java 的转化操作，这就导致引入的模块越多，累计的无效耗时越多。</p>
<h5 id="优化方案 -4"><a href="# 优化方案 -4" class="headerlink" title="优化方案"></a>优化方案 </h5><p> 需要扫描所有子模块，区分哪些模块用到了 kapt，而没有用到的就禁用掉 kapt 相关 task：</p>
<ol>
<li>获取 kapt configuration 的所有依赖，可以得到 kapt 依赖库的 jar 包，利用 asm 获取所有 annotation</li>
<li>遍历所有 subproject 的 sourceset 下所有 java 文件，kt 文件，解析 import 信息，看是否有前面解析到的 annotation</li>
<li>package task 完成后遍历所有的 subproject 中 generate/apt, generate/kapt 目录下生成的 java 文件</li>
</ol>
<p>获取到不实际生成 kapt 内容的模块后，开始拆分这些模块，从 apply library.gradle 改为没有 kapt 相关的 apply library-api.gradle, 该文件除了禁用 kapt 外，其他与 library 保持一致。<br>为了避免后续新添了注解却没有任何输出，对 library-api 模块依赖的注解做隔离优化，即把这些注解库全部 exclude 掉，在尝试使用注解时会因为获取不到引用，发现依赖的注解库被移除的问题。<br>另外当编译出现错误时，gradle 插件对注解符号进行解析，如果发现是被隔离优化的注解库，就提示将 apply library-api.gradle 替换为 apply library.gradle，减少优化方案对业务层的侵入。</p>
<h5 id="收益 -2"><a href="# 收益 -2" class="headerlink" title="收益"></a>收益</h5><ol>
<li>mac 全源码编译 减少了 58s 耗时</li>
<li>ci 机器由于 cpu 核数更多, task 并发性能更好，减少了 10s 耗时</li>
</ol>
<h4 id="transform- 优化"><a href="#transform- 优化" class="headerlink" title="transform 优化"></a>transform 优化 </h4><h5 id="背景 -5"><a href="# 背景 -5" class="headerlink" title="背景"></a> 背景 </h5><h5 id="优化方案 -5"><a href="# 优化方案 -5" class="headerlink" title="优化方案"></a> 优化方案 </h5><h5 id="收益 -3"><a href="# 收益 -3" class="headerlink" title="收益"></a> 收益 </h5><p> 参考:<br><a href="https://juejin.im/post/5f144b2f6fb9a07e6f7b7fce" target="_blank" rel="noopener">https://juejin.im/post/5f144b2f6fb9a07e6f7b7fce</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="cloud"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">cloud</p>
  <div class="site-description" itemprop="description">Less is more.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">76</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">57</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/cloudchenc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cloudchenc" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cloudchenc@gmail.com" title="E-Mail → mailto:cloudchenc@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cloud</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">369k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">5:36</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
