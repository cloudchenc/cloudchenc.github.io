---
title: Android进程间通信机制Binder
tags: 
    - Binder
    - IPC
categories: Android
---

### 设计目的

进程间通信解决了什么痛点？

在操作系统中，进程与进程之间的内存是不共享（都运行与用户空间，彼此独立）的，进程之间无法直接访问对方的数据，因而进程间的数据交互需要采用特殊的方式（需要内核空间支持）进行，也就是进程间通信。

Binder机制解决了什么痛点？

Linux现有的进程通信机制：

1. 管道：在创建时分配一个page大小的内存，缓存区大小比较有限
2. 消息队列：信息复制两次，额外的CPU消耗；不适合频繁或信息量大的通信
3. 共享内存：无须复制，共享缓冲区直接付附加到进程虚拟地址空间，速度快；但进程间的同步问题操作系统无法实现，必须各进程利用同步工具解决
4. Socket：作为更通用的接口，传输效率低，主要用于不同机器或跨网络的通信
5. 信号量：常作为一种锁机制，防止某进程正在访问共享资源时，其他进程也访问该资源。因此，主要作为进程间以及同一进程内不同线程之间的同步手段
6. 信号：不适用于信息交换，更适用于进程中断控制，比如非法内存访问，杀死某个进程等

- 高性能：从数据拷贝次数来看Binder只需要进行一次内存拷贝，而管道、消息队列、Socket都需要两次，共享内存不需要拷贝，Binder的性能仅次于共享内存
- 稳定性：虽然共享内存的性能优于Binder，但是共享内存需要处理并发同步问题，控制负责，容易出现死锁和资源竞争，稳定性较差。而Binder基于C/S架构，客户端与服务端彼此独立，稳定性较好
- 安全性：Android为每个应用分配了UID，用来作为鉴别进程的重要标志（Android内部也依赖整个UID进行权限管理，包括6.0以前的固定权限和6.0以后的动态权限），
传统IPC只能由用户在数据包里填入UID/PID，这个标记完全是在用户空间控制的，没有放在内核空间，因此有被恶意篡改的可能，因此Binder的安全性更高

### 基本原理

用户空间的两个进程是无法直接进行数据交互的，它们之间的通信需要内核空间提供支持，而Binder并不是Linux内核的一部分，它是通过一种Linux的动态内核可加载模块这一机制来实现的。

什么是动态内核可加载模块（Loadable Kernel Module）？
> 一种可以单独编译，但是不能独立运行的模块，它在运行时会被链接到内核作为内核的一部分运行

Android系统就是通过动态添加一个内核模块在内核空间运行，然后以这个内核模块为桥梁实现的进程间通信。这个内核模块就是Binder驱动（Binder Drivers）

那Binder是如何实现数据交互的呢，它只需要进行一次数据拷贝，那它是如何实现的呢，这就涉及到Linux的另一个概念 内存映射

内存映射基于系统函数mmap()实现，mmap()通常是基于物理介质的文件系统实现的，因为用户空间是不能和物理设备直接打交道的，例如需要把磁盘的数据读取到进程中的用户控件，需要经历两次拷贝（磁盘到内核空间，内核空间到用户空间）。
mmap()就是这种情况下使用，通过物理介质建立与用户空间的映射，减少数据的拷贝次数，用内存读写代替IO读写，提高文件读取效率。

但Binder并不存在物理介质，Binder使用mmap主要是为了在内核空间创建数据接收的缓存空间。

1. Binder驱动在内核空间创建一个数据接收缓冲区和一个内核缓冲区（用来接收数据发送进程拷贝的数据）。建立内核缓冲区与数据接收缓冲区，数据接收缓冲区与数据接收进程的内存映射关系
2. 数据发送进程调用copy_from_user()方法将数据拷贝到内核缓冲区，由于内核缓冲区与数据接收缓冲区，数据接收缓冲区与数据接收进程存在映射关系，这样就相当于把数据发送到了数据接收进程，实现了进程间通信

### 架构分析

#### 从内核空间与用户空间角度看

![binder_framework](https://tvax2.sinaimg.cn/large/d7f9b0f4gy1gld1qsdwtej20nh0i2q4u.jpg)

- 框架层：框架是一个中间层，它对接了底层驱动的实现，封装了复杂的内部逻辑，并提供对外使用的内部接口，它分为C++和Java两个部分，为了实现功能的复用，中间用JNI衔接
    - Binder Java
    - Binder JNI
    - Binder C++
- 驱动层：驱动层位于Linux内核中，它提供了最底层的数据传递、对象标示、线程管理、调度过程控制等功能

#### 从客户端和服务端的角度看

![binder_cs](https://tvax4.sinaimg.cn/large/d7f9b0f4gy1gld2arzgboj20k10ebq41.jpg)

- Client：网络通信中的客户端
- Server：网络通信中的服务端
- ServiceManager：网络通信中的DNS服务器，DNS服务器是域名解析成IP地址，而ServiceManager是将Binder名字转换成Client中对该Binder的引用，也就是说让Client通过名字找到它需要的那个Server。
相对应的Server也会把自己通过addService注册到ServiceManager内
- Binder Driver：网络通信中的路由器，是整个进程通信的核心，负责进程间Binder通信的建立，Binder在进程之间的传递，Binder引用计数管理，数据包在进程之间的传递和交互等

### 参考资料

https://www.yuque.com/beesx/beesandroid/xomd5v#HcSmG


