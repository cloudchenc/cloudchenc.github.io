---
title: 编译优化
date: 2020-07-22 18:14:46
tags:
    - 性能优化
categories: Android
---

#### 1. maven 代理优化 sync 时间

##### 背景

gradle 工程中会在 repositories 中 添加一些 maven 仓库地址，作为组件依赖获取的查找路径，
是按照 maven 仓库配置的顺序依次查找的，如果某个组件存在于最后一个仓库中，那前面的多个仓库会依次发起网络请求查找，
并且在请求失败后才查找下一个，如果大多数组件存在位置比较靠后，就会造成累加的查找时间过长。

##### 优化方案

1. 搭建公司 maven 私服，设置代理仓库，为google，jcenter，mavenCentral等仓库配置代理，
在代理仓库创建好后，在 Negative Cache 配置项中关闭 cache 开关：
如果查找时没有找到依赖库时会缓存失败结果，一段时间内不会重新去 maven 仓库查找对应依赖库，
即使 maven 仓库中已经有该版本的依赖库，查找时仍然返回失败的结果。

2. 建立仓库组，统一管理所有仓库，依赖查找时只需要在这个仓库组内查找，降低遍历仓库时的网络请求耗时

#### 2. 模块 aar 化

##### 背景

项目如果使用了组件化和模块化开发时，会产生大量的子模块，如果这些子模块都 inclue 在项目中，在 clean build 的过程中，
就需要重新编译所有的子模块代码。在团队开发时，开发人员往往只负责少数几个模块，无需改动大多数模块的代码，
所以别的模块的配置和编译时间就成了负担。

##### 优化方案

将所有模块打包成 aar，在项目中默认通过 maven 依赖这些编译好的组件，
而在改动模块代码时，通过配置项将该模块的依赖形式调整为源码依赖，做到编译时只编译改动的模块。
弊端是需要开发人员自觉将模块打包成 aar，并在该模块修改完成后，改回依赖形式。

更新方案：
1. 开发过程中，master 分支上的代码一定是全部依赖 aar的，除了 app 模块 没有任何子模块是源码引入的
2. 需要修改对应模块时，通过修改 local.properties 里的 INCLUDES 参数指定源码引入的模块
3. 开发完成后，push 代码到远端，触发代码合并流程后，在 ci 预编译过程与合并目标分支做对比，检测修改的模块，
    将这些模块按照依赖关系打包成新的 aar 替换原来的旧版本，这就保证了每次代码合并后，master 分支上的依赖全部是 aar依赖

##### 收益

参考:  
https://juejin.im/post/5f144b2f6fb9a07e6f7b7fce